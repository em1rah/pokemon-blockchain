<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Shop & My Pokémon</title>

  <!-- Ethers.js v5.7 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ──────────────────────────────────────
       ALL YOUR ORIGINAL CSS (unchanged)
       ────────────────────────────────────── */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      min-height:100vh;
      color:white;
      background:#000000;
      font-family:'Inter',sans-serif;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POKÉMON</text></svg>') repeat;
      opacity:0.3;z-index:0;pointer-events:none;
    }
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;margin:0}
    .menu{padding:12px}
    .menu a{display:block;color:#ffcb05;text-decoration:none;font-weight:700;padding:10px 12px;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin-bottom:10px;transition:.2s}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(4px)}
    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{background:#ffeb3b;color:#1a2a6c;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .free-balance{background:#4caf50;color:#fff;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .connect-btn,.logout-btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .connect-btn{background:#4caf50;color:#fff;}
    .connect-btn:hover{background:#45a049;transform:translateY(-1px);}
    .logout-btn{background:#f44336;color:#fff;display:none;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{max-width:1200px;margin:0 auto;padding:2rem 1rem;margin-left:240px}
    .title{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.3rem;margin:2rem 0 0.5rem;text-shadow:1px 1px 0 #000;}
    .subtitle{color:#aaa;font-size:0.95rem;margin-bottom:1rem;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;margin-top:1rem;}

    /* .card{
      background:linear-gradient(135deg, #1a1a2e 0%, #1621a1a2e 50%, #0f3460 100%);
      border:5px solid #ffcb05;
      border-radius:24px;
      padding:0;
      text-align:left;
      transition:all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
      box-shadow:0 10px 30px rgba(0,0,0,0.7), inset 0 0 0 2px rgba(255,203,5,0.2), inset 0 2px 4px rgba(255,255,255,0.1);
      position:relative;
      overflow:hidden;
      aspect-ratio:2.5/3.5;
      display:flex;
      flex-direction:column;
      cursor:pointer;
      perspective:1000px;
    } */
    .card::before{
      content:'';
      position:absolute;
      top:-50%;left:-50%;width:200%;height:200%;
      background:linear-gradient(45deg, transparent 30%, rgba(255,203,5,0.1) 40%, rgba(74,144,226,0.2) 50%, rgba(255,203,5,0.1) 60%, transparent 70%);
      animation:shimmer 3s infinite;
      opacity:0;
      transition:opacity 0.5s;
      z-index:1;
      pointer-events:none;
    }
    .card:hover::before{opacity:1;}
    @keyframes shimmer{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}

    .card-header{
      background:linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 100%);
      padding:40px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:3px solid rgba(255,203,5,0.4);
      position:relative;
      z-index:2;
      backdrop-filter:blur(4px);
      min-height:60px;
    }
    .card-name{
      color:#ffcb05;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      text-shadow:0 0 10px rgba(255,203,5,0.8), 0 2px 4px rgba(0,0,0,0.8);
      font-family:'Press Start 2P',cursive;
      font-size:0.65rem;
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      margin-right:8px;
    }
    .card-hp{
      display:flex;
      align-items:center;
      gap:4px;
      color:#fff;
      font-weight:700;
      font-size:0.8rem;
      flex-shrink:0;
    }
    .hp-value{
      background:linear-gradient(135deg, #e91e63 0%, #c2185b 50%, #ad1457 100%);
      padding:4px 10px;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.3);
      box-shadow:0 3px 6px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.2);
      font-size:0.85rem;
      white-space:nowrap;
    }

    .rarity-badge{
      position:absolute;
      top:8px;
      left:8px;
      background:linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color:#1a1a2e;
      padding:5px 8px;
      border-radius:16px;
      font-size:0.6rem;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.5px;
      z-index:10;
      border:2px solid rgba(255,255,255,0.5);
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
      display:flex;
      align-items:center;
      gap:3px;
      max-width:calc(100% - 100px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rarity-star{font-size:0.75rem;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));flex-shrink:0;}

    .card-type{
      position:absolute;
      top:8px;
      right:8px;
      background:linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
      padding:6px 10px;
      border-radius:20px;
      border:2px solid #ffcb05;
      font-size:0.65rem;
      font-weight:700;
      color:#ffcb05;
      text-transform:uppercase;
      letter-spacing:1px;
      z-index:10;
      backdrop-filter:blur(6px);
      box-shadow:0 4px 8px rgba(0,0,0,0.5);
      max-width:80px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .card-image-area{
      flex:1;
      min-height:160px;
      max-height:200px;
      background:linear-gradient(to bottom, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.3) 100%), radial-gradient(circle at 50% 30%, rgba(255,203,5,0.15) 0%, transparent 60%);
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      z-index:2;
      border-top:3px solid rgba(255,203,5,0.3);
      border-bottom:3px solid rgba(255,203,5,0.3);
      margin:4px 8px;
      border-radius:12px;
    }
    .card-image-area::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      border:2px solid rgba(255,203,5,0.2);
      border-radius:12px;
      pointer-events:none;
    }
    .card-image-area::after{
      content:'';
      position:absolute;
      top:8px;left:8px;right:8px;bottom:8px;
      background:radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.3) 100%);
      border-radius:8px;
      pointer-events:none;
    }
    .card img{
      width:100%;
      height:100%;
      max-width:160px;
      max-height:160px;
      object-fit:contain;
      image-rendering:auto;
      filter:drop-shadow(0 6px 12px rgba(0,0,0,0.6));
      position:relative;
      z-index:1;
      transition:transform 0.4s;
    }
    .card:hover img{transform:scale(1.15) translateY(-5px);}

    .card-info{
      background:linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 100%);
      padding:12px 14px 50px;
      border-top:3px solid rgba(255,203,5,0.4);
      position:relative;
      z-index:2;
      backdrop-filter:blur(4px);
      flex-shrink:0;
    }

    .attack-section{
      margin:8px 0;
      padding:8px;
      background:rgba(0,0,0,0.4);
      border-radius:6px;
      border-left:3px solid #ffcb05;
    }
    .attack-name{
      color:#ffcb05;
      font-weight:700;
      font-size:0.75rem;
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .attack-cost{
      display:flex;
      gap:3px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }
    .energy-symbol{
      width:18px;
      height:18px;
      border-radius:50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:0.65rem;
      font-weight:700;
      border:1.5px solid rgba(255,255,255,0.3);
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
      flex-shrink:0;
    }
    .attack-damage{
      color:#fff;
      font-weight:700;
      font-size:0.85rem;
      margin-left:auto;
      white-space:nowrap;
    }
    .card-id{
      color:rgba(255,255,255,0.6);
      font-size:0.65rem;
      font-weight:600;
      margin-bottom:6px;
      font-family:monospace;
      text-transform:uppercase;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .card-price{
      color:#ffcb05;
      font-weight:700;
      font-size:0.95rem;
      margin-bottom:8px;
      text-shadow:0 2px 4px rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      gap:6px;
      overflow:hidden;
    }
    .card-price span:last-child{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .price-icon{font-size:1.2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));flex-shrink:0;line-height:1;}

    .set-symbol{
      position:absolute;
      bottom:10px;
      right:10px;
      width:28px;
      height:28px;
      background:rgba(0,0,0,0.7);
      border:2px solid #ffcb05;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      color:#ffcb05;
      font-weight:700;
      z-index:3;
      flex-shrink:0;
    }

    .card button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s;
      font-size:0.95rem;
      text-transform:uppercase;
      letter-spacing:1.5px;
      margin-top:10px;
      box-shadow:0 6px 12px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.2);
      position:relative;
      z-index:2;
      overflow:hidden;
    }
    .card button::before{
      content:'';
      position:absolute;
      top:50%;left:50%;width:0;height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%,-50%);
      transition:width 0.5s, height 0.5s;
    }
    .card button:hover::before{width:300px;height:300px;}
    .card button.coin-btn{background:linear-gradient(135deg, #ff9800 0%, #f57c00 50%, #e65100 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button.token-btn{background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 50%, #6a1b9a 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button.sell-btn{background:linear-gradient(135deg, #f44336 0%, #d32f2f 50%, #b71c1c 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button:disabled{background:rgba(85,85,85,0.4);color:#aaa;cursor:not-allowed;opacity:0.6;border-color:rgba(255,255,255,0.1);}
    .card button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,0.6), inset 0 1px 3px rgba(255,255,255,0.3);}
    .card button:active:not(:disabled){transform:translateY(-1px);}

    .owned-tag{
      position:absolute;
      top:8px;
      left:8px;
      background:linear-gradient(135deg, #4caf50 0%, #388e3c 50%, #2e7d32 100%);
      color:#fff;
      padding:6px 10px;
      border-radius:20px;
      font-size:0.65rem;
      font-weight:700;
      z-index:11;
      border:2px solid rgba(255,255,255,0.4);
      box-shadow:0 4px 12px rgba(76,175,80,0.5), inset 0 1px 2px rgba(255,255,255,0.3);
      text-transform:uppercase;
      letter-spacing:1px;
      display:flex;
      align-items:center;
      gap:4px;
      max-width:calc(100% - 100px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .starter-card{border-color:#4caf50 !important;background:linear-gradient(135deg, #1a3e1a 0%, #1e4a1e 50%, #162816 100%);}
    .starter-card::before{background:linear-gradient(45deg, transparent 30%, rgba(76,175,80,0.2) 40%, rgba(139,195,74,0.25) 50%, rgba(76,175,80,0.2) 60%, transparent 70%);}
    .starter-card button{background:linear-gradient(135deg, #8bc34a 0%, #689f38 50%, #558b2f 100%);}
    .starter-card button:disabled{background:rgba(102,187,106,0.4);color:#ccc;}

    .rare-card{border-color:#9c27b0 !important;background:linear-gradient(135deg, #2d1b3d 0%, #1a0f26 50%, #0d0513 100%);}
    .rare-card::before{background:linear-gradient(45deg, transparent 30%, rgba(156,39,176,0.2) 40%, rgba(123,31,162,0.3) 50%, rgba(156,39,176,0.2) 60%, transparent 70%);}
    .rare-card .rarity-badge{background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:#fff;}

    .weakness-resistance{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      margin-bottom:6px;
      font-size:0.65rem;
      color:rgba(255,255,255,0.7);
    }
    .weakness-resistance span{
      display:flex;
      align-items:center;
      gap:3px;
      flex:1;
      min-width:calc(50% - 4px);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    @media(max-width:1200px){.grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}}
    @media(max-width:768px){.grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;}.card{aspect-ratio:2.5/3.5;}.card img{max-width:140px;max-height:140px;}.card-header{padding:38px 10px 8px;}.card-name{font-size:0.6rem;}.hp-value{font-size:0.75rem;padding:3px 8px;}.card-type{font-size:0.6rem;padding:5px 8px;max-width:70px;}.rarity-badge{font-size:0.55rem;padding:4px 6px;}.attack-section{padding:6px;}.attack-name{font-size:0.7rem;}.card-info{padding:10px 12px 45px;}.set-symbol{width:24px;height:24px;font-size:0.9rem;bottom:8px;right:8px;}}
    @media(max-width:480px){.grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.8rem;}.card-header{min-height:55px;padding:35px 8px 6px;}.card-image-area{min-height:140px;max-height:160px;padding:10px;}.card img{max-width:120px;max-height:120px;}.weakness-resistance{font-size:0.6rem;gap:6px;}.weakness-resistance span{min-width:100%;}.card button{font-size:0.85rem;padding:12px;}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><h1>Pokémon Shop</h1></div>
    <div class="menu">
      <a href="home.html">Home</a>
      <a href="arena.html">Arena</a>
      <a href="shop.html">Shop</a>
      <a href="settings.html">Settings</a>
    </div>
    <div class="status">
      <span class="coins" id="coinDisplay">500 Coins</span>
      <span class="free-balance" id="freeDisplay">0 TOKEN</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <div class="title">Starters</div>
    <div class="subtitle">Claim up to three free starters</div>
    <div class="grid" id="starterGrid"></div>

    <div class="title">Common Shop</div>
    <div class="subtitle">Spend coins to expand your team</div>
    <div class="grid" id="shopGrid"></div>

    <div class="title">Rare Shop</div>
    <div class="subtitle">Buy rare Pokémon using tokens</div>
    <div class="grid" id="rareGrid"></div>

    <div class="title">My Pokémon <button id="refreshOwned" style="font-size:0.7rem;margin-left:1rem;padding:4px 8px;border-radius:8px;background:#ffcb05;color:#000;border:none;cursor:pointer;">Refresh</button></div>
    <div class="grid" id="myGrid"></div>
  </div>

  <script>
    // ──────────────────────────────────────
    // REPLACE THESE AFTER DEPLOYMENT
    // ──────────────────────────────────────
    const TOKEN_ADDRESS = '0x164C13a62271f406A8911f2DcE76Dc5aC2F19b23';
    const NFT_ADDRESS   = '0x7876e4c587A4B7625008e2Adb96ad1cc66026DC5';
    // ──────────────────────────────────────

    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function allowance(address,address) view returns (uint256)',
      'function approve(address,uint256) external'
    ];

    const NFT_ABI = [
      'function mintWithToken(address to,uint256 pokeId,string name,uint256 amount) external returns (uint256)',
      'function sell(uint256 pokeId) external',
      'function balanceOf(address) view returns (uint256)',
      'function tokenOfOwnerByIndex(address owner,uint256 index) view returns (uint256)'
    ];

    let provider, signer, token, nft, userAddress;
    let coins = parseInt(localStorage.getItem('coins') || '500');
    let ownedLocal = JSON.parse(localStorage.getItem('owned') || '[]');
    let claimedStarters = JSON.parse(localStorage.getItem('claimedStarters') || '[]');

    const coinDisplay = document.getElementById('coinDisplay');
    const freeDisplay = document.getElementById('freeDisplay');
    const walletDisplay = document.getElementById('walletDisplay');

    // ──────────────────────────────────────
    // GLOBAL ERROR DISPLAY (nice toast)
    // ──────────────────────────────────────
    function showError(msg) {
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.cssText = `
        position:fixed; top:20px; right:20px; z-index:9999;
        background:#c62828; color:#fff; padding:12px 20px;
        border-radius:8px; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.5);
        animation:fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    // tiny fade animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
      @keyframes fadeOut { from {opacity:1; transform:translateY(0);} to {opacity:0; transform:translateY(-10px);} }
    `;
    document.head.appendChild(style);

    function updateCoinDisplay() {
      coinDisplay.textContent = `${coins} Coins`;
      localStorage.setItem('coins', coins);
    }

    async function updateTokenBalance() {
      if (!token || !userAddress) return;
      try {
        const bal = await token.balanceOf(userAddress);
        const fmt = ethers.utils.formatUnits(bal, 18).split('.')[0];
        freeDisplay.textContent = `${fmt} TOKEN`;
      } catch (e) { console.error(e); }
    }

    document.getElementById('connectBtn').onclick = async () => {
      if (!window.ethereum) return showError('Install MetaMask!');
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa36a7' }] });
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
        nft = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);

        walletDisplay.textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';

        await updateTokenBalance();
        await syncOwnedFromChain();
        loadAll();
        alert('Connected to Sepolia');
      } catch (e) {
        showError('Connect failed: ' + (e?.message || e));
      }
    };

    document.getElementById('logoutBtn').onclick = () => location.reload();

    async function syncOwnedFromChain() {
      if (!nft || !userAddress) return;
      const ownedOnChain = [];
      try {
        const bal = await nft.balanceOf(userAddress);
        for (let i = 0; i < bal; i++) {
          const id = await nft.tokenOfOwnerByIndex(userAddress, i);
          const pokeId = Number(id);
          ownedOnChain.push({ id: pokeId, name: getNameFromId(pokeId) });
        }
      } catch (e) {
        console.error('sync error', e);
        showError('Failed to sync owned Pokémon');
      }

      const merged = [...ownedOnChain];
      for (const loc of ownedLocal) {
        if (!merged.some(o => o.id === loc.id)) merged.push(loc);
      }
      ownedLocal = merged;
      localStorage.setItem('owned', JSON.stringify(ownedLocal));
      loadOwned();
    }

    document.getElementById('refreshOwned').onclick = syncOwnedFromChain;

    function getNameFromId(id) {
      const map = {1:'Bulbasaur',4:'Charmander',7:'Squirtle',25:'Pikachu',144:'Articuno',145:'Zapdos',146:'Moltres',150:'Mewtwo',151:'Mew',243:'Raikou',244:'Entei',245:'Suicune',249:'Lugia',250:'Ho-Oh',380:'Latias',381:'Latios',384:'Rayquaza',382:'Kyogre',483:'Dialga',484:'Palkia',487:'Giratina',643:'Reshiram',644:'Zekrom',646:'Kyurem',716:'Xerneas',717:'Yveltal',789:'Cosmog',791:'Solgaleo',792:'Lunala',800:'Necrozma',888:'Zacian',889:'Zamazenta',893:'Zarude',898:'Calyrex'};
      return map[id] || `Poke #${id}`;
    }

    function img(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }

    const starters = [{id:1,name:'Bulbasaur'},{id:4,name:'Charmander'},{id:7,name:'Squirtle'}];
    const common = [
      {id:25,name:'Pikachu',price:150},{id:133,name:'Eevee',price:200},{id:52,name:'Meowth',price:120},{id:19,name:'Rattata',price:50},
      {id:16,name:'Pidgey',price:60},{id:10,name:'Caterpie',price:40},{id:69,name:'Bellsprout',price:80},{id:43,name:'Oddish',price:90},
      {id:23,name:'Ekans',price:110},{id:27,name:'Sandshrew',price:100},{id:37,name:'Vulpix',price:180},{id:63,name:'Abra',price:220},
      {id:92,name:'Gastly',price:190},{id:129,name:'Magikarp',price:30},{id:74,name:'Geodude',price:85},{id:95,name:'Onix',price:300},
      {id:66,name:'Machop',price:140},{id:50,name:'Diglett',price:70},{id:54,name:'Psyduck',price:130},{id:79,name:'Slowpoke',price:160},
      {id:104,name:'Cubone',price:210},{id:111,name:'Rhyhorn',price:280},{id:116,name:'Horsea',price:170},{id:118,name:'Goldeen',price:90},
      {id:120,name:'Staryu',price:200},{id:147,name:'Dratini',price:500},{id:172,name:'Pichu',price:250},{id:175,name:'Togepi',price:300},
      {id:152,name:'Chikorita',price:180},{id:155,name:'Cyndaquil',price:180}
    ];
    const rare = [
      {id:144,name:'Articuno',price:2500},{id:145,name:'Zapdos',price:2500},{id:146,name:'Moltres',price:2500},{id:150,name:'Mewtwo',price:5000},
      {id:151,name:'Mew',price:8000},{id:243,name:'Raikou',price:3500},{id:244,name:'Entei',price:3500},{id:245,name:'Suicune',price:3500},
      {id:249,name:'Lugia',price:6000},{id:250,name:'Ho-Oh',price:6000},{id:380,name:'Latias',price:4500},{id:381,name:'Latios',price:4500},
      {id:384,name:'Rayquaza',price:7000},{id:483,name:'Dialga',price:6500},{id:484,name:'Palkia',price:6500},{id:487,name:'Giratina',price:6800},
      {id:643,name:'Reshiram',price:6200},{id:644,name:'Zekrom',price:6200},{id:646,name:'Kyurem',price:6000},{id:716,name:'Xerneas',price:5800},
      {id:717,name:'Yveltal',price:5800},{id:789,name:'Cosmog',price:3000},{id:791,name:'Solgaleo',price:7000},{id:792,name:'Lunala',price:7000},
      {id:800,name:'Necrozma',price:7500},{id:888,name:'Zacian',price:6800},{id:889,name:'Zamazenta',price:6800},{id:893,name:'Zarude',price:5500},
      {id:898,name:'Calyrex',price:6000},{id:382,name:'Kyogre',price:5800}
    ];

    function getPokemonType(id) {
      const map = {1:'Grass',4:'Fire',7:'Water',25:'Electric',144:'Ice',145:'Electric',146:'Fire',150:'Psychic',151:'Psychic',92:'Ghost',63:'Psychic',95:'Rock',74:'Rock',50:'Ground',54:'Water',104:'Ground',111:'Ground',116:'Water',118:'Water',120:'Water',147:'Dragon',172:'Electric',175:'Fairy',152:'Grass',155:'Fire',243:'Electric',244:'Fire',245:'Water',249:'Psychic',250:'Fire',380:'Dragon',381:'Dragon',384:'Dragon',382:'Water',483:'Steel',484:'Water',487:'Ghost',643:'Dragon',644:'Dragon',646:'Dragon',716:'Fairy',717:'Dark',789:'Psychic',791:'Psychic',792:'Ghost',800:'Psychic',888:'Fairy',889:'Fighting',893:'Dark',898:'Psychic'};
      return map[id] || 'Normal';
    }

    function getPokemonHP(id) { return Math.floor(50 + (id % 50) + (id > 100 ? 50 : 0) + (id > 150 ? 30 : 0)); }

    function getRarity(type, price) {
      if (type === 'starter') return { level: 'COMMON', stars: 'star' };
      if (type === 'token') {
        if (price >= 7000) return { level: 'LEGENDARY', stars: 'starstarstarstarstar' };
        if (price >= 5000) return { level: 'ULTRA RARE', stars: 'starstarstarstar' };
        if (price >= 3000) return { level: 'RARE', stars: 'starstarstar' };
        return { level: 'UNCOMMON', stars: 'starstar' };
      }
      if (price >= 400) return { level: 'UNCOMMON', stars: 'starstar' };
      return { level: 'COMMON', stars: 'star' };
    }

    function getAttack(type) {
      const attacks = {
        'Fire': { name: 'Flame Thrower', cost: ['fire'], damage: 80 },
        'Water': { name: 'Hydro Pump', cost: ['water'], damage: 90 },
        'Grass': { name: 'Solar Beam', cost: ['leaf'], damage: 70 },
        'Electric': { name: 'Thunder', cost: ['lightning'], damage: 100 },
        'Psychic': { name: 'Psybeam', cost: ['crystal'], damage: 85 },
        'Ice': { name: 'Blizzard', cost: ['snowflake'], damage: 80 },
        'Ghost': { name: 'Shadow Ball', cost: ['ghost'], damage: 75 },
        'Dragon': { name: 'Dragon Pulse', cost: ['dragon'], damage: 120 },
        'Fairy': { name: 'Moonblast', cost: ['sparkles'], damage: 90 },
        'Rock': { name: 'Stone Edge', cost: ['rock'], damage: 85 },
        'Ground': { name: 'Earthquake', cost: ['earth'], damage: 100 },
        'Dark': { name: 'Dark Pulse', cost: ['dark'], damage: 80 },
        'Fighting': { name: 'Close Combat', cost: ['fist'], damage: 90 },
        'Normal': { name: 'Tackle', cost: [], damage: 50 }
      };
      return attacks[type] || attacks['Normal'];
    }

    function getPurchaseDetails(id) {
      const s = starters.find(x=>x.id===id); if(s) return {price:0,currency:'free'};
      const c = common.find(x=>x.id===id); if(c) return {price:c.price,currency:'coins'};
      const r = rare.find(x=>x.id===id); if(r) return {price:r.price,currency:'tokens'};
      return null;
    }

    function createCard(poke, type) {
      const has = ownedLocal.some(o => o.id === poke.id);
      const card = document.createElement('div');
      const cardClass = type === 'starter' ? 'starter-card' : type === 'token' ? 'rare-card' : '';
      card.className = `card ${cardClass} ${has ? 'has-owned' : ''}`;

      const priceText = type === 'token' ? `${poke.price} TOKEN` : `${poke.price} Coins`;
      const btnText = has ? 'Owned' : (type === 'starter' ? 'Claim' : type === 'token' ? 'Buy with TOKEN' : 'Buy');
      const btnClass = type === 'token' ? 'token-btn' : 'coin-btn';
      const pokemonType = getPokemonType(poke.id);
      const hp = getPokemonHP(poke.id);
      const priceIcon = type === 'token' ? 'diamond' : 'coin';
      const rarity = getRarity(type, poke.price);
      const attack = getAttack(pokemonType);

      card.innerHTML = `
        ${has ? '<div class="owned-tag">Owned</div>' : ''}
        <div class="rarity-badge"><span class="rarity-star">${rarity.stars}</span><span>${rarity.level}</span></div>
        <div class="card-header"><div class="card-name">${poke.name}</div><div class="card-hp"><span>HP</span><span class="hp-value">${hp}</span></div></div>
        <div class="card-type">${pokemonType}</div>
        <div class="card-image-area"><img src="${img(poke.id)}" alt="${poke.name}" loading="lazy"></div>
        <div class="card-info">
          <div class="attack-section">
            <div class="attack-cost">${attack.cost.map(e=>`<span class="energy-symbol">${e}</span>`).join('')}</div>
            <div class="attack-name">${attack.name}</div>
            <div style="display:flex;justify-content:space-between;"><span style="color:#aaa;font-size:.75rem;">Deals</span><span class="attack-damage">${attack.damage}</span></div>
          </div>
          <div class="card-id">#${String(poke.id).padStart(3,'0')} | ${poke.name}</div>
          <div class="weakness-resistance">
            <span>Weakness: ${pokemonType==='Fire'?'water':pokemonType==='Water'?'lightning':'sword'}</span>
            <span>Resistance: ${pokemonType==='Electric'?'leaf':pokemonType==='Grass'?'fire':'shield'}</span>
          </div>
          <div class="card-price"><span class="price-icon">${priceIcon}</span><span>${priceText}</span></div>
          <button class="${btnClass}" ${has?'disabled':''}
            onclick="${type==='starter'?`claimStarter(${poke.id},'${poke.name}')`:
                      type==='token'?`buyRare(${poke.id},'${poke.name}',${poke.price})`:
                      `buyCommon(${poke.id},'${poke.name}',${poke.price})`}">
            ${btnText}
          </button>
          <div class="set-symbol">PK</div>
        </div>
      `;
      return card;
    }

    function loadStarters() {
      const grid = document.getElementById('starterGrid'); grid.innerHTML = '';
      starters.forEach(p => {
        if (claimedStarters.includes(p.id) || claimedStarters.length >= 3) {
          const card = createCard(p, 'starter');
          card.querySelector('button').disabled = true;
          card.querySelector('button').textContent = 'Claimed';
          grid.appendChild(card);
        } else {
          grid.appendChild(createCard(p, 'starter'));
        }
      });
    }

    function loadCommon() {
      const grid = document.getElementById('shopGrid'); grid.innerHTML = '';
      common.forEach(p => grid.appendChild(createCard(p, 'common')));
    }

    function loadRare() {
      const grid = document.getElementById('rareGrid'); grid.innerHTML = '';
      rare.forEach(p => grid.appendChild(createCard(p, 'token')));
    }

    function loadOwned() {
      const grid = document.getElementById('myGrid'); grid.innerHTML = '';
      if (!ownedLocal.length) {
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa;padding:2rem;">No Pokémon yet. Start collecting!</p>';
        return;
      }
      ownedLocal.forEach(p => {
        const pokemonType = getPokemonType(p.id);
        const hp = getPokemonHP(p.id);
        const attack = getAttack(pokemonType);
        const card = document.createElement('div');
        card.className = 'card has-owned';
        card.innerHTML = `
          <div class="owned-tag">Owned</div>
          <div class="rarity-badge"><span class="rarity-star">star</span><span>COLLECTION</span></div>
          <div class="card-header"><div class="card-name">${p.name}</div><div class="card-hp"><span>HP</span><span class="hp-value">${hp}</span></div></div>
          <div class="card-type">${pokemonType}</div>
          <div class="card-image-area"><img src="${img(p.id)}" alt="${p.name}" loading="lazy"></div>
          <div class="card-info">
            <div class="attack-section">
              <div class="attack-cost">${attack.cost.map(e=>`<span class="energy-symbol">${e}</span>`).join('')}</div>
              <div class="attack-name">${attack.name}</div>
              <div style="display:flex;justify-content:space-between;"><span style="color:#aaa;font-size:.75rem;">Deals</span><span class="attack-damage">${attack.damage}</span></div>
            </div>
            <div class="card-id">#${String(p.id).padStart(3,'0')} | ${p.name}</div>
            <button class="sell-btn" onclick="sellPokemon(${p.id},'${p.name}')">Sell</button>
            <div class="set-symbol">PK</div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function loadAll() { loadStarters(); loadCommon(); loadRare(); loadOwned(); }

    window.claimStarter = (id, name) => {
      if (claimedStarters.length >= 3) return showError('Max 3 starters allowed');
      if (claimedStarters.includes(id)) return showError('Already claimed');
      claimedStarters.push(id);
      ownedLocal.push({id, name});
      localStorage.setItem('claimedStarters', JSON.stringify(claimedStarters));
      localStorage.setItem('owned', JSON.stringify(ownedLocal));
      loadAll();
    };

    window.buyCommon = (id, name, price) => {
      if (coins < price) return showError('Not enough coins');
      if (ownedLocal.some(o=>o.id===id)) return showError('Already owned');
      coins -= price;
      ownedLocal.push({id, name});
      updateCoinDisplay();
      localStorage.setItem('owned', JSON.stringify(ownedLocal));
      loadAll();
    };

    window.buyRare = async (id, name, price) => {
      if (!userAddress) return showError('Connect wallet first');
      if (ownedLocal.some(o=>o.id===id)) return showError('Already owned');
      try {
        const amount = ethers.utils.parseUnits(price.toString(), 18);
        const bal = await token.balanceOf(userAddress);
        if (bal.lt(amount)) return showError('Not enough TOKEN');

        const allow = await token.allowance(userAddress, NFT_ADDRESS);
        if (allow.lt(amount)) {
          const tx = await token.approve(NFT_ADDRESS, ethers.constants.MaxUint256);
          await tx.wait();
          alert('Approved token spending');
        }

        const tx = await nft.mintWithToken(userAddress, id, name, amount);
        await tx.wait();

        await syncOwnedFromChain();
        await updateTokenBalance();
        alert(`Minted ${name}!`);
      } catch (e) {
        const msg = e?.error?.message || e?.message || e?.reason || e;
        showError('Buy failed: ' + msg);
      }
    };

    window.sellPokemon = async (id, name) => {
      if (!confirm(`Sell ${name}?`)) return;
      const details = getPurchaseDetails(id);
      if (!details) return showError('Unknown Pokémon');

      if (details.currency !== 'tokens') {
        const sellPrice = details.currency === 'free' ? 100 : Math.floor(details.price * 0.5);
        coins += sellPrice;
        ownedLocal = ownedLocal.filter(o=>o.id!==id);
        if (details.currency === 'free') claimedStarters = claimedStarters.filter(c=>c!==id);
        localStorage.setItem('owned', JSON.stringify(ownedLocal));
        localStorage.setItem('claimedStarters', JSON.stringify(claimedStarters));
        updateCoinDisplay();
        loadAll();
        alert(`Sold ${name} for ${sellPrice} Coins`);
        return;
      }

      try {
        const tx = await nft.sell(id);
        await tx.wait();
        await syncOwnedFromChain();
        await updateTokenBalance();
        alert(`Sold ${name} – 50% refunded`);
      } catch (e) {
        const msg = e?.error?.message || e?.message || e?.reason || e;
        showError('Sell failed: ' + msg);
      }
    };

    updateCoinDisplay();
    loadAll();

    window.addEventListener('storage', e => {
      if (['coins','owned','claimedStarters'].includes(e.key)) {
        coins = parseInt(localStorage.getItem('coins')||'500');
        ownedLocal = JSON.parse(localStorage.getItem('owned')||'[]');
        claimedStarters = JSON.parse(localStorage.getItem('claimedStarters')||'[]');
        updateCoinDisplay();
        loadAll();
      }
    });
  </script>
</body>
</html>
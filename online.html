<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Arena - 1v1 Battle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden}
   
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;margin:0}
    .menu{padding:12px}
    .menu a{display:block;color:#ffcb05;text-decoration:none;font-weight:700;padding:10px 12px;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin-bottom:10px;transition:.2s}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(4px)}
    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{color:#efe339;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .free-balance{color:#9362ed;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .connect-btn,.logout-btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .connect-btn{background:#4caf50;color:#fff;}
    .connect-btn:hover{background:#45a049;transform:translateY(-1px);}
    .logout-btn{background:#f44336;color:#fff;display:none;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{margin-left:240px;padding:2rem;text-align:center}
    .title{font-family:'Press Start 2P';color:#ffcb05;font-size:2.5rem;margin:1rem 0;text-shadow:0 0 25px #ffcb05}
    .room-setup{max-width:500px;margin:3rem auto;padding:2.5rem;background:rgba(255,203,5,0.1);border:3px solid #ffcb05;border-radius:16px}
    input{padding:14px;font-size:1.2rem;width:100%;margin:15px 0;border:2px solid #ffcb05;background:rgba(0,0,0,0.6);color:#fff;border-radius:12px}
    button{padding:16px 32px;font-size:1.3rem;margin:10px;border:none;border-radius:12px;background:linear-gradient(135deg,#ff9800,#e65100);color:#fff;font-weight:700;cursor:pointer}
    .team-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1.5rem;max-width:900px;margin:2rem auto}
    .team-card{border:4px solid rgba(255,203,5,0.4);border-radius:16px;padding:15px;cursor:pointer;background:rgba(0,0,0,0.2);transition:.2s}
    .team-card:hover{border-color:#ffcb05;transform:scale(1.05)}
    .team-card.selected{border-color:#4caf50;background:rgba(76,175,80,0.4);box-shadow:0 0 30px rgba(76,175,80,0.6)}
    .team-card img{width:100%;height:150px;object-fit:contain}
    .battle-area{position:relative;width:1000px;height:560px;margin:40px auto;background:url('/images/Screenshot 2025-11-20 210130.png') center/cover no-repeat;border-radius:20px;overflow:hidden;box-shadow:0 0 30px rgba(255,203,5,0.8)}
    .player-base{bottom:80px;left:80px;width:300px;text-align:center}
    .pokemon-back img{width:280px;height:280px;image-rendering:pixelated;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.6))}
    .opponent-base{position:absolute;top:60px;right:80px;width:300px;text-align:center}
    .pokemon-front img{width:240px;height:240px;image-rendering:pixelated;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.6))}
    .hp-box{font-family:'Press Start 2P';font-size:0.95rem}
    .hp-bar-small{height:22px;background:#222;border:3px solid #fff;border-radius:10px;overflow:hidden;margin:8px 0}
    .hp-fill-small{height:100%;background:linear-gradient(90deg,#92d04b,#4caf50);transition:width 1s ease}
    .hp-fill-small.warning{background:#ff9800}
    .hp-fill-small.danger{background:#ff4444}
    #playerActions{position:absolute;bottom:60px;right:80px;z-index:10}
    .attack-btn{padding:18px 40px;font-family:'Press Start 2P';font-size:22px;background:linear-gradient(135deg,#ff1744,#c62828);color:white;border:3px solid #ffcb05;border-radius:30px;cursor:pointer;box-shadow:0 15px 40px rgba(255,23,68,0.8);text-transform:uppercase;letter-spacing:5px;transition:all 0.3s}
    .attack-btn:hover{transform:translateY(-10px) scale(1.05);box-shadow:0 30px 60px rgba(255,23,68,1)}
    .log{background:rgba(0,0,0,0.9);border:4px solid #ffcb05;border-radius:16px;padding:1.5rem;height:180px;overflow-y:auto;margin:20px auto;max-width:1000px;font-size:1.1rem;line-height:1.9;font-family:'Courier New',monospace;color:#ffcb05}
    .overlay,.confirm-modal{display:none;position:fixed;z-index:9999}
    .overlay{inset:0;background:rgba(0,0,0,0.8);z-index:9998}
    .confirm-modal{top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:6px solid #ffcb05;border-radius:20px;padding:2rem;max-width:500px;width:90%;text-align:center}

    /* ATTACK ANIMATIONS */
    .attack-container{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:16}
    .beam-line{position:absolute;height:10px;background:linear-gradient(90deg,transparent,#fff,#ffeb3b,transparent);box-shadow:0 0 40px #ffeb3b,0 0 80px #fff;opacity:0}
    .fire-explosion{position:absolute;width:160px;height:160px;background:radial-gradient(circle,#ff4500 10%,#ff8c00 40%,transparent 70%);border-radius:50%;opacity:0}
    .lightning-bolt{position:absolute;width:12px;background:#ffeb3b;box-shadow:0 0 30px #ffeb3b,0 0 60px #fff;transform-origin:top center;opacity:0}
    .water-wave{position:absolute;height:30px;background:linear-gradient(90deg,#00b7eb,#1e90ff);border-radius:50%;opacity:0;filter:blur(4px)}
    .leaf-blade{position:absolute;width:80px;height:30px;background:linear-gradient(45deg,#00ff00,#32cd32);clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%);opacity:0}
    .normal-tackle{position:absolute;width:100px;height:100px;background:radial-gradient(circle,#ffffff 20%,transparent 70%);border-radius:50%;opacity:0}
    .hit-flash{position:absolute;width:220px;height:220px;background:radial-gradient(circle,white 20%,transparent 60%);border-radius:50%;opacity:0}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-10px)}20%,40%,60%,80%{transform:translateX(10px)}}
    .shake{animation:shake 0.5s}
    @keyframes dodgeJump{0%{transform:translateY(0)}50%{transform:translateY(-100px)}100%{transform:translateY(0)}}
    .dodge-jump{animation:dodgeJump 0.8s ease-in-out}

    /* FAINT ANIMATION */
    .fainted{animation:faintFall 2.5s forwards !important;filter:grayscale(100%) brightness(0.6) !important}
    .faint-eyes{position:absolute;width:60px;height:30px;background:white;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-80%);clip-path:polygon(0 0,100% 0,100% 50%,0 50%);opacity:0;animation:faintEyes 2.5s forwards;pointer-events:none;z-index:17}
    .faint-swirl{position:absolute;width:300px;height:300px;background:url('https://i.imgur.com/8p3s4Qz.png') center/contain no-repeat;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0;animation:swirlFade 2.2s ease-out forwards;pointer-events:none;z-index:18}
    @keyframes faintFall{0%{transform:translateY(0) rotate(0deg);opacity:1}70%{transform:translateY(120px) rotate(15deg);opacity:0.7}100%{transform:translateY(280px) rotate(30deg);opacity:0}}
    @keyframes faintEyes{0%,50%{opacity:0}55%,90%{opacity:1}100%{opacity:0}}
    @keyframes swirlFade{0%{opacity:0;transform:translate(-50%,-50%) scale(0.3) rotate(0deg)}30%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(360deg)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.6) rotate(720deg)}}
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="brand"><h1>Pikaplay Arena</h1></div>
    <div class="menu">
        <a href="home.html">üè† Home</a>
        <a href="shop.html">üõí Marketplace</a>
      <a href="arena.html">‚öî Game Play</a>
      <a href="online.html" style="background-color: rgb(241, 112, 37);color:white">‚öî Online Play</a>
    </div>
    <div class="status">
      <img src="images/Ash_ketchum_render_by_tzblacktd-da9k0wb.webp" alt="" style="height:50px;width:50px;border-radius:50%;align-self:center">
      <span class="coins" id="coinDisplay">1500 Coins</span>
      <span class="free-balance" id="tokenDisplay">Loading...</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <h1 class="title">ONLINE BATTLE ARENA</h1>

    <div id="roomSetup" class="room-setup" style="background:#0a0f1d">
      <button onclick="createRoom()">CREATE ROOM</button>
      <p style="margin:20px 0;font-size:1.4rem">OR</p>
<input type="text" id="roomCodeInput" placeholder="Enter 6-digit room code" maxlength="6" style="text-transform:uppercase">      <button onclick="joinRoom()">JOIN ROOM</button>
      <div id="roomStatus" style="margin-top:20px;font-size:1.2rem;color:#ffcb05"></div>
    </div>

    <div id="teamSelect" style="display:none">
      <h2 style="color:#ffcb05;font-size:2rem;margin-bottom:2rem">Choose Your Pok√©mon</h2>
      <div class="team-select" id="teamGrid"></div>
      <button id="readyBtn" disabled style="margin-top:2rem;font-size:1.8rem;padding:20px 50px">READY!</button>
    </div>

    <div id="battleArea" class="battle-area" style="display:none">
      <div id="attackContainer" class="attack-container"></div>

      <div style="position:absolute;left:100px;bottom:5px">
        <h2 class="player" style="color:orange">YOU</h2>
        <div class="player-base">
          <div class="hp-box">
            <div style="color:#5266e7" id="playerName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="playerHpFill"></div></div>
            <div id="playerHpText">100/100 HP</div>
          </div>
          <img id="playerImg" class="pokemon-back" src="" alt="Your Pok√©mon" style="height:300px;width:300px">
        </div>
      </div>

      <div style="position:absolute;top:50px;right:70px">
        <h2 class="opponent" style="color:red">OPPONENT</h2>
        <div class="opponent-base">
          <div class="hp-box">
            <div style="color:#f44336" id="oppoName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="oppoHpFill"></div></div>
            <div id="oppoHpText">100/100 HP</div>
          </div>
          <img id="oppoImg" class="pokemon-front" src="" alt="Opponent" style="height:150px;width:150px">
        </div>
      </div>

      <div id="playerActions"></div>
    </div>

    <div class="log" id="battleLog">Waiting for opponent...</div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="confirm-modal" id="confirmModal">
    <h2 style="color:#ffcb05">Opponent Wants to Battle!</h2>
    <p>Player ID:</p>
    <p id="opponentId" style="font-family:monospace;color:#4caf50;font-size:1.4rem"></p>
    <button style="background:#4caf50;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="acceptOpponent()">Accept</button>
    <button style="background:#f44336;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="rejectOpponent()">Reject</button>
  </div>

<script>
// ==================== GLOBALS & DATA ====================
const TOKEN_ADDRESS = '0x614f35C48c780e637496B3F707c9373723689868';
const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)","function transfer(address to, uint256 amount) returns (bool)"];

let provider, signer, tokenContract, userAddress = null;
let opponentAddress = null;
let conn = null;
let peer = null;
let myPokemon = null, opponentPokemon = null, myTurn = false;
let isHost = false, bothReady = false, turnDecided = false;
let pendingOpponent = null;

// ==================== COMPLETE POK√âMON MOVES DATABASE (Gen 1‚Äì5) ====================
const POKEMON_MOVES = {
  // Gen 1 Starters
  1: { name: "Bulbasaur", moves: ["Tackle", "Vine Whip", "Razor Leaf", "Solar Beam"] },
  2: { name: "Ivysaur", moves: ["Vine Whip", "Razor Leaf", "Solar Beam", "Sludge Bomb"] },
  3: { name: "Venusaur", moves: ["Petal Dance", "Solar Beam", "Earthquake", "Sludge Bomb"] },
  4: { name: "Charmander", moves: ["Scratch", "Ember", "Flamethrower", "Fire Blast"] },
  5: { name: "Charmeleon", moves: ["Ember", "Flamethrower", "Fire Blast", "Dragon Rage"] },
  6: { name: "Charizard", moves: ["Wing Attack", "Flamethrower", "Fire Blast", "Air Slash"] },
  7: { name: "Squirtle", moves: ["Tackle", "Water Gun", "Bubble Beam", "Hydro Pump"] },
  8: { name: "Wartortle", moves: ["Water Gun", "Bubble Beam", "Hydro Pump", "Skull Bash"] },
  9: { name: "Blastoise", moves: ["Hydro Pump", "Skull Bash", "Flash Cannon", "Ice Beam"] },

  // Popular Gen 1
  25: { name: "Pikachu", moves: ["Thunder Shock", "Quick Attack", "Thunderbolt", "Thunder"] },
  26: { name: "Raichu", moves: ["Thunderbolt", "Thunder", "Focus Blast", "Brick Break"] },
  143: { name: "Snorlax", moves: ["Tackle", "Body Slam", "Hyper Beam", "Giga Impact"] },
  150: { name: "Mewtwo", moves: ["Psychic", "Shadow Ball", "Aura Sphere", "Psystrike"] },
  94: { name: "Gengar", moves: ["Lick", "Shadow Ball", "Sludge Bomb", "Destiny Bond"] },
  149: { name: "Dragonite", moves: ["Dragon Rush", "Hurricane", "Extreme Speed", "Outrage"] },
  130: { name: "Gyarados", moves: ["Hydro Pump", "Dragon Dance", "Waterfall", "Earthquake"] },
  131: { name: "Lapras", moves: ["Water Pulse", "Ice Beam", "Hydro Pump", "Blizzard"] },
  59: { name: "Arcanine", moves: ["Fire Fang", "Extreme Speed", "Flamethrower", "Thunder Fang"] },
  65: { name: "Alakazam", moves: ["Psychic", "Focus Blast", "Shadow Ball", "Energy Ball"] },
  68: { name: "Machamp", moves: ["Dynamic Punch", "Cross Chop", "Stone Edge", "Bulk Up"] },

  // Gen 2 Starters
  152: { name: "Chikorita", moves: ["Tackle", "Razor Leaf", "Magical Leaf", "Solar Beam"] },
  155: { name: "Cyndaquil", moves: ["Ember", "Flame Wheel", "Flamethrower", "Eruption"] },
  158: { name: "Totodile", moves: ["Scratch", "Water Gun", "Crunch", "Hydro Pump"] },

  // Gen 3 Starters
  252: { name: "Treecko", moves: ["Pound", "Quick Attack", "Leaf Blade", "Giga Drain"] },
  255: { name: "Torchic", moves: ["Scratch", "Ember", "Blaze Kick", "Sky Uppercut"] },
  258: { name: "Mudkip", moves: ["Tackle", "Water Gun", "Mud Bomb", "Hydro Pump"] },

  // Gen 4 Starters
  387: { name: "Turtwig", moves: ["Tackle", "Razor Leaf", "Earthquake", "Wood Hammer"] },
  390: { name: "Chimchar", moves: ["Scratch", "Ember", "Flame Wheel", "Fire Punch"] },
  393: { name: "Piplup", moves: ["Pound", "Bubble", "Bubble Beam", "Hydro Pump"] },

  // Gen 5 Starters
  495: { name: "Snivy", moves: ["Tackle", "Vine Whip", "Leaf Blade", "Leaf Storm"] },
  498: { name: "Tepig", moves: ["Tackle", "Ember", "Flame Charge", "Heat Crash"] },
  501: { name: "Oshawott", moves: ["Tackle", "Water Gun", "Razor Shell", "Hydro Pump"] },

  // Legendaries & Cool Ones
  144: { name: "Articuno", moves: ["Ice Beam", "Blizzard", "Hurricane", "Ancient Power"] },
  145: { name: "Zapdos", moves: ["Thunder Shock", "Drill Peck", "Thunderbolt", "Thunder"] },
  146: { name: "Moltres", moves: ["Fire Spin", "Air Slash", "Flamethrower", "Sky Attack"] },
  249: { name: "Lugia", moves: ["Aeroblast", "Hydro Pump", "Psychic", "Future Sight"] },
  250: { name: "Ho-Oh", moves: ["Sacred Fire", "Brave Bird", "Fire Blast", "Recover"] },
  483: { name: "Dialga", moves: ["Roar of Time", "Flash Cannon", "Aura Sphere", "Earth Power"] },
  484: { name: "Palkia", moves: ["Spacial Rend", "Hydro Pump", "Aura Sphere", "Draco Meteor"] },
  487: { name: "Giratina", moves: ["Shadow Force", "Dragon Claw", "Aura Sphere", "Shadow Ball"] },
  643: { name: "Reshiram", moves: ["Blue Flare", "Dragon Pulse", "Crunch", "Fusion Flare"] },
  644: { name: "Zekrom", moves: ["Bolt Strike", "Dragon Claw", "Crunch", "Fusion Bolt"] },
  646: { name: "Kyurem", moves: ["Glaciate", "Dragon Pulse", "Ice Beam", "Draco Meteor"] }
};

// ==================== EXPANDED MOVE TYPE MAPPING (Supports all above moves) ====================
const MOVE_TYPES = {
  // Normal
  "Tackle":"normal","Quick Attack":"normal","Scratch":"normal","Pound":"normal",
  "Body Slam":"normal","Hyper Beam":"normal","Giga Impact":"normal","Extreme Speed":"normal",
  "Skull Bash":"normal","Dynamic Punch":"normal","Cross Chop":"normal",

  // Fire
  "Ember":"fire","Flamethrower":"fire","Fire Blast":"fire","Fire Fang":"fire",
  "Flame Wheel":"fire","Fire Punch":"fire","Blaze Kick":"fire","Eruption":"fire",
  "Sacred Fire":"fire","Blue Flare":"fire","Fusion Flare":"fire","Fire Spin":"fire",

  // Water
  "Water Gun":"water","Bubble":"water","Bubble Beam":"water","Hydro Pump":"water",
  "Water Pulse":"water","Waterfall":"water","Razor Shell":"water","Spacial Rend":"water",

  // Electric
  "Thunder Shock":"electric","Thunderbolt":"electric","Thunder":"electric",
  "Bolt Strike":"electric",

  // Grass
  "Vine Whip":"grass","Razor Leaf":"grass","Solar Beam":"grass","Magical Leaf":"grass",
  "Leaf Blade":"grass","Giga Drain":"grass","Leaf Storm":"grass","Wood Hammer":"grass",
  "Petal Dance":"grass","Energy Ball":"grass",

  // Ice
  "Ice Beam":"ice","Blizzard":"ice","Glaciate":"ice",

  // Fighting
  "Brick Break":"fighting","Focus Blast":"fighting","Aura Sphere":"fighting",
  "Sky Uppercut":"fighting","Bulk Up":"fighting",

  // Poison
  "Sludge Bomb":"poison","Lick":"ghost",

  // Ground
  "Earthquake":"ground","Mud Bomb":"ground","Earth Power":"ground",

  // Flying
  "Wing Attack":"flying","Air Slash":"flying","Hurricane":"flying","Drill Peck":"flying",
  "Brave Bird":"flying","Aeroblast":"flying","Sky Attack":"flying",

  // Psychic
  "Psychic":"psychic","Psystrike":"psychic","Future Sight":"psychic",

  // Ghost
  "Shadow Ball":"ghost","Destiny Bond":"ghost","Shadow Force":"ghost",

  // Dragon
  "Dragon Rage":"dragon","Dragon Claw":"dragon","Outrage":"dragon","Dragon Rush":"dragon",
  "Dragon Pulse":"dragon","Draco Meteor":"dragon","Roar of Time":"dragon",

  // Dark
  "Crunch":"dark",

  // Steel
  "Flash Cannon":"steel",

  // Rock
  "Ancient Power":"rock","Stone Edge":"rock",

  // Default fallback
  "default": "normal"
};

// Fallback: if Pok√©mon not in database, give 4 random cool moves
const FALLBACK_MOVES = ["Tackle", "Quick Attack", "Thunderbolt", "Flamethrower", "Hydro Pump", "Solar Beam", "Psychic", "Shadow Ball", "Hyper Beam", "Giga Impact"];

function getMovesForPokemon(id) {
  if (POKEMON_MOVES[id]) return POKEMON_MOVES[id].moves;
  // Random 4 moves from cool pool
  const shuffled = FALLBACK_MOVES.sort(() => 0.5 - Math.random());
  return shuffled.slice(0, 4);
}

// ==================== IMAGE HELPERS ====================
function img(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }
function backImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/${id}.gif`; }
function frontImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`; }

// ==================== LOG & WALLET (unchanged) ====================
function log(msg) {
  const el = document.getElementById('battleLog');
  el.innerHTML += `<div>${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

document.getElementById('connectBtn').onclick = async () => {
  if (!window.ethereum) return alert('Install MetaMask!');
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa36a7' }] });
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
    document.getElementById('walletDisplay').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
    document.getElementById('connectBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline-block';
    log('Wallet connected!');
  } catch (e) { alert('Connection failed'); }
};

document.getElementById('logoutBtn').onclick = () => location.reload();

// ==================== ATTACK ANIMATION ENGINE ====================
function playAttackAnimation(isPlayerAttacker, moveName, isMiss = false) {
  const container = document.getElementById('attackContainer');
  const attacker = isPlayerAttacker ? document.getElementById('playerImg') : document.getElementById('oppoImg');
  const target = isPlayerAttacker ? document.getElementById('oppoImg') : document.getElementById('playerImg');
  const attackerRect = attacker.getBoundingClientRect();
  const targetRect = target.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  const startX = attackerRect.left + attackerRect.width / 2 - containerRect.left;
  const startY = attackerRect.top + attackerRect.height / 2 - containerRect.top;
  let endX = targetRect.left + targetRect.width / 2 - containerRect.left;
  let endY = targetRect.top + targetRect.height / 2 - containerRect.top;

  const type = (MOVE_TYPES[moveName] || "normal").toLowerCase();

  // Dodge animation
  if (isMiss) {
    target.classList.add('dodge-jump');
    setTimeout(() => target.classList.remove('dodge-jump'), 900);
    endX += (Math.random() > 0.5 ? 280 : -280);
    endY -= 140;
  }

  // === TYPE-SPECIFIC ANIMATIONS ===
  if (type === "fire") {
    createBeam(startX, startY, endX, endY, "linear-gradient(90deg,transparent,#fff,#ff1744,#ff9800,transparent)", "0 0 50px #ff4500");
    setTimeout(() => createExplosion(endX, endY, "#ff4500", "#ff9800"), 600);
  }
  else if (type === "electric") {
    for (let i = 0; i < 12; i++) {
      setTimeout(() => createLightning(startX, startY, endX, endY), i * 70);
    }
  }
  else if (type === "water") {
    for (let i = 0; i < 15; i++) {
      setTimeout(() => createWaterWave(startX, startY, endX, endY, i), i * 50);
    }
  }
  else if (type === "grass") {
    for (let i = 0; i < 10; i++) {
      setTimeout(() => createLeafBlade(startX, startY, endX, endY), i * 90);
    }
  }
  else if (type === "ice") {
    createIceShards(startX, startY, endX, endY);
    setTimeout(() => createIceExplosion(endX, endY), 800);
  }
  else if (type === "psychic") {
    createPsychicWave(startX, startY, endX, endY);
    setTimeout(() => createConfusionSwirl(endX, endY), 700);
  }
  else if (type === "ghost" || type === "dark") {
    createShadowBall(startX, startY, endX, endY);
  }
  else if (type === "dragon") {
    createDragonPulse(startX, startY, endX, endY);
  }
  else if (type === "fighting") {
    createFightingPunch(startX, startY, endX, endY);
  }
  else if (type === "rock") {
    createRockThrow(startX, startY, endX, endY);
  }
  else if (type === "flying") {
    createGustWind(startX, startY, endX, endY);
  }
  else if (type === "poison") {
    createPoisonGas(startX, startY, endX, endY);
  }
  else if (type === "ground") {
    createEarthquakeCrack(startX, startY, endX, endY);
  }
  else if (type === "steel") {
    createMetalClaw(startX, startY, endX, endY);
  }
  else { // normal & fallback
    createNormalTackle(startX, startY, endX, endY);
  }

  // Hit flash + screen shake
  if (!isMiss) {
    setTimeout(() => {
      createHitFlash(endX, endY);
      document.getElementById('battleArea').classList.add('shake');
      setTimeout(() => document.getElementById('battleArea').classList.remove('shake'), 600);
    }, 700);
  }
}

// === REUSABLE ANIMATION HELPERS ===
function createBeam(x1, y1, x2, y2, gradient, shadow) {
  const el = document.createElement('div');
  el.className = 'beam-line';
  el.style.left = x1 + 'px';
  el.style.top = y1 + 'px';
  el.style.width = Math.hypot(x2-x1, y2-y1) + 'px';
  el.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1)}rad)`;
  el.style.background = gradient;
  el.style.boxShadow = shadow;
  document.getElementById('attackContainer').appendChild(el);
  el.animate([{opacity:0},{opacity:1,offset:0.3},{opacity:0}], {duration:900}).onfinish = () => el.remove();
}

function createExplosion(x, y, color1, color2) {
  const exp = document.createElement('div');
  exp.className = 'fire-explosion';
  exp.style.left = (x-100)+'px'; exp.style.top = (y-100)+'px';
  exp.style.background = `radial-gradient(circle, ${color1} 15%, ${color2} 50%, transparent 80%)`;
  document.getElementById('attackContainer').appendChild(exp);
  exp.animate([{transform:'scale(0)',opacity:1},{transform:'scale(3)',opacity:0}], {duration:800}).onfinish = () => exp.remove();
}

function createLightning(x1, y1, x2, y2) {
  const bolt = document.createElement('div');
  bolt.className = 'lightning-bolt';
  bolt.style.left = x1 + 'px';
  bolt.style.top = y1 + 'px';
  bolt.style.height = Math.hypot(x2-x1, y2-y1) + 'px';
  bolt.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1) + (Math.random()-0.5)*0.6}rad)`;
  document.getElementById('attackContainer').appendChild(bolt);
  bolt.animate([{opacity:1, transform: bolt.style.transform},{opacity:0}], {duration:700}).onfinish = () => bolt.remove();
}

function createWaterWave(x1, y1, x2, y2, i) {
  const wave = document.createElement('div');
  wave.className = 'water-wave';
  wave.style.left = x1 + 'px';
  wave.style.top = y1 + 'px';
  wave.style.width = (60 + i*25) + 'px';
  document.getElementById('attackContainer').appendChild(wave);
  wave.animate([
    {transform:'scale(0.2)', opacity:0.9},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2)`, opacity:0}
  ], {duration:1000}).onfinish = () => wave.remove();
}

function createLeafBlade(x1, y1, x2, y2) {
  const leaf = document.createElement('div');
  leaf.className = 'leaf-blade';
  leaf.style.left = x1 + 'px'; leaf.style.top = y1 + 'px';
  document.getElementById('attackContainer').appendChild(leaf);
  leaf.animate([
    {transform:'rotate(0deg) scale(0.5)', opacity:1},
    {transform:`translate(${x2-x1}px,${y2-y1}px) rotate(1080deg) scale(1.5)`, opacity:0}
  ], {duration:1100}).onfinish = () => leaf.remove();
}

function createIceShards(x1, y1, x2, y2) {
  for (let i = 0; i < 8; i++) {
    const shard = document.createElement('div');
    shard.style.position = 'absolute';
    shard.style.width = '16px'; shard.style.height = '60px';
    shard.style.background = 'linear-gradient(45deg, #88eeee, #00ffff)';
    shard.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
    shard.style.left = x1 + 'px'; shard.style.top = y1 + 'px';
    shard.style.boxShadow = '0 0 20px #00ffff';
    document.getElementById('attackContainer').appendChild(shard);
    const angle = Math.atan2(y2-y1, x2-x1) + (Math.random()-0.5)*1;
    const dist = Math.hypot(x2-x1, y2-y1);
    shard.animate([
      {transform:'translate(0,0) rotate(0deg)'},
      {transform:`translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) rotate(720deg)`}
    ], {duration:1000, easing:'cubic-bezier(0.2,0.8,0.2,1)'}).onfinish = () => shard.remove();
  }
}

function createPsychicWave(x1, y1, x2, y2) {
  const wave = document.createElement('div');
  wave.style.position = 'absolute';
  wave.style.width = '200px'; wave.style.height = '200px';
  wave.style.border = '8px solid transparent';
  wave.style.borderRadius = '50%';
  wave.style.borderColor = '#ff00ff transparent #00ffff transparent';
  wave.style.left = (x1-100)+'px'; wave.style.top = (y1-100)+'px';
  wave.style.boxShadow = '0 0 60px #ff00ff';
  document.getElementById('attackContainer').appendChild(wave);
  wave.animate([
    {transform:'scale(0.3) rotate(0deg)', opacity:0},
    {transform:'scale(2.5) rotate(360deg)', opacity:1, offset:0.6},
    {opacity:0}
  ], {duration:1200}).onfinish = () => wave.remove();
}

function createShadowBall(x1, y1, x2, y2) {
  const ball = document.createElement('div');
  ball.style.position = 'absolute';
  ball.style.width = '80px'; ball.style.height = '80px';
  ball.style.background = 'radial-gradient(circle at 30% 30%, #222, #000)';
  ball.style.border = '4px solid #9900ff';
  ball.style.borderRadius = '50%';
  ball.style.left = (x1-40)+'px'; ball.style.top = (y1-40)+'px';
  ball.style.boxShadow = '0 0 60px #9900ff, inset 0 0 40px #000';
  document.getElementById('attackContainer').appendChild(ball);
  ball.animate([
    {transform:'translate(0,0) scale(0.5)'},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2.5)`}
  ], {duration:900}).onfinish = () => {
    ball.remove();
    createHitFlash(x2, y2, '#9900ff');
  };
}

function createDragonPulse(x1, y1, x2, y2) {
  createBeam(x1, y1, x2, y2, "linear-gradient(90deg,transparent,#00ffff,#0066ff,#00ffff,transparent)", "0 0 60px #00ffff");
  setTimeout(() => createExplosion(x2, y2, "#0066ff", "#00ffff"), 700);
}

function createHitFlash(x, y, color = "#ffffff") {
  const flash = document.createElement('div');
  flash.className = 'hit-flash';
  flash.style.left = (x-120)+'px'; flash.style.top = (y-120)+'px';
  flash.style.background = `radial-gradient(circle, ${color} 10%, transparent 70%)`;
  document.getElementById('attackContainer').appendChild(flash);
  flash.animate([{opacity:0},{opacity:1},{opacity:0}], {duration:500}).onfinish = () => flash.remove();
}

function createNormalTackle(x1, y1, x2, y2) {
  const tackle = document.createElement('div');
  tackle.className = 'normal-tackle';
  tackle.style.left = x1 + 'px'; tackle.style.top = y1 + 'px';
  document.getElementById('attackContainer').appendChild(tackle);
  tackle.animate([
    {transform:'scale(0.4)', opacity:0},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2.2)`, opacity:0.9},
    {opacity:0}
  ], {duration:800}).onfinish = () => tackle.remove();
}

// Add more if you want: poison gas clouds, rock slides, wind gusts, etc.

// ==================== ATTACK LOGIC ====================
function attack() {
  if (!myTurn || !conn || !myPokemon) return;

 const moves = getMovesForPokemon(myPokemon.id);
  const chosenMove = moves[Math.floor(Math.random() * moves.length)];
  const isMiss = Math.random() < 0.2;
  const damage = isMiss ? 0 : 15 + Math.floor(Math.random() * 6);

  playAttackAnimation(true, chosenMove, isMiss);

  if (isMiss) {
    log(`<span style="color:#ccc"><b>${myPokemon.name.toUpperCase()}</b> used <b>${chosenMove}</b>...<br>but it <b style="color:#ff9800">MISSED!</b></span>`);
  } else {
    log(`<b>${myPokemon.name.toUpperCase()}</b> used <b style="color:#ffeb3b">${chosenMove}</b>!<br>Dealt <b style="color:#ff4444">${damage}</b> damage!`);
  }

  conn.send({ type: 'attack', moveName: chosenMove, damage, missed: isMiss });

  if (!isMiss) {
    let oppHp = parseInt(document.getElementById('oppoHpText').textContent);
    oppHp = Math.max(0, oppHp - damage);
    document.getElementById('oppoHpFill').style.width = oppHp + '%';
    document.getElementById('oppoHpText').textContent = oppHp + '/100 HP';
    document.getElementById('oppoHpFill').classList.toggle('warning', oppHp <= 50);
    document.getElementById('oppoHpFill').classList.toggle('danger', oppHp <= 20);

    if (oppHp <= 0) {
      setTimeout(() => triggerFaint(false), 1200);
      conn.send({ type: 'victory' });
    }
  }

  document.getElementById('playerActions').innerHTML = '<div style="background:rgba(0,0,0,0.7);color:#ccc;padding:20px 40px;border-radius:16px;font-size:1.4rem">Waiting for opponent...</div>';
  myTurn = false;
}

function receiveAttack(data) {
  playAttackAnimation(false, data.moveName, data.missed);

  if (data.missed) {
    log(`<span style="color:#ccc">Opponent's <b>${opponentPokemon.name.toUpperCase()}</b> used <b>${data.moveName}</b>...<br>but you <b style="color:#4caf50">DODGED!</b></span>`);
    myTurn = true;
    showAttackButton();
    return;
  }

  log(`Opponent's <b>${opponentPokemon.name.toUpperCase()}</b> used <b style="color:#ffeb3b">${data.moveName}</b>!<br>Took <b style="color:#ff4444">${data.damage}</b> damage!`);

  let myHp = parseInt(document.getElementById('playerHpText').textContent);
  myHp = Math.max(0, myHp - data.damage);
  document.getElementById('playerHpFill').style.width = myHp + '%';
  document.getElementById('playerHpText').textContent = myHp + '/100 HP';
  document.getElementById('playerHpFill').classList.toggle('warning', myHp <= 50);
  document.getElementById('playerHpFill').classList.toggle('danger', myHp <= 20);

  if (myHp <= 0) {
    setTimeout(() => triggerFaint(true), 1200);
    conn.send({ type: 'defeat' });
  } else {
    myTurn = true;
    showAttackButton();
  }
}

function triggerFaint(isPlayer) {
  const img = isPlayer ? document.getElementById('playerImg') : document.getElementById('oppoImg');
  img.classList.add('fainted');
  const eyes = document.createElement('div'); eyes.className = 'faint-eyes';
  img.parentNode.appendChild(eyes);
  const swirl = document.createElement('div'); swirl.className = 'faint-swirl';
  document.getElementById('battleArea').appendChild(swirl);

  log(isPlayer 
    ? '<span style="color:#ff4444;font-size:2.8rem">YOUR POK√âMON FAINTED!</span>'
    : '<span style="color:#4caf50;font-size:2.8rem">OPPONENT FAINTED! VICTORY!</span>'
  );
}

function showAttackButton() {
  if (!myTurn) return;
  document.getElementById('playerActions').innerHTML = `<button class="attack-btn" onclick="attack()">ATTACK!</button>`;
}

// ==================== PEERJS & TEAM SELECTION (unchanged) ====================
let ownedLocal = JSON.parse(localStorage.getItem('owned') || '[]');

function createRoom() {
  if (!userAddress) return alert("Connect wallet first!");

  // Generate random 6-character room code (A-Z, 0-9)
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }

  isHost = true;
  peer = new Peer(code, { 
    host: '0.peerjs.com', 
    port: 443, 
    secure: true 
  });

  setupPeerEvents();

  // Optional: Copy to clipboard automatically
  navigator.clipboard.writeText(code).catch(() => {});
  
  // Show the generated code nicely
  document.getElementById('roomStatus').innerHTML = `
    <div style="font-size:1.6rem;color:#ffcb05">
      Room Created!<br><br>
      <div style="background:rgba(255,203,5,0.2);padding:16px;border:3px solid #ffcb05;border-radius:12px;font-size:2.2rem;letter-spacing:8px;font-family:monospace">
        ${code}
      </div>
      <br>
      <button onclick="navigator.clipboard.writeText('${code}'); this.innerText='Copied!'; setTimeout(()=>this.innerText='Copy Code',2000)" 
              style="padding:10px 20px;font-size:1rem;background:#ff9800;border:none;border-radius:8px;color:white;cursor:pointer">
        Copy Code
      </button>
      <br><br>Waiting for opponent to join...
    </div>
  `;

  log(`Room created: <b style="color:#ffcb05">${code}</b>`);
}

function joinRoom() {
  if (!userAddress) return alert("Connect wallet first!");
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!code) return alert("Enter a room code!");
  peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, secure: true });
  setupPeerEvents();
  peer.on('open', () => {
    conn = peer.connect(code);
    setupConnEvents(conn);
    log('Joining room...');
  });
}

function setupPeerEvents() {
  peer.on('open', id => {
    document.getElementById('roomStatus').innerHTML = `Room Created!<br><b style="font-size:1.8rem;color:#ffcb05">${id}</b><br>Waiting...`;
    log(`Room ${id} ready`);
  });

  peer.on('connection', incoming => {
    if (conn) return incoming.close();
    document.getElementById('opponentId').textContent = incoming.peer;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('confirmModal').style.display = 'block';
    pendingOpponent = incoming;
  });
}

function acceptOpponent() {
  conn = pendingOpponent; pendingOpponent = null;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('confirmModal').style.display = 'none';
  setupConnEvents(conn);
  conn.send({ type: 'accepted' });
  startTeamSelection();
  log('Battle accepted!');
}

function rejectOpponent() {
  if (pendingOpponent) pendingOpponent.close();
  pendingOpponent = null;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('confirmModal').style.display = 'none';
}

function setupConnEvents(c) {
  conn = c;
  conn.on('open', () => log('Connected!'));
  conn.on('data', data => {
    if (data.type === 'wallet') opponentAddress = data.address;
    else if (data.type === 'accepted') startTeamSelection();
    else if (data.type === 'pokemon') {
      opponentPokemon = data.poke;
      document.getElementById('oppoImg').src = frontImg(opponentPokemon.id) || img(opponentPokemon.id);
      document.getElementById('oppoName').textContent = opponentPokemon.name.toUpperCase();
      document.getElementById('oppoHpText').textContent = '100/100 HP';
      document.getElementById('oppoHpFill').style.width = '100%';
      log(`Opponent sent ${opponentPokemon.name.toUpperCase()}!`);
      if (myPokemon) { bothReady = true; startBattle(); }
    }
    else if (data.type === 'attack') receiveAttack(data);
    else if (data.type === 'turn') {
      turnDecided = true;
      myTurn = !data.first;
      myTurn ? (log('<span style="color:#4caf50">Your turn first!</span>'), showAttackButton()) : log('<span style="color:#f44336">Opponent goes first</span>');
    }
    else if (data.type === 'victory') {
      log('<span style="color:#f44336;font-size:2.4rem">YOU LOST!</span>');
      setTimeout(() => payToWinner(opponentAddress), 1500);
    }
    else if (data.type === 'defeat') {
      log('<span style="color:#4caf50;font-size:2rem">VICTORY! +500 TOKEN</span>');
    }
  });
  conn.on('close', () => { log('<span style="color:#f44336">Opponent disconnected!</span>'); alert('Opponent left'); location.reload(); });
}

async function payToWinner(winner) {
  if (!tokenContract || !winner) return;
  const decimals = await tokenContract.decimals();
  const amount = ethers.utils.parseUnits("500", decimals);
  try {
    const tx = await tokenContract.transfer(winner, amount);
    await tx.wait();
    log('<span style="color:#4caf50;font-size:1.8rem">500 TOKEN PAID!</span>');
  } catch (e) { log('<span style="color:#ff4444">Payment failed</span>'); }
}

function startTeamSelection() {
  document.getElementById('roomSetup').style.display = 'none';
  document.getElementById('teamSelect').style.display = 'block';
  const grid = document.getElementById('teamGrid'); grid.innerHTML = '';
  if (ownedLocal.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;color:#ffcb05;font-size:1.5rem">No Pok√©mon!<br>Visit shop!</p>';
    return;
  }
  ownedLocal.forEach(p => {
    const card = document.createElement('div');
    card.className = 'team-card';
    card.innerHTML = `<img src="${img(p.id)}"><br><b>${p.name.toUpperCase()}</b>`;
    card.onclick = () => {
      document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      myPokemon = p;
      document.getElementById('readyBtn').disabled = false;
    };
    grid.appendChild(card);
  });

  document.getElementById('readyBtn').onclick = () => {
    document.getElementById('playerImg').src = backImg(myPokemon.id) || img(myPokemon.id);
    document.getElementById('playerName').textContent = myPokemon.name.toUpperCase();
    document.getElementById('teamSelect').style.display = 'none';
    document.getElementById('battleArea').style.display = 'block';
    conn.send({ type: 'pokemon', poke: myPokemon });
    log(`You sent out ${myPokemon.name.toUpperCase()}!`);
    if (opponentPokemon) { bothReady = true; startBattle(); }
  };
}

function startBattle() {
  log('<b style="color:#ffcb05;font-size:1.8rem">BATTLE START!</b>');
  if (isHost && !turnDecided) {
    turnDecided = true;
    myTurn = Math.random() < 0.5;
    conn.send({ type: 'turn', first: myTurn });
    myTurn ? (log('<span style="color:#4caf50">You go first!</span>'), showAttackButton()) : log('<span style="color:#f44336">Opponent goes first...</span>');
  }
}

setInterval(() => {
  if (conn && conn.open && userAddress) conn.send({ type: 'wallet', address: userAddress });
}, 2000);

</script>
</body>
</html>
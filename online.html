<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Arena - 1v1 Battle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden}
   
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;margin:0}
    .menu{padding:12px}
    .menu a{display:block;color:#ffcb05;text-decoration:none;font-weight:700;padding:10px 12px;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin-bottom:10px;transition:.2s}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(4px)}
    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{color:#efe339;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .free-balance{color:#9362ed;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .connect-btn,.logout-btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .connect-btn{background:#4caf50;color:#fff;}
    .connect-btn:hover{background:#45a049;transform:translateY(-1px);}
    .logout-btn{background:#f44336;color:#fff;display:none;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{margin-left:240px;padding:2rem;text-align:center}
    .title{font-family:'Press Start 2P';color:#ffcb05;font-size:2.5rem;margin:1rem 0;text-shadow:0 0 25px #ffcb05}
    .room-setup{max-width:500px;margin:3rem auto;padding:2.5rem;background:rgba(255,203,5,0.1);border:3px solid #ffcb05;border-radius:16px}
    input{padding:14px;font-size:1.2rem;width:100%;margin:15px 0;border:2px solid #ffcb05;background:rgba(0,0,0,0.6);color:#fff;border-radius:12px}
    button{padding:16px 32px;font-size:1.3rem;margin:10px;border:none;border-radius:12px;background:linear-gradient(135deg,#ff9800,#e65100);color:#fff;font-weight:700;cursor:pointer}
    .team-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1.5rem;max-width:900px;margin:2rem auto}
    .team-card{border:4px solid rgba(255,203,5,0.4);border-radius:16px;padding:15px;cursor:pointer;background:rgba(0,0,0,0.2);transition:.2s}
    .team-card:hover{border-color:#ffcb05;transform:scale(1.05)}
    .team-card.selected{border-color:#4caf50;background:rgba(76,175,80,0.4);box-shadow:0 0 30px rgba(76,175,80,0.6)}
    .team-card img{width:100%;height:150px;object-fit:contain}
    .battle-area{position:relative;width:1000px;height:560px;margin:40px auto;background:url('/images/Screenshot 2025-11-20 210130.png') center/cover no-repeat;border-radius:20px;overflow:hidden;box-shadow:0 0 30px rgba(255,203,5,0.8)}
    .player-base{bottom:80px;left:80px;width:300px;text-align:center}
    .pokemon-back img{width:280px;height:280px;image-rendering:pixelated;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.6))}
    .opponent-base{position:absolute;top:60px;right:80px;width:300px;text-align:center}
    .pokemon-front img{width:240px;height:240px;image-rendering:pixelated;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.6))}
    .hp-box{font-family:'Press Start 2P';font-size:0.95rem}
    .hp-bar-small{height:22px;background:#222;border:3px solid #fff;border-radius:10px;overflow:hidden;margin:8px 0}
    .hp-fill-small{height:100%;background:linear-gradient(90deg,#92d04b,#4caf50);transition:width 1s ease}
    .hp-fill-small.warning{background:#ff9800}
    .hp-fill-small.danger{background:#ff4444}
    #playerActions{position:absolute;bottom:60px;right:80px;z-index:10}
    .attack-btn{padding:18px 40px;font-family:'Press Start 2P';font-size:22px;background:linear-gradient(135deg,#ff1744,#c62828);color:white;border:3px solid #ffcb05;border-radius:30px;cursor:pointer;box-shadow:0 15px 40px rgba(255,23,68,0.8);text-transform:uppercase;letter-spacing:5px;transition:all 0.3s}
    .attack-btn:hover{transform:translateY(-10px) scale(1.05);box-shadow:0 30px 60px rgba(255,23,68,1)}
    .log{background:rgba(0,0,0,0.9);border:4px solid #ffcb05;border-radius:16px;padding:1.5rem;height:180px;overflow-y:auto;margin:20px auto;max-width:1000px;font-size:1.1rem;line-height:1.9;font-family:'Courier New',monospace;color:#ffcb05}
    .overlay,.confirm-modal{display:none;position:fixed;z-index:9999}
    .overlay{inset:0;background:rgba(0,0,0,0.8);z-index:9998}
    .confirm-modal{top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:6px solid #ffcb05;border-radius:20px;padding:2rem;max-width:500px;width:90%;text-align:center}

    /* ATTACK ANIMATIONS */
    .attack-container{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:16}
    .beam-line{position:absolute;height:10px;background:linear-gradient(90deg,transparent,#fff,#ffeb3b,transparent);box-shadow:0 0 40px #ffeb3b,0 0 80px #fff;opacity:0}
    .fire-explosion{position:absolute;width:160px;height:160px;background:radial-gradient(circle,#ff4500 10%,#ff8c00 40%,transparent 70%);border-radius:50%;opacity:0}
    .lightning-bolt{position:absolute;width:12px;background:#ffeb3b;box-shadow:0 0 30px #ffeb3b,0 0 60px #fff;transform-origin:top center;opacity:0}
    .water-wave{position:absolute;height:30px;background:linear-gradient(90deg,#00b7eb,#1e90ff);border-radius:50%;opacity:0;filter:blur(4px)}
    .leaf-blade{position:absolute;width:80px;height:30px;background:linear-gradient(45deg,#00ff00,#32cd32);clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%);opacity:0}
    .normal-tackle{position:absolute;width:100px;height:100px;background:radial-gradient(circle,#ffffff 20%,transparent 70%);border-radius:50%;opacity:0}
    .hit-flash{position:absolute;width:220px;height:220px;background:radial-gradient(circle,white 20%,transparent 60%);border-radius:50%;opacity:0}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-10px)}20%,40%,60%,80%{transform:translateX(10px)}}
    .shake{animation:shake 0.5s}
    @keyframes dodgeJump{0%{transform:translateY(0)}50%{transform:translateY(-100px)}100%{transform:translateY(0)}}
    .dodge-jump{animation:dodgeJump 0.8s ease-in-out}

    /* FAINT ANIMATION */
    .fainted{animation:faintFall 2.5s forwards !important;filter:grayscale(100%) brightness(0.6) !important}
    .faint-eyes{position:absolute;width:60px;height:30px;background:white;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-80%);clip-path:polygon(0 0,100% 0,100% 50%,0 50%);opacity:0;animation:faintEyes 2.5s forwards;pointer-events:none;z-index:17}
    .faint-swirl{position:absolute;width:300px;height:300px;background:url('https://i.imgur.com/8p3s4Qz.png') center/contain no-repeat;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0;animation:swirlFade 2.2s ease-out forwards;pointer-events:none;z-index:18}
    @keyframes faintFall{0%{transform:translateY(0) rotate(0deg);opacity:1}70%{transform:translateY(120px) rotate(15deg);opacity:0.7}100%{transform:translateY(280px) rotate(30deg);opacity:0}}
    @keyframes faintEyes{0%,50%{opacity:0}55%,90%{opacity:1}100%{opacity:0}}
    @keyframes swirlFade{0%{opacity:0;transform:translate(-50%,-50%) scale(0.3) rotate(0deg)}30%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(360deg)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.6) rotate(720deg)}}
  

.shield-dome {
  position: absolute;
  width: 420px;
  height: 520px;
  background: radial-gradient(circle at center, rgba(255, 235, 59, 0.35) 0%, transparent 70%);
  border: 12px solid #ffeb3b;
  border-radius: 50%;
  box-shadow: 
    0 0 80px #ffeb3b,
    0 0 160px rgba(255, 235, 59, 0.6),
    inset 0 0 80px rgba(255, 235, 59, 0.3);
  pointer-events: none;
  opacity: 0;
  z-index: 15;
  animation: shieldSimpleAppear 0.7s ease-out forwards;
}

.shield-impact {
  position: absolute;
  width: 500px;
  height: 600px;
  background: radial-gradient(circle, #ffffff 8%, #ffeb3b 25%, transparent 55%);
  border-radius: 50%;
  opacity: 0;
  pointer-events: none;
  animation: shieldSimpleHit 0.9s ease-out forwards;
  z-index: 16;
}

.protect-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: 'Press Start 2P', cursive;
  font-size: 3.2rem;
  color: #ffeb3b;
  text-shadow: 0 0 20px #fff, 0 0 40px #ffeb3b;
  opacity: 0;
  pointer-events: none;
  animation: protectSimpleFlash 1.6s ease-out forwards;
}

/* Simple animations */
@keyframes shieldSimpleAppear {
  0%   { transform: scale(0.4); opacity: 0; }
  60%  { transform: scale(1.08); opacity: 1; }
  100% { transform: scale(1); opacity: 0.7; }
}

@keyframes shieldSimpleHit {
  0%   { opacity: 0; transform: scale(0.7); }
  40%  { opacity: 1; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(1.6); }
}

@keyframes protectSimpleFlash {
  0%, 75%  { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
  15%, 55% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  100%     { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
}
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="brand"><h1>Pikaplay Arena</h1></div>
    <div class="menu">
        <a href="home.html">üè† Home</a>
        <a href="shop.html">üõí Marketplace</a>
      <a href="arena.html">‚öî Game Play</a>
      <a href="online.html" style="background-color: rgb(241, 112, 37);color:white">‚öî Online Play</a>
    </div>
    <div class="status">
      <span class="coins" id="coinDisplay">1500 Coins</span>
      <span class="free-balance" id="tokenDisplay">Loading...</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <h1 class="title">ONLINE BATTLE ARENA</h1>

    <div id="roomSetup" class="room-setup" style="background:#0a0f1d">
      <button onclick="createRoom()">CREATE ROOM</button>
      <p style="margin:20px 0;font-size:1.4rem">OR</p>
<input type="text" id="roomCodeInput" placeholder="Enter 6-digit room code" maxlength="6" style="text-transform:uppercase">      <button onclick="joinRoom()">JOIN ROOM</button>
      <div id="roomStatus" style="margin-top:20px;font-size:1.2rem;color:#ffcb05"></div>
    </div>

    <div id="teamSelect" style="display:none">
      <h2 style="color:#ffcb05;font-size:2rem;margin-bottom:2rem">Choose Your Pok√©mon</h2>
      <div class="team-select" id="teamGrid"></div>
      <button id="readyBtn" disabled style="margin-top:2rem;font-size:1.8rem;padding:20px 50px">READY!</button>
    </div>

    <div id="battleArea" class="battle-area" style="display:none">
      <div id="attackContainer" class="attack-container"></div>

      <div style="position:absolute;left:100px;bottom:5px">
        <h2 class="player" style="color:orange">YOU</h2>
        <div class="player-base">
          <div class="hp-box">
            <div style="color:#5266e7" id="playerName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="playerHpFill"></div></div>
            <div id="playerHpText">100/100 HP</div>
          </div>
          <img id="playerImg" class="pokemon-back" src="" alt="Your Pok√©mon" style="height:300px;width:300px">
        </div>
      </div>

      <div style="position:absolute;top:50px;right:70px">
        <h2 class="opponent" style="color:red">OPPONENT</h2>
        <div class="opponent-base">
          <div class="hp-box">
            <div style="color:#f44336" id="oppoName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="oppoHpFill"></div></div>
            <div id="oppoHpText">100/100 HP</div>
          </div>
          <img id="oppoImg" class="pokemon-front" src="" alt="Opponent" style="height:150px;width:150px">
        </div>
      </div>

      <div id="playerActions"></div>
    </div>

    <div class="log" id="battleLog">Waiting for opponent...</div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="confirm-modal" id="confirmModal">
    <h2 style="color:#ffcb05">Opponent Wants to Battle!</h2>
    <p>Player ID:</p>
    <p id="opponentId" style="font-family:monospace;color:#4caf50;font-size:1.4rem"></p>
    <button style="background:#4caf50;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="acceptOpponent()">Accept</button>
    <button style="background:#f44336;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="rejectOpponent()">Reject</button>
  </div>

<script>
// ==================== GLOBALS & DATA ====================
const TOKEN_ADDRESS = '0x614f35C48c780e637496B3F707c9373723689868';
const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)","function transfer(address to, uint256 amount) returns (bool)"];

let provider, signer, tokenContract, userAddress = null;
let opponentAddress = null;
let conn = null;
let peer = null;
let myPokemon = null, opponentPokemon = null, myTurn = false;
let isHost = false, bothReady = false, turnDecided = false;
let pendingOpponent = null;
let opponentHpBeforeAttack = 100;

const POKEMON_MOVES = {
  // Starters
  1: { name: "Bulbasaur", moves: ["Tackle", "Vine Whip", "Razor Leaf", "Solar Beam"] },
  4: { name: "Charmander", moves: ["Scratch", "Ember", "Flame Burst", "Flamethrower"] },
  7: { name: "Squirtle", moves: ["Tackle", "Water Gun", "Bubble Beam", "Hydro Pump"] },

  // Common
  32: { name: "Nidoran‚ôÇ", moves: ["Poison Sting", "Double Kick", "Horn Attack", "Poison Jab"] },
  37: { name: "Vulpix", moves: ["Ember", "Quick Attack", "Will-O-Wisp", "Flamethrower"] },
  39: { name: "Jigglypuff", moves: ["Sing", "Pound", "Hyper Voice", "Double-Edge"] },
  41: { name: "Zubat", moves: ["Leech Life", "Supersonic", "Wing Attack", "Air Slash"] },
  43: { name: "Oddish", moves: ["Absorb", "Acid", "Poison Powder", "Petal Dance"] },
  48: { name: "Venonat", moves: ["Tackle", "Supersonic", "Psybeam", "Sludge Bomb"] },
  52: { name: "Meowth", moves: ["Scratch", "Bite", "Pay Day", "Night Slash"] },
  58: { name: "Growlithe", moves: ["Bite", "Ember", "Flame Wheel", "Flamethrower"] },
  60: { name: "Poliwag", moves: ["Bubble", "Hypnosis", "Water Gun", "Hydro Pump"] },
  63: { name: "Abra", moves: ["Teleport", "Psychic", "Shadow Ball", "Energy Ball"] },
  69: { name: "Bellsprout", moves: ["Vine Whip", "Acid", "Razor Leaf", "Sludge Bomb"] },
  72: { name: "Tentacool", moves: ["Poison Sting", "Water Gun", "Acid Spray", "Hydro Pump"] },
  74: { name: "Geodude", moves: ["Tackle", "Rock Throw", "Earthquake", "Stone Edge"] },
  77: { name: "Ponyta", moves: ["Tackle", "Ember", "Flame Charge", "Fire Blast"] },
  81: { name: "Magnemite", moves: ["Thunder Shock", "Sonic Boom", "Thunderbolt", "Flash Cannon"] },

  // Pseudo-Legendaries & Powerful Mons
  142: { name: "Aerodactyl", moves: ["Wing Attack", "Ancient Power", "Stone Edge", "Crunch"] },
  149: { name: "Dragonite", moves: ["Dragon Rush", "Hurricane", "Extreme Speed", "Outrage"] },
  248: { name: "Tyranitar", moves: ["Crunch", "Stone Edge", "Earthquake", "Hyper Beam"] },
  306: { name: "Aggron", moves: ["Metal Claw", "Rock Slide", "Heavy Slam", "Earthquake"] },
  330: { name: "Flygon", moves: ["Dragon Claw", "Earthquake", "Dragon Dance", "Draco Meteor"] },
  334: { name: "Altaria", moves: ["Dragon Breath", "Cotton Guard", "Sky Attack", "Moonblast"] },
  373: { name: "Salamence", moves: ["Dragon Claw", "Fly", "Crunch", "Draco Meteor"] },
  376: { name: "Metagross", moves: ["Meteor Mash", "Psychic", "Hammer Arm", "Earthquake"] },
  445: { name: "Garchomp", moves: ["Dragon Claw", "Earthquake", "Swords Dance", "Draco Meteor"] },
  635: { name: "Hydreigon", moves: ["Crunch", "Dragon Pulse", "Dark Pulse", "Draco Meteor"] },
  262: { name: "Mightyena", moves: ["Crunch", "Sucker Punch", "Play Rough", "Thunder Fang"] },
  282: { name: "Gardevoir", moves: ["Psychic", "Moonblast", "Shadow Ball", "Thunderbolt"] },
  354: { name: "Banette", moves: ["Shadow Sneak", "Shadow Ball", "Will-O-Wisp", "Gunk Shot"] },
  359: { name: "Absol", moves: ["Night Slash", "Psycho Cut", "Sucker Punch", "Megahorn"] },
  428: { name: "Lopunny", moves: ["Return", "Jump Kick", "Healing Wish", "Mirror Coat"] },
  448: { name: "Lucario", moves: ["Aura Sphere", "Close Combat", "Extreme Speed", "Meteor Mash"] },
  460: { name: "Abomasnow", moves: ["Wood Hammer", "Ice Punch", "Earthquake", "Blizzard"] },
  461: { name: "Weavile", moves: ["Night Slash", "Ice Punch", "Brick Break", "Swords Dance"] },
  468: { name: "Togekiss", moves: ["Air Slash", "Aura Sphere", "Extreme Speed", "Moonblast"] },
  475: { name: "Gallade", moves: ["Close Combat", "Psycho Cut", "Night Slash", "Leaf Blade"] },

  // Legendaries & Mythicals
  144: { name: "Articuno", moves: ["Ice Beam", "Blizzard", "Hurricane", "Ancient Power"] },
  145: { name: "Zapdos", moves: ["Thunderbolt", "Thunder", "Drill Peck", "Ancient Power"] },
  146: { name: "Moltres", moves: ["Flamethrower", "Fire Blast", "Air Slash", "Sky Attack"] },
  150: { name: "Mewtwo", moves: ["Psystrike", "Aura Sphere", "Shadow Ball", "Recover"] },
  151: { name: "Mew", moves: ["Psychic", "Aura Sphere", "Nasty Plot", "Transform"] },
  243: { name: "Raikou", moves: ["Thunderbolt", "Extreme Speed", "Crunch", "Calm Mind"] },
  244: { name: "Entei", moves: ["Sacred Fire", "Extreme Speed", "Stone Edge", "Crunch"] },
  245: { name: "Suicune", moves: ["Hydro Pump", "Ice Beam", "Calm Mind", "Aurora Beam"] },
  249: { name: "Lugia", moves: ["Aeroblast", "Hydro Pump", "Psychic", "Recover"] },
  250: { name: "Ho-Oh", moves: ["Sacred Fire", "Brave Bird", "Recover", "Earth Power"] },
  377: { name: "Regirock", moves: ["Stone Edge", "Hammer Arm", "Earthquake", "Superpower"] },
  378: { name: "Regice", moves: ["Ice Beam", "Thunderbolt", "Focus Blast", "Ancient Power"] },
  379: { name: "Registeel", moves: ["Flash Cannon", "Hammer Arm", "Earthquake", "Curse"] },
  380: { name: "Latias", moves: ["Dragon Pulse", "Psychic", "Mist Ball", "Recover"] },
  381: { name: "Latios", moves: ["Luster Purge", "Dragon Pulse", "Psychic", "Recover"] },
  382: { name: "Kyogre", moves: ["Origin Pulse", "Water Spout", "Thunder", "Ice Beam"] },
  383: { name: "Groudon", moves: ["Precipice Blades", "Earthquake", "Fire Blast", "Solar Beam"] },
  384: { name: "Rayquaza", moves: ["Dragon Ascent", "Draco Meteor", "Extreme Speed", "Earthquake"] },
  385: { name: "Jirachi", moves: ["Wish", "Psychic", "Meteor Mash", "Doom Desire"] },
  386: { name: "Deoxys", moves: ["Psycho Boost", "Dark Pulse", "Superpower", "Extreme Speed"] },
  480: { name: "Uxie", moves: ["Extrasensory", "Future Sight", "Yawn", "Amnesia"] },
  481: { name: "Mesprit", moves: ["Extrasensory", "Future Sight", "Healing Wish", "Lucky Chant"] },
  482: { name: "Azelf", moves: ["Extrasensory", "Future Sight", "Nasty Plot", "U-turn"] },
  483: { name: "Dialga", moves: ["Roar of Time", "Flash Cannon", "Aura Sphere", "Earth Power"] },
  484: { name: "Palkia", moves: ["Spacial Rend", "Hydro Pump", "Aura Sphere", "Draco Meteor"] },
  485: { name: "Heatran", moves: ["Magma Storm", "Earth Power", "Flash Cannon", "Dark Pulse"] },
  486: { name: "Regigigas", moves: ["Giga Impact", "Crush Grip", "Heavy Slam", "Earthquake"] },
  487: { name: "Giratina", moves: ["Shadow Force", "Dragon Claw", "Aura Sphere", "Shadow Ball"] },
  488: { name: "Cresselia", moves: ["Psychic", "Moonblast", "Lunar Blessing", "Future Sight"] },
  489: { name: "Phione", moves: ["Bubble Beam", "Acid Armor", "Rain Dance", "Water Pulse"] },
  490: { name: "Manaphy", moves: ["Tail Glow", "Surf", "Ice Beam", "Psychic"] },
  491: { name: "Darkrai", moves: ["Dark Pulse", "Dark Void", "Dream Eater", "Nasty Plot"] },
  492: { name: "Shaymin", moves: ["Seed Flare", "Air Slash", "Energy Ball", "Synthesis"] },
  493: { name: "Arceus", moves: ["Judgment", "Extreme Speed", "Recover", "Hyper Voice"] },
  494: { name: "Victini", moves: ["V-create", "Searing Shot", "Fusion Bolt", "Fusion Flare"] },
  638: { name: "Cobalion", moves: ["Sacred Sword", "Close Combat", "Iron Head", "Stone Edge"] },
  639: { name: "Terrakion", moves: ["Sacred Sword", "Close Combat", "Stone Edge", "Earthquake"] },
  640: { name: "Virizion", moves: ["Sacred Sword", "Close Combat", "Giga Drain", "Leaf Blade"] },
  641: { name: "Tornadus", moves: ["Hurricane", "Air Slash", "Hammer Arm", "U-turn"] },
  642: { name: "Thundurus", moves: ["Thunder", "Focus Blast", "Nasty Plot", "Dark Pulse"] },
  645: { name: "Landorus", moves: ["Earth Power", "Stone Edge", "Fly", "Superpower"] },
  646: { name: "Kyurem", moves: ["Glaciate", "Dragon Pulse", "Ice Beam", "Draco Meteor"] },
  647: { name: "Keldeo", moves: ["Sacred Sword", "Hydro Pump", "Aqua Jet", "Close Combat"] },
  648: { name: "Meloetta", moves: ["Hyper Voice", "Close Combat", "Psychic", "Focus Blast"] },
  649: { name: "Genesect", moves: ["Techno Blast", "Bug Buzz", "Flash Cannon", "U-turn"] },
  643: { name: "Reshiram", moves: ["Blue Flare", "Dragon Pulse", "Crunch", "Earth Power"] },
  644: { name: "Zekrom", moves: ["Bolt Strike", "Dragon Claw", "Crunch", "Outrage"] },
  495: { name: "Celebi", moves: ["Magical Leaf", "Future Sight", "Recover", "Healing Wish"] }
};

const MOVE_TYPES = {
  // Normal
  "Tackle":"normal","Quick Attack":"normal","Scratch":"normal","Pound":"normal",
  "Body Slam":"normal","Hyper Beam":"normal","Giga Impact":"normal","Extreme Speed":"normal",
  "Skull Bash":"normal","Dynamic Punch":"normal","Cross Chop":"normal",

  // Fire
  "Ember":"fire","Flamethrower":"fire","Fire Blast":"fire","Fire Fang":"fire",
  "Flame Wheel":"fire","Fire Punch":"fire","Blaze Kick":"fire","Eruption":"fire",
  "Sacred Fire":"fire","Blue Flare":"fire","Fusion Flare":"fire","Fire Spin":"fire",

  // Water
  "Water Gun":"water","Bubble":"water","Bubble Beam":"water","Hydro Pump":"water",
  "Water Pulse":"water","Waterfall":"water","Razor Shell":"water","Spacial Rend":"water",

  // Electric
  "Thunder Shock":"electric","Thunderbolt":"electric","Thunder":"electric",
  "Bolt Strike":"electric",

  // Grass
  "Vine Whip":"grass","Razor Leaf":"grass","Solar Beam":"grass","Magical Leaf":"grass",
  "Leaf Blade":"grass","Giga Drain":"grass","Leaf Storm":"grass","Wood Hammer":"grass",
  "Petal Dance":"grass","Energy Ball":"grass",

  // Ice
  "Ice Beam":"ice","Blizzard":"ice","Glaciate":"ice",

  // Fighting
  "Brick Break":"fighting","Focus Blast":"fighting","Aura Sphere":"fighting",
  "Sky Uppercut":"fighting","Bulk Up":"fighting",

  // Poison
  "Sludge Bomb":"poison","Lick":"ghost",

  // Ground
  "Earthquake":"ground","Mud Bomb":"ground","Earth Power":"ground",

  // Flying
  "Wing Attack":"flying","Air Slash":"flying","Hurricane":"flying","Drill Peck":"flying",
  "Brave Bird":"flying","Aeroblast":"flying","Sky Attack":"flying",

  // Psychic
  "Psychic":"psychic","Psystrike":"psychic","Future Sight":"psychic",

  // Ghost
  "Shadow Ball":"ghost","Destiny Bond":"ghost","Shadow Force":"ghost",

  // Dragon
  "Dragon Rage":"dragon","Dragon Claw":"dragon","Outrage":"dragon","Dragon Rush":"dragon",
  "Dragon Pulse":"dragon","Draco Meteor":"dragon","Roar of Time":"dragon",

  // Dark
  "Crunch":"dark",

  // Steel
  "Flash Cannon":"steel",

  // Rock
  "Ancient Power":"rock","Stone Edge":"rock",

  // Default fallback
  "default": "normal"
};

const FALLBACK_MOVES = ["Tackle", "Quick Attack", "Thunderbolt", "Flamethrower", "Hydro Pump", "Solar Beam", "Psychic", "Shadow Ball", "Hyper Beam", "Giga Impact"];

function getMovesForPokemon(id) {
  const pokemon = POKEMON_MOVES[id];
  if (pokemon && pokemon.moves && pokemon.moves.length === 4) {
    return pokemon.moves;
  }
  const fallback = ["Tackle", "Quick Attack", "Hyper Beam", "Giga Impact"];
  console.warn(`No moves defined for Pok√©mon ID ${id}, using fallback`);
  return fallback;
}

// ==================== IMAGE HELPERS ====================
function img(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }
function backImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/${id}.gif`; }
function frontImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`; }

// ==================== LOG & WALLET  ====================
function log(msg) {
  const el = document.getElementById('battleLog');
  el.innerHTML += `<div>${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

document.getElementById('connectBtn').onclick = async () => {
  if (!window.ethereum) return alert('Install MetaMask!');
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa36a7' }] });
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
    document.getElementById('walletDisplay').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
    document.getElementById('connectBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline-block';
    log('Wallet connected!');
  } catch (e) { alert('Connection failed'); }
};

document.getElementById('logoutBtn').onclick = () => location.reload();

function createEarthquakeCrack(x1, y1, x2, y2) {
  for (let i = 0; i < 12; i++) {
    const crack = document.createElement('div');
    crack.style.position = 'absolute';
    crack.style.width = '6px';
    crack.style.height = (80 + Math.random() * 120) + 'px';
    crack.style.background = '#8B4513';
    crack.style.boxShadow = '0 0 20px #654321';
    crack.style.left = (x2 + (Math.random() - 0.5) * 300) + 'px';
    crack.style.top = y2 + 'px';
    crack.style.transform = `rotate(${Math.random() * 360}deg)`;
    document.getElementById('attackContainer').appendChild(crack);
    crack.animate([
      { transform: 'translateY(0) scale(0)', opacity: 1 },
      { transform: 'translateY(-200px) scale(1.5)', opacity: 0 }
    ], { duration: 1200, delay: i * 80 }).onfinish = () => crack.remove();
  }
  // Ground shake
  document.getElementById('battleArea').classList.add('shake');
  setTimeout(() => document.getElementById('battleArea').classList.remove('shake'), 800);
}

function createIceExplosion(x, y) {
  const exp = document.createElement('div');
  exp.className = 'fire-explosion';
  exp.style.left = (x-120)+'px'; exp.style.top = (y-120)+'px';
  exp.style.background = 'radial-gradient(circle, #00ffff 10%, #88eeee 50%, transparent 80%)';
  exp.style.boxShadow = '0 0 80px #00ffff';
  document.getElementById('attackContainer').appendChild(exp);
  exp.animate([{transform:'scale(0)',opacity:1},{transform:'scale(4)',opacity:0}], {duration:900}).onfinish = () => exp.remove();
}

function createConfusionSwirl(x, y) {
  const swirl = document.createElement('div');
  swirl.style.position = 'absolute';
  swirl.style.width = '300px'; swirl.style.height = '300px';
  swirl.style.background = 'conic-gradient(from 0deg, #ff00ff, #00ffff, #ff00ff)';
  swirl.style.borderRadius = '50%';
  swirl.style.left = (x-150)+'px'; swirl.style.top = (y-150)+'px';
  swirl.style.opacity = '0.7';
  document.getElementById('attackContainer').appendChild(swirl);
  swirl.animate([
    { transform: 'rotate(0deg) scale(0.3)', opacity: 0 },
    { transform: 'rotate(720deg) scale(2)', opacity: 0.9 },
    { opacity: 0 }
  ], { duration: 1400 }).onfinish = () => swirl.remove();
}

function createFightingPunch(x1, y1, x2, y2) {
  const fist = document.createElement('div');
  fist.style.position = 'absolute';
  fist.style.width = '100px'; fist.style.height = '100px';
  fist.style.background = 'radial-gradient(circle, #ff4500, #ff8c00)';
  fist.style.borderRadius = '50%';
  fist.style.left = x1 + 'px'; fist.style.top = y1 + 'px';
  fist.style.boxShadow = '0 0 40px orange';
  document.getElementById('attackContainer').appendChild(fist);
  fist.animate([
    { transform: 'scale(0.6)', opacity: 1 },
    { transform: `translate(${x2-x1}px,${y2-y1}px) scale(2.5)`, opacity: 0 }
  ], { duration: 600 }).onfinish = () => fist.remove();
}

function createRockThrow(x1, y1, x2, y2) {
  for (let i = 0; i < 8; i++) {
    const rock = document.createElement('div');
    rock.style.position = 'absolute';
    rock.style.width = (30 + Math.random()*40)+'px';
    rock.style.height = rock.style.width;
    rock.style.background = '#8B7355';
    rock.style.borderRadius = '30%';
    rock.style.left = x1 + 'px'; rock.style.top = y1 + 'px';
    document.getElementById('attackContainer').appendChild(rock);
    const angle = Math.atan2(y2-y1, x2-x1) + (Math.random()-0.5)*0.8;
    const dist = Math.hypot(x2-x1, y2-y1) + Math.random()*100;
    rock.animate([
      { transform: 'translate(0,0) rotate(0deg)' },
      { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) rotate(1080deg)` }
    ], { duration: 1000 }).onfinish = () => rock.remove();
  }
}

function createGustWind(x1, y1, x2, y2) {
  for (let i = 0; i < 20; i++) {
    const gust = document.createElement('div');
    gust.style.position = 'absolute';
    gust.style.width = '80px';
    gust.style.height = '20px';
    gust.style.background = 'rgba(255,255,255,0.6)';
    gust.style.borderRadius = '50%';
    gust.style.left = x1 + 'px'; gust.style.top = (y1 + (i-10)*20) + 'px';
    gust.style.filter = 'blur(4px)';
    document.getElementById('attackContainer').appendChild(gust);
    gust.animate([
      { transform: 'translateX(0)', opacity: 0.8 },
      { transform: `translateX(${x2-x1 + 400}px)`, opacity: 0 }
    ], { duration: 800, delay: i*40 }).onfinish = () => gust.remove();
  }
}

function createPoisonGas(x1, y1, x2, y2) {
  for (let i = 0; i < 15; i++) {
    const cloud = document.createElement('div');
    cloud.style.position = 'absolute';
    cloud.style.width = (60 + Math.random()*80)+'px';
    cloud.style.height = cloud.style.width;
    cloud.style.background = 'radial-gradient(circle, #9932cc, #800080)';
    cloud.style.borderRadius = '50%';
    cloud.style.left = (x2 + (Math.random()-0.5)*300) + 'px';
    cloud.style.top = (y2 + (Math.random()-0.5)*300) + 'px';
    cloud.style.opacity = '0.7';
    document.getElementById('attackContainer').appendChild(cloud);
    cloud.animate([
      { transform: 'scale(0)', opacity: 0 },
      { transform: 'scale(2)', opacity: 0.7 },
      { opacity: 0 }
    ], { duration: 1600, delay: i*100 }).onfinish = () => cloud.remove();
  }
}

function createMetalClaw(x1, y1, x2, y2) {
  const claw = document.createElement('div');
  claw.style.position = 'absolute';
  claw.style.width = '120px'; claw.style.height = '40px';
  claw.style.background = 'linear-gradient(45deg, #ccc, #fff, #aaa)';
  claw.style.clipPath = 'polygon(0% 0%, 100% 50%, 0% 100%)';
  claw.style.left = x1 + 'px'; claw.style.top = y1 + 'px';
  claw.style.boxShadow = '0 0 30px silver';
  document.getElementById('attackContainer').appendChild(claw);
  claw.animate([
    { transform: 'rotate(0) scale(0.6)' },
    { transform: `translate(${x2-x1}px,${y2-y1}px) rotate(360deg) scale(2)` }
  ], { duration: 700 }).onfinish = () => claw.remove();
}
function playAttackAnimation(isPlayerAttacker, moveName, isMiss = false) {
  const container = document.getElementById('attackContainer');
  const attacker = isPlayerAttacker ? document.getElementById('playerImg') : document.getElementById('oppoImg');
  const target = isPlayerAttacker ? document.getElementById('oppoImg') : document.getElementById('playerImg');
  const attackerRect = attacker.getBoundingClientRect();
  const targetRect = target.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  const startX = attackerRect.left + attackerRect.width / 2 - containerRect.left;
  const startY = attackerRect.top + attackerRect.height / 2 - containerRect.top;
  let endX = targetRect.left + targetRect.width / 2 - containerRect.left;
  let endY = targetRect.top + targetRect.height / 2 - containerRect.top;

  if (isMiss) {
    target.classList.add('dodge-jump');
    setTimeout(() => target.classList.remove('dodge-jump'), 900);
    endX += (Math.random() > 0.5 ? 320 : -320);
    endY -= 180;
  }

  const attackerId = isPlayerAttacker ? myPokemon?.id : opponentPokemon?.id;
  const moveKey = moveName.toUpperCase();

  // === MEGA SIGNATURE MOVE OVERRIDES (Per Pok√©mon + Move) ===
  if (!isMiss) {
    // STARTERS
    if (attackerId === 1 && moveKey.includes("SOLAR BEAM")) return createSolarBeam(startX, startY, endX, endY);
    if (attackerId === 4 && moveKey.includes("FLAMETHROWER")) return createFlamethrower(startX, startY, endX, endY);
    if (attackerId === 7 && moveKey.includes("HYDRO PUMP")) return createHydroPump(startX, startY, endX, endY);

    // LEGENDARY BIRDS
    if (attackerId === 144 && moveKey.includes("BLIZZARD")) return createBlizzardArticuno(startX, startY, endX, endY);
    if (attackerId === 145 && moveKey.includes("THUNDER")) return createThunderZapdos(startX, startY, endX, endY);
    if (attackerId === 146 && moveKey.includes("SKY ATTACK")) return createSkyAttackMoltres(startX, startY, endX, endY);

    // MEW & MEWTWO
    if (attackerId === 150 && moveKey.includes("PSYSTRIKE")) return createPsystrike(startX, startY, endX, endY);
    if (attackerId === 151 && moveKey.includes("TRANSFORM")) return createTransformMew(startX, startY);

    // DRAGONITE & SALAMENCE
    if (attackerId === 149 && moveKey.includes("OUTRAGE")) return createOutrage(startX, startY, endX, endY);
    if (attackerId === 373 && moveKey.includes("DRACO METEOR")) return createDracoMeteor(startX, startY, endX, endY);

    // KYOGRE / GROUDON / RAYQUAZA
    if (attackerId === 382 && moveKey.includes("ORIGIN PULSE")) return createOriginPulse(startX, startY, endX, endY);
    if (attackerId === 383 && moveKey.includes("PRECIPICE BLADES")) return createPrecipiceBlades(startX, startY, endX, endY);
    if (attackerId === 384 && moveKey.includes("DRAGON ASCENT")) return createDragonAscent(startX, startY, endX, endY);

    // DIALGA / PALKIA / GIRATINA
    if (attackerId === 483 && moveKey.includes("ROAR OF TIME")) return createRoarOfTime(startX, startY, endX, endY);
    if (attackerId === 484 && moveKey.includes("SPACIAL REND")) return createSpacialRend(startX, startY, endX, endY);
    if (attackerId === 487 && moveKey.includes("SHADOW FORCE")) return createShadowForce(attacker, startX, startY, endX, endY);

    // ARCEUS
    if (attackerId === 493 && moveKey.includes("JUDGMENT")) return createJudgment(startX, startY, endX, endY);

    // RESHIRAM / ZEKROM
    if (attackerId === 643 && moveKey.includes("BLUE FLARE")) return createBlueFlare(startX, startY, endX, endY);
    if (attackerId === 644 && moveKey.includes("BOLT STRIKE")) return createBoltStrike(attacker, startX, startY, endX, endY);

    // LUGIA / HO-OH
    if (attackerId === 249 && moveKey.includes("AEROBLAST")) return createAeroblast(startX, startY, endX, endY);
    if (attackerId === 250 && moveKey.includes("SACRED FIRE")) return createSacredFire(startX, startY, endX, endY);

    // GARCHOMP
    if (attackerId === 445 && moveKey.includes("DRACO METEOR")) return createDracoMeteor(startX, startY, endX, endY);

    // LUCARIO
    if (attackerId === 448 && moveKey.includes("AURA SPHERE")) return createAuraSphere(startX, startY, endX, endY);

    // GARDEVOIR
    if (attackerId === 282 && moveKey.includes("MOONBLAST")) return createMoonblast(startX, startY, endX, endY);
  }

  // === FALLBACK TO TYPE SYSTEM IF NO SIGNATURE ===
  const type = (MOVE_TYPES[moveName] || "normal").toLowerCase();
  if (type === "fire") { createBeam(startX, startY, endX, endY, "linear-gradient(90deg,transparent,#fff,#ff1744,#ff9800,transparent)", "0 0 50px #ff4500"); setTimeout(() => createExplosion(endX, endY, "#ff4500", "#ff9800"), 600); }
  else if (type === "water") { for(let i=0;i<15;i++) setTimeout(()=>createWaterWave(startX,startY,endX,endY,i),i*50); }
  else if (type === "electric") { for(let i=0;i<12;i++) setTimeout(()=>createLightning(startX,startY,endX,endY),i*70); }
  else if (type === "grass") { for(let i=0;i<10;i++) setTimeout(()=>createLeafBlade(startX,startY,endX,endY),i*90); }
  else if (type === "ice") { createIceShards(startX,startY,endX,endY); setTimeout(()=>createIceExplosion(endX,endY),800); }
  else if (type === "psychic") { createPsychicWave(startX,startY,endX,endY); setTimeout(()=>createConfusionSwirl(endX,endY),700); }
  else if (type === "dragon") { createDragonPulse(startX,startY,endX,endY); }
  else if (type === "dark" || type === "ghost") { createShadowBall(startX,startY,endX,endY); }
  else if (type === "fighting") { createFightingPunch(startX,startY,endX,endY); }
  else if (type === "rock") { createRockThrow(startX,startY,endX,endY); }
  else if (type === "flying") { createGustWind(startX,startY,endX,endY); }
  else if (type === "poison") { createPoisonGas(startX,startY,endX,endY); }
  else if (type === "ground") { createEarthquakeCrack(startX,startY,endX,endY); }
  else if (type === "steel") { createMetalClaw(startX,startY,endX,endY); }
  else { createNormalTackle(startX,startY,endX,endY); }

  if (!isMiss) {
    setTimeout(() => {
      createHitFlash(endX, endY);
      document.getElementById('battleArea').classList.add('shake');
      setTimeout(() => document.getElementById('battleArea').classList.remove('shake'), 600);
    }, 700);
  }
}

// === REUSABLE ANIMATION HELPERS ===
function createBeam(x1, y1, x2, y2, gradient, shadow) {
  const el = document.createElement('div');
  el.className = 'beam-line';
  el.style.left = x1 + 'px';
  el.style.top = y1 + 'px';
  el.style.width = Math.hypot(x2-x1, y2-y1) + 'px';
  el.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1)}rad)`;
  el.style.background = gradient;
  el.style.boxShadow = shadow;
  document.getElementById('attackContainer').appendChild(el);
  el.animate([{opacity:0},{opacity:1,offset:0.3},{opacity:0}], {duration:900}).onfinish = () => el.remove();
}

function createExplosion(x, y, color1, color2) {
  const exp = document.createElement('div');
  exp.className = 'fire-explosion';
  exp.style.left = (x-100)+'px'; exp.style.top = (y-100)+'px';
  exp.style.background = `radial-gradient(circle, ${color1} 15%, ${color2} 50%, transparent 80%)`;
  document.getElementById('attackContainer').appendChild(exp);
  exp.animate([{transform:'scale(0)',opacity:1},{transform:'scale(3)',opacity:0}], {duration:800}).onfinish = () => exp.remove();
}

function createLightning(x1, y1, x2, y2) {
  const bolt = document.createElement('div');
  bolt.className = 'lightning-bolt';
  bolt.style.left = x1 + 'px';
  bolt.style.top = y1 + 'px';
  bolt.style.height = Math.hypot(x2-x1, y2-y1) + 'px';
  bolt.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1) + (Math.random()-0.5)*0.6}rad)`;
  document.getElementById('attackContainer').appendChild(bolt);
  bolt.animate([{opacity:1, transform: bolt.style.transform},{opacity:0}], {duration:700}).onfinish = () => bolt.remove();
}

function createWaterWave(x1, y1, x2, y2, i) {
  const wave = document.createElement('div');
  wave.className = 'water-wave';
  wave.style.left = x1 + 'px';
  wave.style.top = y1 + 'px';
  wave.style.width = (60 + i*25) + 'px';
  document.getElementById('attackContainer').appendChild(wave);
  wave.animate([
    {transform:'scale(0.2)', opacity:0.9},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2)`, opacity:0}
  ], {duration:1000}).onfinish = () => wave.remove();
}

function createLeafBlade(x1, y1, x2, y2) {
  const leaf = document.createElement('div');
  leaf.className = 'leaf-blade';
  leaf.style.left = x1 + 'px'; leaf.style.top = y1 + 'px';
  document.getElementById('attackContainer').appendChild(leaf);
  leaf.animate([
    {transform:'rotate(0deg) scale(0.5)', opacity:1},
    {transform:`translate(${x2-x1}px,${y2-y1}px) rotate(1080deg) scale(1.5)`, opacity:0}
  ], {duration:1100}).onfinish = () => leaf.remove();
}

function createIceShards(x1, y1, x2, y2) {
  for (let i = 0; i < 8; i++) {
    const shard = document.createElement('div');
    shard.style.position = 'absolute';
    shard.style.width = '16px'; shard.style.height = '60px';
    shard.style.background = 'linear-gradient(45deg, #88eeee, #00ffff)';
    shard.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
    shard.style.left = x1 + 'px'; shard.style.top = y1 + 'px';
    shard.style.boxShadow = '0 0 20px #00ffff';
    document.getElementById('attackContainer').appendChild(shard);
    const angle = Math.atan2(y2-y1, x2-x1) + (Math.random()-0.5)*1;
    const dist = Math.hypot(x2-x1, y2-y1);
    shard.animate([
      {transform:'translate(0,0) rotate(0deg)'},
      {transform:`translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) rotate(720deg)`}
    ], {duration:1000, easing:'cubic-bezier(0.2,0.8,0.2,1)'}).onfinish = () => shard.remove();
  }
}

function createPsychicWave(x1, y1, x2, y2) {
  const wave = document.createElement('div');
  wave.style.position = 'absolute';
  wave.style.width = '200px'; wave.style.height = '200px';
  wave.style.border = '8px solid transparent';
  wave.style.borderRadius = '50%';
  wave.style.borderColor = '#ff00ff transparent #00ffff transparent';
  wave.style.left = (x1-100)+'px'; wave.style.top = (y1-100)+'px';
  wave.style.boxShadow = '0 0 60px #ff00ff';
  document.getElementById('attackContainer').appendChild(wave);
  wave.animate([
    {transform:'scale(0.3) rotate(0deg)', opacity:0},
    {transform:'scale(2.5) rotate(360deg)', opacity:1, offset:0.6},
    {opacity:0}
  ], {duration:1200}).onfinish = () => wave.remove();
}

function createShadowBall(x1, y1, x2, y2) {
  const ball = document.createElement('div');
  ball.style.position = 'absolute';
  ball.style.width = '80px'; ball.style.height = '80px';
  ball.style.background = 'radial-gradient(circle at 30% 30%, #222, #000)';
  ball.style.border = '4px solid #9900ff';
  ball.style.borderRadius = '50%';
  ball.style.left = (x1-40)+'px'; ball.style.top = (y1-40)+'px';
  ball.style.boxShadow = '0 0 60px #9900ff, inset 0 0 40px #000';
  document.getElementById('attackContainer').appendChild(ball);
  ball.animate([
    {transform:'translate(0,0) scale(0.5)'},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2.5)`}
  ], {duration:900}).onfinish = () => {
    ball.remove();
    createHitFlash(x2, y2, '#9900ff');
  };
}

function createDragonPulse(x1, y1, x2, y2) {
  createBeam(x1, y1, x2, y2, "linear-gradient(90deg,transparent,#00ffff,#0066ff,#00ffff,transparent)", "0 0 60px #00ffff");
  setTimeout(() => createExplosion(x2, y2, "#0066ff", "#00ffff"), 700);
}

function createHitFlash(x, y, color = "#ffffff") {
  const flash = document.createElement('div');
  flash.className = 'hit-flash';
  flash.style.left = (x-120)+'px'; flash.style.top = (y-120)+'px';
  flash.style.background = `radial-gradient(circle, ${color} 10%, transparent 70%)`;
  document.getElementById('attackContainer').appendChild(flash);
  flash.animate([{opacity:0},{opacity:1},{opacity:0}], {duration:500}).onfinish = () => flash.remove();
}

function createNormalTackle(x1, y1, x2, y2) {
  const tackle = document.createElement('div');
  tackle.className = 'normal-tackle';
  tackle.style.left = x1 + 'px'; tackle.style.top = y1 + 'px';
  document.getElementById('attackContainer').appendChild(tackle);
  tackle.animate([
    {transform:'scale(0.4)', opacity:0},
    {transform:`translate(${x2-x1}px,${y2-y1}px) scale(2.2)`, opacity:0.9},
    {opacity:0}
  ], {duration:800}).onfinish = () => tackle.remove();
}

// === STARTER SIGNATURES ===
function createSolarBeam(x1,y1,x2,y2) {
  const beam = document.createElement('div');
  beam.style.position='absolute'; beam.style.width='100px'; beam.style.height='1200px';
  beam.style.background='linear-gradient(90deg,transparent,#ffff00,#00ff00,#ffff00,transparent)';
  beam.style.left=x1+'px'; beam.style.top=(y1-600)+'px';
  beam.style.boxShadow='0 0 120px #ffff00';
  document.getElementById('attackContainer').appendChild(beam);
  beam.animate([{transform:'scaleY(0)'},{transform:'scaleY(1)'}],{duration:1400}).onfinish=()=>{beam.remove();createExplosion(x2,y2,"#ffff00","#00ff00");};
}

function createFlamethrower(x1,y1,x2,y2) {
  for(let i=0;i<20;i++) setTimeout(()=>{createBeam(x1,y1,x2,y2,"linear-gradient(90deg,transparent,#ff4500,#ffff00,transparent)","0 0 80px #ffff00");},i*80);
}

function createHydroPump(x1,y1,x2,y2) {
  for(let i=0;i<12;i++) setTimeout(()=>{const w=document.createElement('div');w.className='water-wave';w.style.width=(200+i*40)+'px';w.style.left=x1+'px';w.style.top=y1+'px';document.getElementById('attackContainer').appendChild(w);w.animate([{transform:'scale(0.2)'},{transform:`translate(${x2-x1}px,${y2-y1}px) scale(3)`}],{duration:1000}).onfinish(()=>w.remove());},i*100);
}

// === LEGENDARY BIRDS ===
function createBlizzardArticuno(x1,y1,x2,y2) {
  document.body.style.filter='brightness(1.8)'; setTimeout(()=>document.body.style.filter='',400);
  for(let i=0;i<30;i++) setTimeout(()=>createIceShards(x1+Math.random()*200-100,y1,x2,y2),i*60);
}

function createThunderZapdos(x1,y1,x2,y2) {
  attacker.style.filter='brightness(4)'; setTimeout(()=>attacker.style.filter='',500);
  for(let i=0;i<25;i++) setTimeout(()=>createLightning(x1,y1,x2,y2),i*50);
}

function createSkyAttackMoltres(x1,y1,x2,y2) {
  attacker.style.opacity='0'; setTimeout(()=>{attacker.style.opacity='1'; createExplosion(x2,y2,"#ff4500","#ffff00");},800);
}

// === MEW & TRANSFORM ===
function createTransformMew(x1,y1) {
  attacker.style.filter='hue-rotate(0deg)'; let deg=0;
  const int=setInterval(()=>{deg+=30; attacker.style.filter=`hue-rotate(${deg}deg) brightness(2)`;},100);
  setTimeout(()=>{clearInterval(int); attacker.style.filter='';},2000);
}

// === DRAGON RAGE ===
function createOutrage(x1,y1,x2,y2) {
  attacker.classList.add('shake');
  for(let i=0;i<8;i++) setTimeout(()=>createDragonPulse(x1,y1,x2,y2),i*200);
  setTimeout(()=>attacker.classList.remove('shake'),2000);
}

// === AURA SPHERE & MOONBLAST ===
function createAuraSphere(x1,y1,x2,y2) {
  const sphere=document.createElement('div');
  sphere.style.position='absolute'; sphere.style.width='160px'; sphere.style.height='160px';
  sphere.style.background='radial-gradient(circle,#00ccff 20%,#0066ff 80%)';
  sphere.style.border='8px solid #00ccff'; sphere.style.borderRadius='50%';
  sphere.style.left=(x1-80)+'px'; sphere.style.top=(y1-80)+'px';
  sphere.style.boxShadow='0 0 100px #00ccff';
  document.getElementById('attackContainer').appendChild(sphere);
  sphere.animate([{transform:'scale(0.3)'},{transform:`translate(${x2-x1}px,${y2-y1}px) scale(2.5)`}],{duration:900}).onfinish(()=>{sphere.remove();createHitFlash(x2,y2,'#00ccff');});
}

function createMoonblast(x1,y1,x2,y2) {
  const moon=document.createElement('div');
  moon.style.position='absolute'; moon.style.width='300px'; moon.style.height='300px';
  moon.style.background='radial-gradient(circle,#ff99cc 30%,#ff66cc 70%)';
  moon.style.borderRadius='50%'; moon.style.left=(x2-150)+'px'; moon.style.top=(y2-150)+'px';
  moon.style.boxShadow='0 0 120px #ff66cc';
  document.getElementById('attackContainer').appendChild(moon);
  moon.animate([{transform:'scale(0)',opacity:0},{transform:'scale(1.6)',opacity:1},{opacity:0}],{duration:1600}).onfinish(()=>moon.remove());
}
// ==================== ATTACK LOGIC ====================
function attack() {
  if (!myTurn || !conn || !myPokemon) return;

  const moves = getMovesForPokemon(myPokemon.id);
  const chosenMove = moves[Math.floor(Math.random() * moves.length)];
  const isMiss = Math.random() < 0.2;
  const baseDamage = 15 + Math.floor(Math.random() * 6);
  const damage = isMiss ? 0 : baseDamage;

  let oppHp = parseInt(document.getElementById('oppoHpText').textContent.split('/')[0]);
  opponentHpBeforeAttack = oppHp;
  const newOppHp = Math.max(0, oppHp - damage);

  playAttackAnimation(true, chosenMove, isMiss);

  document.getElementById('oppoHpFill').style.width = newOppHp + '%';
  document.getElementById('oppoHpText').textContent = newOppHp + '/100 HP';
  document.getElementById('oppoHpFill').classList.remove('warning', 'danger');
  if (newOppHp <= 50 && newOppHp > 20) document.getElementById('oppoHpFill').classList.add('warning');
  if (newOppHp <= 20) document.getElementById('oppoHpFill').classList.add('danger');

  if (isMiss) {
    log(`<b>${myPokemon.name.toUpperCase()}</b> used <b>${chosenMove}</b>...<br><b style="color:#ff9800">MISSED!</b>`);
  } else {
    log(`<b>${myPokemon.name.toUpperCase()}</b> used <b style="color:#ffeb3b">${chosenMove}</b>!<br>Dealt <b style="color:#ff4444">${damage}</b> damage!`);
  }

  conn.send({
    type: 'attack',
    moveName: chosenMove,
    damage: damage,
    missed: isMiss,
    opponentNewHp: newOppHp
  });

if (newOppHp <= 0 && !isMiss) {
  conn.send({ 
    type: 'gameOver',
    winner: userAddress,
    loser: opponentAddress
  });

  triggerFaint(false);
  document.getElementById('playerActions').innerHTML = 
    '<div style="color:#4caf50;font-size:3rem;padding:40px">YOU WIN!<br>Awaiting 500 tokens...</div>';
}

  document.getElementById('playerActions').innerHTML = '<div style="background:rgba(0,0,0,0.7);color:#ccc;padding:20px 40px;border-radius:16px;font-size:1.4rem">Waiting...</div>';
  myTurn = false;
}

// ==================== FIXED RECEIVE ATTACK ====================
function receiveAttack(data) {
  const damage = data.damage || 0;
  const missed = data.missed || false;
  const moveName = data.moveName;

  playAttackAnimation(false, moveName, missed);

  if (missed) {
    log(`Opponent used <b>${moveName}</b> ‚Üí <span style="color:#4caf50">MISSED!</span>`);
    myTurn = true;
    showAttackButton();
    return;
  }

  // Wild Shield (15% chance)
  if (Math.random() < 0.15) {
    log('<span style="color:#ffeb3b;font-size:3.2rem;text-shadow:0 0 40px gold">WILD SHIELD ACTIVATED!</span>');
    showWildShieldEffect(true);
    conn.send({ type: 'shield' });
    myTurn = true;
    showAttackButton();
    return;
  }

  log(`Opponent used <b style="color:#ffeb3b">${moveName}</b> ‚Üí <b style="color:#ff4444">${damage} damage!</b>`);

  const newHp = data.opponentNewHp;
  document.getElementById('playerHpFill').style.width = newHp + '%';
  document.getElementById('playerHpText').textContent = newHp + '/100 HP';
  if (newHp <= 50 && newHp > 20) document.getElementById('playerHpFill').classList.add('warning');
  if (newHp <= 20) document.getElementById('playerHpFill').classList.add('danger');

  // Only pay when we receive official 'gameOver' message from winner
  if (newHp <= 0) {
    log('<span style="color:#ff4444;font-size:3.5rem">YOUR POK√âMON FAINTED!</span>');
    triggerFaint(true);
    document.getElementById('playerActions').innerHTML = 
      '<div style="color:#ff4444;font-size:2.8rem;padding:40px">YOU LOST<br>Waiting for winner confirmation...</div>';
   
  } else {
    myTurn = true;
    showAttackButton();
  }
}

async function forcePayToWinner(winnerAddress) {
  if (!tokenContract || !winnerAddress) {
    log('<span style="color:#ff4444">Wallet not connected!</span>');
    return;
  }

  try {
    const decimals = await tokenContract.decimals();
    const amount = ethers.utils.parseUnits("500", decimals);

    log('<span style="color:#ff9800;font-size:2.2rem">Battle Lost! Paying 500 tokens to winner...</span>');

    // THIS WILL AUTOMATICALLY OPEN METAMASK
    const tx = await tokenContract.transfer(winnerAddress, amount);

    log('<span style="color:#ffeb3b">Transaction sent! Confirming...</span>');
    await tx.wait();

    log('<span style="color:#4caf50;font-size:2.8rem">500 TOKENS SENT TO WINNER!</span>');
    conn?.send({ type: 'paymentSuccess' });

  } catch (err) {
    console.error("Payment rejected:", err);
    log('<span style="color:#ff4444;font-size:2rem">Payment rejected!<br>You kept your tokens.</span>');
    conn?.send({ type: 'paymentFailed' });
  }
}

// === SHOW WILD SHIELD ON ANY PLAYER ===
function showWildShieldEffect(isPlayerDefending) {
  const targetImg = isPlayerDefending ? document.getElementById('playerImg') : document.getElementById('oppoImg');
  const rect = targetImg.getBoundingClientRect();
  const containerRect = document.getElementById('attackContainer').getBoundingClientRect();

  const centerX = rect.left + rect.width / 2 - containerRect.left;
  const centerY = rect.top + rect.height / 2 - containerRect.top;

  // Shield dome
  const shield = document.createElement('div');
  shield.className = 'shield-dome';
  shield.style.left = (centerX - 210) + 'px';
  shield.style.top = (centerY - 260) + 'px';
  document.getElementById('attackContainer').appendChild(shield);

  // PROTECT! text
  const text = document.createElement('div');
  text.className = 'protect-text';
  text.textContent = 'PROTECT!';
  text.style.left = centerX + 'px';
  text.style.top = (centerY - 80) + 'px';
  document.getElementById('attackContainer').appendChild(text);

  // Impact flash (slightly delayed)
  setTimeout(() => {
    const impact = document.createElement('div');
    impact.className = 'shield-impact';
    impact.style.left = (centerX - 250) + 'px';
    impact.style.top = (centerY - 300) + 'px';
    document.getElementById('attackContainer').appendChild(impact);

    // Quick white flash
    document.body.style.background = '#fff';
    targetImg.style.filter = 'brightness(3.5)';
    setTimeout(() => {
      document.body.style.background = '#000';
      targetImg.style.filter = '';
    }, 100);
  }, 500);

  // Cleanup
  setTimeout(() => {
    shield.remove();
    text.remove();
  }, 2800);
}
function triggerFaint(isPlayer) {
  const img = isPlayer ? document.getElementById('playerImg') : document.getElementById('oppoImg');
  img.classList.add('fainted');
  const eyes = document.createElement('div'); eyes.className = 'faint-eyes';
  img.parentNode.appendChild(eyes);
  const swirl = document.createElement('div'); swirl.className = 'faint-swirl';
  document.getElementById('battleArea').appendChild(swirl);

  log(isPlayer 
    ? '<span style="color:#ff4444;font-size:2.8rem">YOUR POK√âMON FAINTED!</span>'
    : '<span style="color:#4caf50;font-size:2.8rem">OPPONENT FAINTED! VICTORY!</span>'
  );
}

function showAttackButton() {
  if (!myTurn) return;
  document.getElementById('playerActions').innerHTML = `<button class="attack-btn" onclick="attack()">ATTACK!</button>`;
}

// ==================== PEERJS & TEAM SELECTION ====================
let ownedLocal = JSON.parse(localStorage.getItem('owned') || '[]');

function createRoom() {
  if (!userAddress) return alert("Connect wallet first!");

  // Generate random 6-character room code (A-Z, 0-9)
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }

  isHost = true;
  peer = new Peer(code, { 
    host: '0.peerjs.com', 
    port: 443, 
    secure: true 
  });

  setupPeerEvents();
  navigator.clipboard.writeText(code).catch(() => {});
  
 
  log(`Room created: <b style="color:#ffcb05">${code}</b>`);
}

function joinRoom() {
  if (!userAddress) return alert("Connect wallet first!");
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!code) return alert("Enter a room code!");
  peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, secure: true });
  setupPeerEvents();
  peer.on('open', () => {
    conn = peer.connect(code);
    setupConnEvents(conn);
   
    log('Joining room...');
  });
}

function setupPeerEvents() {
  peer.on('open', id => {
    document.getElementById('roomStatus').innerHTML = `Room Created!<br><b style="font-size:1.8rem;color:#ffcb05">${id}</b><br>Waiting...`;
    log(`Room ${id} ready`);
  });

  peer.on('connection', incoming => {
   if (conn && conn.open) {
    incoming.close();
    return;
  }
  // New opponent trying to join
  document.getElementById('opponentId').textContent = incoming.peer;
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('confirmModal').style.display = 'block';
  pendingOpponent = incoming;
  });
}

function acceptOpponent() {
  if (!pendingOpponent) return;

  conn = pendingOpponent;
  pendingOpponent = null;

  document.getElementById('overlay').style.display = 'none';
  document.getElementById('confirmModal').style.display = 'none';

  setupConnEvents(conn);

  // Tell the joiner: "We're both in!"
  conn.send({ type: 'matchConfirmed' });

  // BOTH players now go to team selection
  startTeamSelection();
  log('Battle accepted! Choose your Pok√©mon!');
}

function rejectOpponent() {
  if (pendingOpponent) pendingOpponent.close();
  pendingOpponent = null;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('confirmModal').style.display = 'none';
}

function setupConnEvents(c) {
  // Prevent double-setup
  if (c._events && c._events.data) return;

  conn = c;

  conn.on('open', () => {
    log('Connected to opponent!');
    conn.send({ type: 'wallet', address: userAddress });
  });

  conn.on('data', data => {
    console.log('Received:', data); // debug help

    if (data.type === 'wallet') {
      opponentAddress = data.address;
    }

    else if (data.type === 'matchConfirmed') {
  // This message means: "Both players are connected and accepted"
  startTeamSelection();
  log('Connected! Choose your Pok√©mon!');
}

    else if (data.type === 'pokemon') {
      opponentPokemon = data.poke;
      document.getElementById('oppoImg').src = frontImg(opponentPokemon.id) || img(opponentPokemon.id);
      document.getElementById('oppoName').textContent = opponentPokemon.name.toUpperCase();
      document.getElementById('oppoHpText').textContent = '100/100 HP';
      document.getElementById('oppoHpFill').style.width = '100%';
      log(`Opponent chose ${opponentPokemon.name.toUpperCase()}!`);

      if (myPokemon) {
        bothReady = true;
        startBattle();
      }
    }

    else if (data.type === 'attack') {
      receiveAttack(data);
    }

    else if (data.type === 'turn') {
      turnDecided = true;
      myTurn = !data.first;
      if (myTurn) {
        log('<span style="color:#4caf50">You go first!</span>');
        showAttackButton();
      } else {
        log('<span style="color:#f44336">Opponent goes first...</span>');
      }
    }

    else if (data.type === 'shield') {
      log('<span style="color:#ffeb3b;font-size:2.4rem">OPPONENT USED WILD SHIELD!</span>');
      document.getElementById('oppoHpFill').style.width = opponentHpBeforeAttack + '%';
      document.getElementById('oppoHpText').textContent = opponentHpBeforeAttack + '/100 HP';
      showWildShieldEffect(false);
    }

    else if (data.type === 'gameOver') {
      if (data.winner === userAddress) {
        log('<span style="color:#4caf50;font-size:4rem">VICTORY!</span>');
        document.getElementById('playerActions').innerHTML = '<div style="color:#4caf50;font-size:3rem">YOU WIN!<br>Waiting for reward...</div>';
      } else {
        log('<span style="color:#ff4444;font-size:4rem">DEFEATED!</span>');
        triggerFaint(true);
        setTimeout(() => forcePayToWinner(data.winner), 2000);
      }
    }
  });

  conn.on('close', () => {
    log('<span style="color:#f44336">Opponent disconnected!</span>');
    alert('Opponent left the battle');
    location.reload();
  });
}

async function payToWinner(winnerAddress) {
  if (!tokenContract || !winnerAddress) {
    log('<span style="color:#ff4444">Wallet or winner address missing!</span>');
    return;
  }

  try {
    const decimals = await tokenContract.decimals();
    const amount = ethers.utils.parseUnits("500", decimals);

    log(`<span style="color:#ffeb3b">Sending 500 TOKEN to ${winnerAddress.slice(0,8)}...</span>`);

    const tx = await tokenContract.transfer(winnerAddress, amount);
    log('<span style="color:#ffeb3b">Transaction sent! Waiting for confirmation...</span>');

    await tx.wait();

    log('<span style="color:#4caf50;font-size:1.8rem">500 TOKEN SENT TO WINNER!</span>');
    
    // Notify winner that payment arrived
    conn?.send({ type: 'paymentReceived' });

  } catch (err) {
    console.error("Payment failed:", err);
    log('<span style="color:#ff4444">Payment failed! Not enough tokens or rejected.</span>');
  }
}

async function claimVictoryReward() {
  if (!tokenContract || !userAddress) {
    log('<span style="color:#ff4444">Wallet not connected!</span>');
    return;
  }

  try {
  
    log('<span style="color:#4caf50;font-size:2rem">‚úÖ +500 TOKEN REWARDED!</span>');
    
  

  } catch (err) {
    log('<span style="color:#ff4444">Reward claim failed</span>');
    console.error(err);
  }
}

function startTeamSelection() {
  document.getElementById('roomSetup').style.display = 'none';
  document.getElementById('teamSelect').style.display = 'block';
  const grid = document.getElementById('teamGrid'); grid.innerHTML = '';
  if (ownedLocal.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;color:#ffcb05;font-size:1.5rem">No Pok√©mon!<br>Visit shop!</p>';
    return;
  }
  ownedLocal.forEach(p => {
    const card = document.createElement('div');
    card.className = 'team-card';
    card.innerHTML = `<img src="${img(p.id)}"><br><b>${p.name.toUpperCase()}</b>`;
    card.onclick = () => {
      document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      myPokemon = p;
      document.getElementById('readyBtn').disabled = false;
    };
    grid.appendChild(card);
  });

  document.getElementById('readyBtn').onclick = () => {
    document.getElementById('playerImg').src = backImg(myPokemon.id) || img(myPokemon.id);
    document.getElementById('playerName').textContent = myPokemon.name.toUpperCase();
    document.getElementById('teamSelect').style.display = 'none';
    document.getElementById('battleArea').style.display = 'block';
    conn.send({ type: 'pokemon', poke: myPokemon });
    log(`You sent out ${myPokemon.name.toUpperCase()}!`);
    if (opponentPokemon) { bothReady = true; startBattle(); }
  };
}

function startBattle() {
  log('<b style="color:#ffcb05;font-size:1.8rem">BATTLE START!</b>');
  if (isHost && !turnDecided) {
    turnDecided = true;
    myTurn = Math.random() < 0.5;
    conn.send({ type: 'turn', first: myTurn });
    myTurn ? (log('<span style="color:#4caf50">You go first!</span>'), showAttackButton()) : log('<span style="color:#f44336">Opponent goes first...</span>');
  }
}

setInterval(() => {
  if (conn && conn.open && userAddress) {
    conn.send({ type: 'wallet', address: userAddress });
  }
}, 2000);

</script>
</body>
</html>
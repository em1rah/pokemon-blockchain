<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Arena - 1v1 Battle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden}
    
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P';color:#ffcb05;font-size:1.1rem}
    .menu a{display:block;color:#ffcb05;padding:12px 16px;text-decoration:none;font-weight:700;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin:8px 12px;transition:.2s}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(6px)}
    .menu a.active{background:#f17025;color:#fff}

    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{background:#efe339;color:#000}
    .free-balance{background:#9362ed;color:#fff}
    .coins,.free-balance{padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .connect-btn,.logout-btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem}
    .connect-btn{background:#4caf50;color:#fff}
    .connect-btn:hover{background:#45a049}
    .logout-btn{background:#f44336;color:#fff;display:none}
    .logout-btn:hover{background:#d32f2f}

    .container{margin-left:240px;padding:2rem;text-align:center}
    .title{font-family:'Press Start 2P';color:#ffcb05;font-size:2.5rem;margin:1rem 0;text-shadow:0 0 25px #ffcb05}

    .room-setup{max-width:500px;margin:3rem auto;padding:2.5rem;background:rgba(255,203,5,0.1);border:3px solid #ffcb05;border-radius:16px}
    input{padding:14px;font-size:1.2rem;width:100%;margin:15px 0;border:2px solid #ffcb05;background:rgba(0,0,0,0.6);color:#fff;border-radius:12px}
    button{padding:16px 32px;font-size:1.3rem;margin:10px;border:none;border-radius:12px;background:linear-gradient(135deg,#ff9800,#e65100);color:#fff;font-weight:700;cursor:pointer}

    .team-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1.5rem;max-width:900px;margin:2rem auto}
    .team-card{border:4px solid rgba(255,203,5,0.4);border-radius:16px;padding:15px;cursor:pointer;background:rgba(0,0,0,0.4);transition:.2s}
    .team-card:hover{border-color:#ffcb05;transform:scale(1.05)}
    .team-card.selected{border-color:#4caf50;background:rgba(76,175,80,0.4);box-shadow:0 0 30px rgba(76,175,80,0.6)}
    .team-card img{width:100%;height:150px;object-fit:contain}

    /* BATTLE ARENA */
    .battle-area {
      position: relative;
      width: 1000px;
      height: 560px;
      margin: 40px auto;
      background: url('/images/Screenshot\ 2025-11-20\ 210130.png') center/cover no-repeat;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 0 50px rgba(255,203,5,0.8);
    }

    .player-base { position: absolute; bottom: 80px; left: 80px; width: 300px; text-align: center; }
    .pokemon-back img { width: 280px; height: 280px; image-rendering: pixelated; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6)); }

    .opponent-base { position: absolute; top: 60px; right: 80px; width: 300px; text-align: center; }
    .pokemon-front img { width: 240px; height: 240px; image-rendering: pixelated; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6)); }

    .hp-box {
      background: rgba(0,0,0,0.9); border: 5px solid #fff; border-radius: 12px; padding: 10px 16px;
      width: 300px; margin: 12px auto 0; font-family: 'Press Start 2P'; font-size: 0.95rem; box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    }
    .hp-bar-small { height: 22px; background: #222; border: 3px solid #fff; border-radius: 10px; overflow: hidden; margin: 8px 0; }
    .hp-fill-small {
      height: 100%; width: 100%; background: linear-gradient(90deg, #92d04b, #4caf50); transition: width 0.8s ease;
    }
    .hp-fill-small.warning { background: #ff9800; }
    .hp-fill-small.danger { background: #ff4444; }

    .player h2, .opponent h2 { font-family: 'Press Start 2P'; font-size: 1.7rem; margin-bottom: 6px; text-shadow: 3px 3px 0 #000; }
    .player h2 { color: #4caf50; }
    .opponent h2 { color: #f44336; }

    #playerActions { position: absolute; bottom: 60px; right: 80px; z-index: 10; }
    .attack-btn {
      padding: 15px 30px; font-family: 'Press Start 2P', cursive; font-size: 20px;
      background: linear-gradient(135deg, #ff1744, #c62828); color: white; border: 2px solid #ffcb05;
      border-radius: 24px; cursor: pointer; box-shadow: 0 12px 35px rgba(255,23,68,0.8);
      transition: all 0.25s; text-transform: uppercase; letter-spacing: 4px;
    }
    .attack-btn:hover { transform: translateY(-8px); box-shadow: 0 25px 50px rgba(255,23,68,1); }
    .attack-btn:active { transform: translateY(4px); }

    .log{
      background:rgba(0,0,0,0.9);border:4px solid #ffcb05;border-radius:16px;
      padding:1.5rem;height:180px;overflow-y:auto;margin:20px auto;max-width:1000px;
      font-size:1.1rem;line-height:1.9;font-family:'Courier New',monospace;color:#ffcb05
    }

    .confirm-modal,.overlay{display:none;position:fixed;z-index:9999}
    .confirm-modal{top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:6px solid #ffcb05;border-radius:20px;padding:2rem;max-width:500px;width:90%;text-align:center}
    .overlay{inset:0;background:rgba(0,0,0,0.8);z-index:9998}

    @keyframes shake {
      0%,100% { transform: translate(0,0); }
      10%,30%,50%,70%,90% { transform: translate(-10px,0); }
      20%,40%,60%,80% { transform: translate(10px,0); }
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="brand"><h1>Pikaplay Arena</h1></div>
    <div class="menu">
      <a href="home.html">Home</a>
      <a href="shop.html">Marketplace</a>
      <a href="arena.html">Game Play</a>
      <a href="online.html" style="background:#f17025;color:white">Online Play</a>
    </div>
    <div class="status">
      <img src="images/Ash_ketchum_render_by_tzblacktd-da9k0wb.webp" alt="" style="height:50px;width:50px;border-radius:50%;align-self:center">
      <span class="coins" id="coinDisplay">500 Coins</span>
      <span class="free-balance" id="freeDisplay">0 TOKEN</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <h1 class="title">ONLINE BATTLE ARENA</h1>

    <div id="roomSetup" class="room-setup" style="background:#0a0f1d">
      <button onclick="createRoom()">CREATE ROOM</button>
      <p style="margin:20px 0;font-size:1.4rem">OR</p>
      <input type="text" id="roomCodeInput" placeholder="Enter room code">
      <button onclick="joinRoom()">JOIN ROOM</button>
      <div id="roomStatus" style="margin-top:20px;font-size:1.2rem;color:#ffcb05"></div>
    </div>

    <div id="teamSelect" style="display:none">
      <h2 style="color:#ffcb05;font-size:2rem;margin-bottom:2rem">Choose Your Pok√©mon</h2>
      <div class="team-select" id="teamGrid"></div>
      <button id="readyBtn" disabled style="margin-top:2rem;font-size:1.8rem;padding:20px 50px">READY!</button>
    </div>

    <div id="battleArea" class="battle-area" style="display:none">
      <div style="position:absolute;bottom:70px;left:70px">
        <h2 class="player">YOU</h2>
        <div class="player-base">
          <img id="playerImg" class="pokemon-back" src="" alt="Your Pok√©mon">
          <div class="hp-box">
            <div style="color:#4caf50" id="playerName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="playerHpFill"></div></div>
            <div id="playerHpText">100/100 HP</div>
          </div>
        </div>
      </div>

      <div style="position:absolute;top:50px;right:70px">
        <h2 class="opponent">OPPONENT</h2>
        <div class="opponent-base">
          <img id="oppoImg" class="pokemon-front" src="" alt="Opponent">
          <div class="hp-box">
            <div style="color:#f44336" id="oppoName">???</div>
            <div class="hp-bar-small"><div class="hp-fill-small" id="oppoHpFill"></div></div>
            <div id="oppoHpText">100/100 HP</div>
          </div>
        </div>
      </div>

      <div id="playerActions"></div>
    </div>

    <div class="log" id="battleLog">Waiting for opponent...</div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="confirm-modal" id="confirmModal">
    <h2 style="color:#ffcb05">Opponent Wants to Battle!</h2>
    <p>Player ID:</p>
    <p id="opponentId" style="font-family:monospace;color:#4caf50;font-size:1.4rem"></p>
    <button style="background:#4caf50;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="acceptOpponent()">Accept</button>
    <button style="background:#f44336;padding:14px 30px;margin:10px;font-size:1.3rem;border-radius:12px" onclick="rejectOpponent()">Reject</button>
  </div>

<script>
// ==================== FULL SCRIPT WITH ANIMATED ATTACKS ====================
const ICE_SERVERS = { iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'turn:numb.viagenie.ca', username: 'lucasvdz@gmail.com', credential: 'muazwww3' },
  { urls: 'turn:turn.bistrix.net:3478', username: 'test', credential: 'test' }
], iceCandidatePoolSize: 10 };

let ownedLocal = JSON.parse(localStorage.getItem('owned') || '[]');
document.getElementById('coinDisplay').textContent = (localStorage.getItem('coins') || '500') + ' Coins';

function img(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }
function backImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/${id}.gif`; }
function frontImg(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`; }

function log(msg) {
  const logEl = document.getElementById('battleLog');
  logEl.innerHTML += '<div>' + msg + '</div>';
  logEl.scrollTop = logEl.scrollHeight;
}

// =============== RANDOM ATTACK ANIMATIONS ===============
const ATTACK_TYPES = [
  { name: "FIRE BLAST", color: "#ff4400", emoji: "üî•", particles: 28 },
  { name: "THUNDERBOLT", color: "#ffdd00", emoji: "‚ö°", particles: 22 },
  { name: "HYDRO PUMP", color: "#00aaff", emoji: "üíß", particles: 32 },
  { name: "ICE BEAM", color: "#00ffff", emoji: "‚ùÑÔ∏è", particles: 25 },
  { name: "EARTHQUAKE", color: "#8B4513", emoji: "üåç", particles: 20 },
  { name: "HYPER BEAM", color: "#ff00ff", emoji: "üí•", particles: 38 },
  { name: "SHADOW BALL", color: "#4444ff", emoji: "üü£", particles: 22 },
  { name: "MEGA PUNCH", color: "#ffffff", emoji: "üëä", particles: 18 }
];

function playAttackAnimation(isPlayerAttacking) {
  const arena = document.getElementById('battleArea');
  const effect = document.createElement('div');
  effect.style.position = 'absolute';
  effect.style.pointerEvents = 'none';
  effect.style.inset = '0';
  effect.style.zIndex = '15';
  arena.appendChild(effect);

  const attack = ATTACK_TYPES[Math.floor(Math.random() * ATTACK_TYPES.length)];

  for (let i = 0; i < attack.particles; i++) {
    const p = document.createElement('div');
    p.textContent = attack.emoji;
    p.style.position = 'absolute';
    p.style.fontSize = `${Math.random() * 40 + 30}px`;
    p.style.opacity = '0.9';
    p.style.pointerEvents = 'none';
    p.style.filter = `drop-shadow(0 0 15px ${attack.color})`;

    const startX = isPlayerAttacking ? Math.random() * 350 + 50 : Math.random() * 350 + 550;
    const startY = isPlayerAttacking ? 400 + Math.random() * 100 : Math.random() * 200 + 50;
    const endX = isPlayerAttacking ? Math.random() * 350 + 550 : Math.random() * 350 + 50;
    const endY = isPlayerAttacking ? Math.random() * 200 + 100 : 400 + Math.random() * 100;

    p.style.left = startX + 'px';
    p.style.top = startY + 'px';
    effect.appendChild(p);

    p.animate([
      { transform: `translate(0,0) rotate(0deg)`, opacity: 0.9 },
      { transform: `translate(${endX - startX}px, ${endY - startY}px) rotate(${Math.random() * 720 - 360}deg)`, opacity: 0 }
    ], {
      duration: 700 + Math.random() * 500,
      easing: 'cubic-bezier(0.2, 0.6, 0.8, 1)'
    }).onfinish = () => p.remove();
  }

  if (attack.name === "EARTHQUAKE" || attack.name === "HYPER BEAM") {
    arena.style.animation = 'shake 0.7s';
    setTimeout(() => arena.style.animation = '', 700);
  }

  const flash = document.createElement('div');
  flash.style.position = 'absolute';
  flash.style.inset = '0';
  flash.style.background = attack.color + '50';
  flash.style.opacity = '0';
  arena.appendChild(flash);
  flash.animate([{ opacity: 0 }, { opacity: 0.7 }, { opacity: 0 }], { duration: 400 });
  setTimeout(() => { if (flash.parentNode) flash.remove(); effect.remove(); }, 1600);

  return attack.name;
}

// =============== BATTLE LOGIC ===============
let turnDecided = false, peer = null, conn = null, roomCode = null, isHost = false;
let myPokemon = null, opponentPokemon = null, myTurn = false, pendingOpponent = null, bothReady = false;

function createRoom() {
  roomCode = prompt("Enter your room code (e.g. MEWTWO)").trim().toUpperCase().substring(0,15);
  if (!roomCode) return;
  isHost = true;
  peer = new Peer(roomCode, { host: '0.peerjs.com', port: 443, secure: true, config: ICE_SERVERS });
  peer.on('open', () => {
    document.getElementById('roomStatus').innerHTML = `Room Created!<br><b style="font-size:1.8rem;color:#ffcb05">${roomCode}</b><br>Waiting for challenger...`;
    log(`Room ${roomCode} created! Share the code.`);
  });
  peer.on('connection', inc => {
    if (conn) { inc.close(); return; }
    pendingOpponent = inc;
    document.getElementById('opponentId').textContent = inc.peer;
    document.getElementById('overlay').style.display = document.getElementById('confirmModal').style.display = 'block';
    log('A challenger approaches...');
  });
}

function joinRoom() {
  roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!roomCode) return alert("Enter a room code!");
  peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, secure: true, config: ICE_SERVERS });
  peer.on('open', () => {
    conn = peer.connect(roomCode, { reliable: true });
    setupConnectionEvents(conn);
    log('Joining room ' + roomCode + '...');
  });
}

function acceptOpponent() { conn = pendingOpponent; pendingOpponent = null; hideModal(); setupConnectionEvents(conn); conn.send({ type: 'accepted' }); startTeamSelection(); log('Opponent accepted! Choose your Pok√©mon.'); }
function rejectOpponent() { if (pendingOpponent) pendingOpponent.close(); pendingOpponent = null; hideModal(); log('Challenger rejected.'); }
function hideModal() { document.getElementById('overlay').style.display = document.getElementById('confirmModal').style.display = 'none'; }

function setupConnectionEvents(c) {
  conn = c;
  conn.on('data', data => {
    if (data.type === 'accepted') { log('Host accepted!'); startTeamSelection(); }
    else if (data.type === 'pokemon') {
      opponentPokemon = data.poke;
      document.getElementById('oppoImg').src = frontImg(opponentPokemon.id) || img(opponentPokemon.id);
      document.getElementById('oppoName').textContent = opponentPokemon.name.toUpperCase();
      document.getElementById('oppoHpText').textContent = '100/100 HP';
      document.getElementById('oppoHpFill').style.width = '100%';
      log(`Opponent sent out ${opponentPokemon.name.toUpperCase()}!`);
      if (myPokemon && !bothReady) { bothReady = true; startBattle(); }
    }
    else if (data.type === 'attack') receiveAttack(data);
    else if (data.type === 'turn') {
      turnDecided = true; myTurn = !data.first;
      myTurn ? (log('<span style="color:#4caf50">You go first!</span>'), showAttackButton()) : log('<span style="color:#f44336">Opponent goes first...</span>');
    }
  });
  conn.on('close', () => { log('<span style="color:#f44336">Opponent disconnected!</span>'); alert('Opponent left.'); location.reload(); });
}

function startTeamSelection() {
  document.getElementById('roomSetup').style.display = 'none';
  document.getElementById('teamSelect').style.display = 'block';
  loadTeamSelect();
}

function loadTeamSelect() {
  const grid = document.getElementById('teamGrid'); grid.innerHTML = '';
  if (ownedLocal.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;color:#ffcb05;font-size:1.5rem">No Pok√©mon owned!<br>Visit the shop first!</p>';
    return;
  }
  ownedLocal.forEach(p => {
    const card = document.createElement('div'); card.className = 'team-card';
    card.innerHTML = `<img src="${img(p.id)}"><br><b>${p.name.toUpperCase()}</b>`;
    card.onclick = () => {
      document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected'); myPokemon = p;
      document.getElementById('readyBtn').disabled = false;
    };
    grid.appendChild(card);
  });
  document.getElementById('readyBtn').onclick = () => {
    if (!myPokemon) return;
    document.getElementById('playerImg').src = backImg(myPokemon.id) || img(myPokemon.id);
    document.getElementById('playerName').textContent = myPokemon.name.toUpperCase();
    document.getElementById('playerHpText').textContent = '100/100 HP';
    document.getElementById('playerHpFill').style.width = '100%';
    document.getElementById('teamSelect').style.display = 'none';
    document.getElementById('battleArea').style.display = 'block';
    conn.send({ type: 'pokemon', poke: myPokemon });
    log(`You sent out ${myPokemon.name.toUpperCase()}!`);
    if (opponentPokemon) { bothReady = true; startBattle(); }
  };
}

function startBattle() {
  if (document.getElementById('battleArea').style.display !== 'block') return;
  log('<b style="color:#ffcb05;font-size:1.8rem">BATTLE START!</b>');
  if (isHost && !turnDecided) {
    turnDecided = true; myTurn = Math.random() < 0.5;
    conn.send({ type: 'turn', first: myTurn });
    myTurn ? (log('<span style="color:#4caf50">You go first!</span>'), showAttackButton()) : log('<span style="color:#f44336">Opponent goes first...</span>');
  }
}

function showAttackButton() {
  if (!myTurn || !conn) return;
  document.getElementById('playerActions').innerHTML = `<button class="attack-btn" onclick="attack()">ATTACK!</button>`;
}

function attack() {
  if (!myTurn || !conn) return;

  // 20% MISS CHANCE
  if (Math.random() < 0.20) {
    conn.send({ type: 'attack', damage: 0, missed: true });
    playAttackAnimation(true);
    log(`<span style="color:#888">Your attack <b>MISSED!</b></span>`);
    document.getElementById('playerActions').innerHTML = '<div style="background:rgba(0,0,0,0.8);color:#ccc;padding:20px 40px;border-radius:16px;font-size:1.4rem">Waiting for opponent...</div>';
    myTurn = false;
    return;
  }

  const damage = 25 + Math.floor(Math.random() * 30);
  const moveName = playAttackAnimation(true);

  conn.send({ type: 'attack', damage, moveName });
  log(`You used <span style="color:#ffcb05"><b>${moveName}</b></span>! Dealt <b style="color:#ff4444">${damage}</b> damage!`);

  let hp = parseInt(document.getElementById('oppoHpText').textContent);
  hp = Math.max(0, hp - damage);
  document.getElementById('oppoHpFill').style.width = hp + '%';
  document.getElementById('oppoHpText').textContent = hp + '/100 HP';
  const fill = document.getElementById('oppoHpFill');
  fill.classList.toggle('warning', hp <= 50); fill.classList.toggle('danger', hp <= 20);

  document.getElementById('playerActions').innerHTML = '<div style="background:rgba(0,0,0,0.8);color:#ccc;padding:20px 40px;border-radius:16px;font-size:1.4rem">Waiting for opponent...</div>';

  if (hp <= 0) {
    setTimeout(() => {
      log('<span style="color:#4caf50;font-size:2rem"><b>YOU WIN!</b></span>');
      alert('YOU WIN! üéâ');
    }, 1200);
  }
  myTurn = false;
}

function receiveAttack(data) {
  if (data.missed) {
    log(`<span style="color:#888">Opponent\'s attack <b>MISSED!</b></span>`);
    playAttackAnimation(false);
    myTurn = true;
    showAttackButton();
    return;
  }

  const moveName = data.moveName || "Attack";
  playAttackAnimation(false);
  log(`Opponent used <span style="color:#ffcb05"><b>${moveName}</b></span>! Took <b style="color:#ff4444">${data.damage}</b> damage!`);

  let hp = parseInt(document.getElementById('playerHpText').textContent);
  hp = Math.max(0, hp - data.damage);
  document.getElementById('playerHpFill').style.width = hp + '%';
  document.getElementById('playerHpText').textContent = hp + '/100 HP';
  const fill = document.getElementById('playerHpFill');
  fill.classList.toggle('warning', hp <= 50); fill.classList.toggle('danger', hp <= 20);

  if (hp <= 0) {
    setTimeout(() => {
      log('<span style="color:#f44336;font-size:2rem"><b>You fainted...</b></span>');
      alert('You lost the battle... üíÄ');
    }, 1200);
  } else {
    myTurn = true;
    showAttackButton();
  }
}
</script>
</body>
</html>
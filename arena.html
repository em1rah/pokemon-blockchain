<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Arena</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" 
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      min-height:100vh;
      color:white;
      display:flex;
      flex-direction:column;
      background:#000000;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POKÉMON</text></svg>') repeat;
      opacity:0.3;
      z-index:0;
      pointer-events:none;
    }
    body > header, body > .container{
      position:relative;
      z-index:1;
    }
    header{background:rgba(0,0,0,.5);backdrop-filter:blur(8px);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,.1);} 
    header h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem}
    nav a{margin-left:1rem;color:#ffcb05;text-decoration:none;font-weight:600;font-family:'Inter',system-ui}
    nav a:hover{color:#fff}
    .coins{display:inline-block;background:#ffeb3b;color:#1a2a6c;padding:6px 12px;border-radius:12px;font-weight:700;margin-left:10px;font-size:0.9rem;}
    .wallet{margin-left:12px;font-size:.9rem;color:#ddd}
    .logout-btn{margin-left:12px;background:#f44336;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}

    .container{padding:1.5rem;}
    .title{color:#ffcb05;font-size:1.6rem;margin-bottom:.25rem;font-family:'Inter',system-ui}
    .subtitle{color:#ccc;margin-bottom:1rem;font-family:'Inter',system-ui}

    .battlefield{display:flex;justify-content:space-around;align-items:flex-end;width:100%;max-width:900px;margin:20px auto;position:relative;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .pokemon{position:relative;text-align:center;min-width:200px}
    .pokemon img{width:200px;height:200px;object-fit:contain;filter: drop-shadow(0 6px 12px rgba(0,0,0,.6));}
    .hp-bar{background:#333;border:2px solid #ffcb05;border-radius:10px;height:20px;width:200px;margin:10px auto;position:relative;overflow:hidden;}
    .hp-fill{height:100%;background:#4caf50;border-radius:8px;transition:width .5s ease,background .3s;}
    .hp-text{position:absolute;top:0;left:0;right:0;text-align:center;font-weight:600;font-size:13px;color:white;text-shadow:1px 1px 2px #000;}
    .name{font-weight:700;color:#ffcb05;font-size:1.1rem;text-shadow:1px 1px 3px #000;margin-bottom:4px;font-family:'Inter',system-ui}

    .moves{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:0 auto;max-width:700px;padding:0 1rem}
    .move-btn{padding:14px;background:rgba(255,255,255,.1);border:2px solid #ffcb05;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:.2s;font-family:'Inter',system-ui}
    .move-btn:hover{background:rgba(255,203,5,.2);} 
    .move-btn:disabled{background:#444;cursor:not-allowed;opacity:.6;}

    .log{background:rgba(0,0,0,.6);padding:16px;border-radius:12px;max-height:160px;overflow-y:auto;font-size:15px;margin:16px auto 0;max-width:900px;border:1px solid rgba(255,203,5,.3);font-family:'Inter',system-ui}
    .log p{margin:6px 0;opacity:.9;}
    .system{color:#ffcb05;font-weight:600}
    .trophy{vertical-align:middle;margin-left:6px}

    /* Pokemon Selection Modal */
    .pokemon-select-modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.8);
      z-index:1000;
      justify-content:center;
      align-items:center;
    }
    .pokemon-select-modal.active{display:flex;}
    .select-panel{
      background:#1a1a2e;
      border:3px solid #ffcb05;
      border-radius:20px;
      padding:30px;
      max-width:600px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    .select-title{
      color:#ffcb05;
      font-size:1.5rem;
      margin-bottom:20px;
      text-align:center;
    }
    .pokemon-select-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
      gap:15px;
      margin-bottom:20px;
    }
    .pokemon-select-card{
      background:rgba(255,255,255,.1);
      border:2px solid rgba(255,203,5,.3);
      border-radius:12px;
      padding:10px;
      text-align:center;
      cursor:pointer;
      transition:all .3s;
    }
    .pokemon-select-card:hover{
      border-color:#ffcb05;
      transform:scale(1.05);
      background:rgba(255,203,5,.2);
    }
    .pokemon-select-card.selected{
      border-color:#4caf50;
      background:rgba(76,175,80,.3);
      box-shadow:0 0 15px rgba(76,175,80,.5);
    }
    .pokemon-select-card img{
      width:80px;
      height:80px;
      object-fit:contain;
    }
    .pokemon-select-card .name{
      font-size:0.85rem;
      margin-top:5px;
      color:#fff;
    }

    /* Battle Animations */
    @keyframes shake{
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    @keyframes flash{
      0%,100%{opacity:1;filter:brightness(1);}
      50%{opacity:0.7;filter:brightness(1.5);}
    }
    @keyframes hit{
      0%{transform:scale(1);}
      50%{transform:scale(0.9);}
      100%{transform:scale(1);}
    }
    @keyframes attack{
      0%{transform:translateX(0);}
      50%{transform:translateX(20px);}
      100%{transform:translateX(0);}
    }
    .pokemon.shake{animation:shake 0.5s ease-in-out;}
    .pokemon.flash{animation:flash 0.3s ease-in-out 3;}
    .pokemon.hit{animation:hit 0.3s ease-in-out;}
    .pokemon.attack{animation:attack 0.4s ease-in-out;}

    /* Sound controls */
    .sound-controls{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:100;
      display:flex;
      gap:10px;
    }
    .sound-btn{
      background:rgba(0,0,0,.7);
      border:2px solid #ffcb05;
      border-radius:50%;
      width:50px;
      height:50px;
      color:#ffcb05;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.3rem;
      transition:all .3s;
    }
    .sound-btn:hover{
      background:rgba(255,203,5,.2);
      transform:scale(1.1);
    }
  </style>
</head>
<body>
  <header>
    <div><h1>Pokémon Arena</h1></div>
    <nav>
      <a href="home.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="history.html">History</a>
      <a href="settings.html">Settings</a>
      <span class="coins" id="coinDisplay">0 Coins</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </nav>
  </header>

  <div class="container">
    <div class="title">Battle Arena</div>
    <div class="subtitle">Defeat your opponent to earn coins and a trophy</div>

    <div class="battlefield">
      <div class="pokemon" id="playerPokemon">
        <div class="name" id="playerName">Pikachu</div>
        <img id="playerSprite" src="" alt="You">
        <div class="hp-bar"><div class="hp-fill" id="playerHP"></div><div class="hp-text" id="playerHPText">100/100</div></div>
      </div>
      <div class="pokemon" id="opponentPokemon">
        <div class="name" id="opponentName">???</div>
        <img id="opponentSprite" src="" alt="Opponent">
        <div class="hp-bar"><div class="hp-fill" id="opponentHP"></div><div class="hp-text" id="opponentHPText">100/100</div></div>
      </div>
    </div>

    <div class="moves">
      <button class="move-btn" data-move="thunderbolt">Thunderbolt</button>
      <button class="move-btn" data-move="quickattack">Quick Attack</button>
      <button class="move-btn" data-move="irontail">Iron Tail</button>
      <button class="move-btn" data-move="run">Run Away</button>
    </div>

    <div class="log" id="battleLog">
      <p class="system">Click any move to begin...</p>
    </div>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
      <button class="move-btn" id="selectPokemonBtn">Select Pokemon</button>
      <button class="move-btn" id="startBtn">Start Battle</button>
      <button class="move-btn" id="againBtn" disabled>Play Again</button>
    </div>
  </div>

  <!-- Pokemon Selection Modal -->
  <div class="pokemon-select-modal" id="pokemonSelectModal">
    <div class="select-panel">
      <div class="select-title">Choose Your Pokemon</div>
      <div class="pokemon-select-grid" id="pokemonSelectGrid"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="move-btn" id="confirmSelectBtn" style="max-width:200px;">Confirm Selection</button>
        <button class="move-btn" id="cancelSelectBtn" style="max-width:200px;background:#666;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Sound Controls with Font Awesome Icons -->
  <div class="sound-controls">
    <button class="sound-btn" id="musicToggle" title="Toggle Music">
      <i class="fas fa-music"></i>
    </button>
    <button class="sound-btn" id="soundToggle" title="Toggle Sounds">
      <i class="fas fa-volume-high"></i>
    </button>
  </div>

  <script>
    const session = JSON.parse(localStorage.getItem('trainerSession'));
    // Web3 setup
    const NFT_ADDRESS = '0xYourPokemonNFTAddressHere';
    const BADGE_ADDRESS = '0xYourBadgeAddressHere';
    const ERC721_ABI = [
      'function mint(address to, uint256 pokeId, string memory pokeName) external returns (uint256)',
      'function ownerOf(uint256 tokenId) view returns (address)'
    ];
    const BADGE_ABI = [
      'function mint(address to, uint256 id, uint256 amount, bytes memory data) external'
    ];
    function getSigner(){
      if (!window.ethereum) return null;
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      return provider.getSigner();
    }
    if (!session) location.href = 'index.html';
    const USER_ID = session.type === 'metamask' ? session.address.toLowerCase() : session.address.toLowerCase();
    const ns = (k) => `${USER_ID}:${k}`;
    const COIN_KEY = ns('coins');
    const OWNED_KEY = ns('owned');
    const EQUIPPED_KEY = ns('equipped');
    const HIST_KEY = ns('tournaments');
    const SETTINGS_KEY = ns('settings');

    const walletDisplay = document.getElementById('walletDisplay');
    if (session.type === 'metamask') walletDisplay.textContent = session.address.slice(0,6)+"..."+session.address.slice(-4);
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('trainerSession'); location.href = 'index.html'; };

    function getCoins(){ return parseInt(localStorage.getItem(COIN_KEY) || '0'); }
    function setCoins(v){ localStorage.setItem(COIN_KEY, String(v)); document.getElementById('coinDisplay').textContent = v + ' Coins'; }
    if (localStorage.getItem(COIN_KEY) === null) setCoins(500); else setCoins(getCoins());

    let ownedPokemon = JSON.parse(localStorage.getItem(OWNED_KEY) || '[]');
    const shopOwned = JSON.parse(localStorage.getItem('owned') || '[]');
    if (shopOwned.length > 0) {
      shopOwned.forEach(p => {
        if (!ownedPokemon.find(op => op.id === p.id)) {
          ownedPokemon.push(p);
        }
      });
    }
    if (ownedPokemon.length === 0 || !ownedPokemon.find(p => p.id === 25)) {
      ownedPokemon.push({ id: 25, name: 'Pikachu' });
      localStorage.setItem(OWNED_KEY, JSON.stringify(ownedPokemon));
    }
    let equippedId = parseInt(localStorage.getItem(EQUIPPED_KEY) || '25');
    let selectedPokemonId = equippedId;

    const player = { id: equippedId, name: (ownedPokemon.find(p=>p.id===equippedId)||{name:'Pikachu'}).name, hp:100, maxHp:100 };
    const playerSprite = document.getElementById('playerSprite');
    const playerName = document.getElementById('playerName');
    const playerHP = document.getElementById('playerHP');
    const playerHPText = document.getElementById('playerHPText');
    const opponentSprite = document.getElementById('opponentSprite');
    const opponentName = document.getElementById('opponentName');
    const opponentHP = document.getElementById('opponentHP');
    const opponentHPText = document.getElementById('opponentHPText');
    const battleLog = document.getElementById('battleLog');
    const moveButtons = document.querySelectorAll('.move-btn');

    function updateHP(bar, textEl, hp, max) {
      const percent = (hp / max) * 100;
      bar.style.width = percent + '%';
      textEl.textContent = `${hp}/${max}`;
      bar.style.background = percent > 50 ? '#4caf50' : percent > 25 ? '#ff9800' : '#f44336';
    }
    function log(msg, cls=''){
      const p = document.createElement('p'); p.innerHTML = msg; if (cls) p.className = cls; battleLog.appendChild(p); battleLog.scrollTop = battleLog.scrollHeight;
    }

    function loadPlayer(){
      const p = ownedPokemon.find(p=>p.id===selectedPokemonId) || ownedPokemon.find(p=>p.id===equippedId) || ownedPokemon[0];
      player.id = p.id; player.name = p.name; player.hp = player.maxHp;
      playerSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png`;
      playerName.textContent = p.name;
      updateHP(playerHP, playerHPText, player.hp, player.maxHp);
    }

    // Pokemon Selection UI
    function showPokemonSelection(){
      const grid = document.getElementById('pokemonSelectGrid');
      grid.innerHTML = '';
      ownedPokemon.forEach(p => {
        const card = document.createElement('div');
        card.className = `pokemon-select-card ${p.id === selectedPokemonId ? 'selected' : ''}`;
        card.innerHTML = `
          <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png" alt="${p.name}">
          <div class="name">${p.name}</div>
        `;
        card.onclick = () => {
          document.querySelectorAll('.pokemon-select-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedPokemonId = p.id;
          playSound('select');
        };
        grid.appendChild(card);
      });
      document.getElementById('pokemonSelectModal').classList.add('active');
    }

    document.getElementById('selectPokemonBtn').onclick = showPokemonSelection;
    document.getElementById('confirmSelectBtn').onclick = () => {
      equippedId = selectedPokemonId;
      localStorage.setItem(EQUIPPED_KEY, String(equippedId));
      loadPlayer();
      document.getElementById('pokemonSelectModal').classList.remove('active');
      playSound('confirm');
    };
    document.getElementById('cancelSelectBtn').onclick = () => {
      selectedPokemonId = equippedId;
      document.getElementById('pokemonSelectModal').classList.remove('active');
    };

    let opponent = null; let battleActive = false; let playerTurn = true;
    const moves = {
      thunderbolt: { name: 'Thunderbolt', power: 30, color: '#ffeb3b' },
      quickattack: { name: 'Quick Attack', power: 20, color: '#81c784' },
      irontail: { name: 'Iron Tail', power: 40, color: '#9e9e9e' },
      run: { name: 'Run Away', power: 0, color: '#ff9800', run: true }
    };

    // ———————————————————————————————————————————————
    // UNIQUE ATTACK SOUNDS + ICON TOGGLES
    // ———————————————————————————————————————————————
    let musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
    let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
    let currentMusic = null;

    function tone(freq, duration = 0.1, volume = 0.12, type = 'sine') {
      if (!soundsEnabled) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(volume, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    }

    function playAttackSound(moveKey) {
      if (!soundsEnabled) return;

      switch (moveKey) {
        case 'thunderbolt':
          tone(800, 0.08, 0.25, 'sawtooth');
          setTimeout(() => tone(600, 0.08, 0.25, 'sawtooth'), 40);
          setTimeout(() => tone(400, 0.08, 0.25, 'sawtooth'), 80);
          break;
        case 'quickattack':
          tone(1200, 0.06, 0.18, 'square');
          setTimeout(() => tone(900, 0.06, 0.18, 'square'), 30);
          break;
        case 'irontail':
          tone(180, 0.12, 0.28, 'square');
          setTimeout(() => tone(220, 0.10, 0.25, 'square'), 60);
          setTimeout(() => tone(150, 0.08, 0.22, 'square'), 120);
          break;
        case 'run':
          tone(500, 0.07, 0.15, 'triangle');
          setTimeout(() => tone(700, 0.07, 0.15, 'triangle'), 50);
          setTimeout(() => tone(900, 0.07, 0.15, 'triangle'), 100);
          break;
      }
    }

    function playSound(type){
      if (!soundsEnabled) return;
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      const frequencies = {
        'hit': [200, 150],
        'appear': [300, 400, 500],
        'victory': [523.25, 659.25, 783.99],
        'defeat': [200, 180, 160],
        'select': [440],
        'confirm': [523.25, 659.25]
      };

      const freq = frequencies[type] || [440];
      if (freq.length === 1) {
        oscillator.frequency.setValueAtTime(freq[0], audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      } else {
        freq.forEach((f, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(f, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            osc.start();
            osc.stop(audioContext.currentTime + 0.15);
          }, i * 100);
        });
      }
    }

    function playMusic(type){
      if (!musicEnabled) return;
      stopMusic();
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = type === 'battle' ? [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25] : [];
      let noteIndex = 0;
      
      function playNote(){
        if (!musicEnabled || !battleActive) return;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.setValueAtTime(notes[noteIndex % notes.length], audioContext.currentTime);
        gain.gain.setValueAtTime(0.05, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
        noteIndex++;
        setTimeout(playNote, 200);
      }
      playNote();
      currentMusic = { audioContext, interval: setInterval(() => {}, 100) };
    }

    function stopMusic(){
      if (currentMusic) {
        if (currentMusic.audioContext) currentMusic.audioContext.close();
        if (currentMusic.interval) clearInterval(currentMusic.interval);
        currentMusic = null;
      }
    }

    // ———————————————————————————————————————————————
    // ICON TOGGLE LOGIC
    // ———————————————————————————————————————————————
    const musicBtn = document.getElementById('musicToggle');
    const soundBtn = document.getElementById('soundToggle');

    function updateIcons() {
      musicBtn.innerHTML = musicEnabled ? '<i class="fas fa-music"></i>' : '<i class="fas fa-volume-mute"></i>';
      soundBtn.innerHTML = soundsEnabled ? '<i class="fas fa-volume-high"></i>' : '<i class="fas fa-volume-mute"></i>';
    }

    musicBtn.onclick = () => {
      musicEnabled = !musicEnabled;
      localStorage.setItem('musicEnabled', musicEnabled);
      updateIcons();
      if (!musicEnabled) stopMusic();
      else if (battleActive) playMusic('battle');
    };

    soundBtn.onclick = () => {
      soundsEnabled = !soundsEnabled;
      localStorage.setItem('soundsEnabled', soundsEnabled);
      updateIcons();
    };

    // Initial icon state
    updateIcons();

    // ———————————————————————————————————————————————
    // BATTLE LOGIC
    // ———————————————————————————————————————————————
    async function newBattle(){
      battleActive = true; playerTurn = true; battleLog.innerHTML = ''; moveButtons.forEach(b=>b.disabled=false); loadPlayer();
      playMusic('battle');
      const oppId = Math.floor(Math.random() * 150) + 1;
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${oppId}`);
      const data = await res.json();
      opponent = { id: oppId, name: data.name.charAt(0).toUpperCase()+data.name.slice(1), hp:100, maxHp:100 };
      opponentSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${oppId}.png`;
      opponentName.textContent = opponent.name; updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
      
      opponentSprite.style.opacity = '0';
      opponentSprite.style.transform = 'scale(0)';
      setTimeout(() => {
        opponentSprite.style.transition = 'all 0.5s ease';
        opponentSprite.style.opacity = '1';
        opponentSprite.style.transform = 'scale(1)';
      }, 100);
      
      log(`A wild <strong>${opponent.name}</strong> appeared!`, 'system');
      playSound('appear');
      document.getElementById('againBtn').disabled = true;
    }

    moveButtons.forEach(btn => btn.addEventListener('click', () => {
      if (!battleActive || !playerTurn) return;
      const key = btn.dataset.move; const move = moves[key];
      if (move.run){ 
        log(`<strong>${player.name}</strong> ran away.`, 'system'); 
        playAttackSound('run');
        return endBattle(false, true); 
      }
      
      const playerEl = document.getElementById('playerPokemon');
      playerEl.classList.add('attack');
      playAttackSound(key);
      setTimeout(() => playerEl.classList.remove('attack'), 400);
      
      const dmg = Math.floor(Math.random()*8)+move.power; 
      opponent.hp = Math.max(0, opponent.hp - dmg);
      log(`<strong>${player.name}</strong> used <span style="color:${move.color}">${move.name}</span>!`);
      
      setTimeout(() => {
        const oppEl = document.getElementById('opponentPokemon');
        oppEl.classList.add('hit', 'shake');
        playSound('hit');
        setTimeout(() => oppEl.classList.remove('hit', 'shake'), 500);
      }, 300);
      
      log(`${opponent.name} took <strong>${dmg}</strong> damage.`);
      updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
      if (opponent.hp === 0) {
        playSound('victory');
        return setTimeout(() => endBattle(true), 300);
      }
      playerTurn = false; moveButtons.forEach(b => b.disabled = true);
      setTimeout(() => {
        const oppEl = document.getElementById('opponentPokemon');
        oppEl.classList.add('attack');
        playSound('attack');
        setTimeout(() => oppEl.classList.remove('attack'), 400);
        
        const oppDmg = Math.floor(Math.random()*25)+15; 
        player.hp = Math.max(0, player.hp - oppDmg);
        log(`${opponent.name} attacked! You took <strong>${oppDmg}</strong> damage.`);
        
        setTimeout(() => {
          playerEl.classList.add('hit', 'shake');
          playSound('hit');
          setTimeout(() => playerEl.classList.remove('hit', 'shake'), 500);
        }, 300);
        
        updateHP(playerHP, playerHPText, player.hp, player.maxHp);
        if (player.hp === 0) {
          playSound('defeat');
          return endBattle(false);
        }
        playerTurn = true; moveButtons.forEach(b => b.disabled = false);
      }, 900);
    }));

    function trophySvg(){
      return '<svg class="trophy" width="18" height="18" viewBox="0 0 24 24" fill="#ffeb3b" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h12v3h3v4a5 5 0 0 1-5 5h-1.1A5.002 5.002 0 0 1 12 17a5.002 5.002 0 0 1-2.9-3H8a5 5 0 0 1-5-5V5h3V2Zm12 5V4H6v3H4v2a3 3 0 0 0 3 3h1.18A5.988 5.988 0 0 1 12 10c1.55 0 2.97.59 4.02 1.56L17 12a3 3 0 0 0 3-3V7h-2Zm-6 7a3 3 0 0 0 2.83-2H9.17A3 3 0 0 0 12 14Zm-4 4h8v2H8v-2Z"/></svg>';
    }

    async function endBattle(won, ran = false){
      battleActive = false; moveButtons.forEach(b => b.disabled = true);
      stopMusic();
      const history = JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
      history.push({ player: player.name, opponent: opponent.name, won: won && !ran, date: new Date().toISOString() });
      localStorage.setItem(HIST_KEY, JSON.stringify(history));
      if (won && !ran){
        const playerEl = document.getElementById('playerPokemon');
        playerEl.classList.add('flash');
        log(`<strong style="color:#4caf50;">Victory!</strong> ${trophySvg()}`, 'system');
        const reward = 100; setCoins(getCoins() + reward); log(`You earned <strong>${reward}</strong> coins.`);
        try{
          const signer = getSigner();
          if (signer) {
            const badge = new ethers.Contract(BADGE_ADDRESS, BADGE_ABI, signer);
            await badge.mint(session.address, 1, 1, '0x');
          }
        }catch(e){ console.warn('Badge mint failed:', e); }
      } else if (ran){
        log(`<strong style="color:#ff9800;">You escaped safely.</strong>`, 'system');
      } else {
        log(`<strong style="color:#f44336;">Defeat...</strong>`, 'system');
      }
      document.getElementById('againBtn').disabled = false;
    }

    document.getElementById('startBtn').onclick = () => { if (!battleActive) newBattle(); };
    document.getElementById('againBtn').onclick = () => { if (!battleActive) newBattle(); };
  </script>
</body>
</html>
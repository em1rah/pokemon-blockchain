<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Arena</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" 
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      min-height:100vh;
      color:white;
      display:flex;
      flex-direction:column;
      background:#000000;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POKÉMON</text></svg>') repeat;
      opacity:0.3;
      z-index:0;
      pointer-events:none;
    }
    body > header, body > .container{
      position:relative;
      z-index:1;
    }
    header{background:rgba(0,0,0,.5);backdrop-filter:blur(8px);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,.1);} 
    header h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem}
    nav a{margin-left:1rem;color:#ffcb05;text-decoration:none;font-weight:600;font-family:'Inter',system-ui}
    nav a:hover{color:#fff}
    .coins{display:inline-block;background:#ffeb3b;color:#1a2a6c;padding:6px 12px;border-radius:12px;font-weight:700;margin-left:10px;font-size:0.9rem;}
    .wallet{margin-left:12px;font-size:.9rem;color:#ddd}
    .logout-btn{margin-left:12px;background:#f44336;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}

    .container{padding:1.5rem;max-width:900px;margin:0 auto;}
    .title{color:#ffcb05;font-size:1.6rem;margin-bottom:.25rem;font-family:'Inter',system-ui}
    .subtitle{color:#ccc;margin-bottom:1rem;font-family:'Inter',system-ui}

    .battlefield{display:flex;justify-content:space-around;align-items:flex-end;width:100%;max-width:900px;margin:20px auto;position:relative;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .pokemon{position:relative;text-align:center;min-width:200px}
    .pokemon img{width:200px;height:200px;object-fit:contain;filter: drop-shadow(0 6px 12px rgba(0,0,0,.6));}
    .hp-bar{background:#333;border:2px solid #ffcb05;border-radius:10px;height:20px;width:200px;margin:10px auto;position:relative;overflow:hidden;}
    .hp-fill{height:100%;background:#4caf50;border-radius:8px;transition:width .5s ease,background .3s;}
    .hp-text{position:absolute;top:0;left:0;right:0;text-align:center;font-weight:600;font-size:13px;color:white;text-shadow:1px 1px 2px #000;}
    .name{font-weight:700;color:#ffcb05;font-size:1.1rem;text-shadow:1px 1px 3px #000;margin-bottom:4px;font-family:'Inter',system-ui}

    .moves{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:0 auto;max-width:700px;padding:0 1rem}
    .move-btn{padding:14px;background:rgba(255,255,255,.1);border:2px solid #ffcb05;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:.2s;font-family:'Inter',system-ui}
    .move-btn:hover{background:rgba(255,203,5,.2);} 
    .move-btn:disabled{background:#444;cursor:not-allowed;opacity:.6;}

    .log{background:rgba(0,0,0,.6);padding:16px;border-radius:12px;max-height:160px;overflow-y:auto;font-size:15px;margin:16px auto 0;max-width:900px;border:1px solid rgba(255,203,5,.3);font-family:'Inter',system-ui}
    .log p{margin:6px 0;opacity:.9;}
    .system{color:#ffcb05;font-weight:600}
    .trophy{vertical-align:middle;margin-left:6px}

    /* Tournament Setup */
    #tournamentSetup{display:flex;gap:12px;justify-content:center;margin:1.5rem 0;flex-wrap:wrap;}
    #tournamentSetup .move-btn{min-width:180px;}

    /* Scoreboard */
    #scoreboard{margin:1.5rem auto;display:none;}
    #scoreboard table{width:100%;border-collapse:collapse;}
    #scoreboard th, #scoreboard td{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);}
    #scoreboard thead{background:rgba(255,203,5,.2);}
    #scoreboard tbody tr:nth-child(even){background:rgba(255,255,255,.05);}

    /* Pokemon Selection Modal */
    .pokemon-select-modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.8);
      z-index:1000;
      justify-content:center;
      align-items:center;
    }
    .pokemon-select-modal.active{display:flex;}
    .select-panel{
      background:#1a1a2e;
      border:3px solid #ffcb05;
      border-radius:20px;
      padding:30px;
      max-width:600px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    .select-title{
      color:#ffcb05;
      font-size:1.5rem;
      margin-bottom:20px;
      text-align:center;
    }
    .pokemon-select-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
      gap:15px;
      margin-bottom:20px;
    }
    .pokemon-select-card{
      background:rgba(255,255,255,.1);
      border:2px solid rgba(255,203,5,.3);
      border-radius:12px;
      padding:10px;
      text-align:center;
      cursor:pointer;
      transition:all .3s;
    }
    .pokemon-select-card:hover{
      border-color:#ffcb05;
      transform:scale(1.05);
      background:rgba(255,203,5,.2);
    }
    .pokemon-select-card.selected{
      border-color:#4caf50;
      background:rgba(76,175,80,.3);
      box-shadow:0 0 15px rgba(76,175,80,.5);
    }
    .pokemon-select-card img{
      width:80px;
      height:80px;
      object-fit:contain;
    }
    .pokemon-select-card .name{
      font-size:0.85rem;
      margin-top:5px;
      color:#fff;
    }

    /* Opponent Count Modal */
    #opponentCountModal .select-panel{max-width:400px;}
    #opponentSlider{width:80%;margin:1rem auto;display:block;}
    #sliderValue{font-size:1.4rem;font-weight:700;color:#ffcb05;}

    /* Battle Animations */
    @keyframes shake{
      0%,100%{transform:translateX(0);}
      25%{transform:translateX(-10px);}
      75%{transform:translateX(10px);}
    }
    @keyframes flash{
      0%,100%{opacity:1;filter:brightness(1);}
      50%{opacity:0.7;filter:brightness(1.5);}
    }
    @keyframes hit{
      0%{transform:scale(1);}
      50%{transform:scale(0.9);}
      100%{transform:scale(1);}
    }
    @keyframes attack{
      0%{transform:translateX(0);}
      50%{transform:translateX(20px);}
      100%{transform:translateX(0);}
    }
    .pokemon.shake{animation:shake 0.5s ease-in-out;}
    .pokemon.flash{animation:flash 0.3s ease-in-out 3;}
    .pokemon.hit{animation:hit 0.3s ease-in-out;}
    .pokemon.attack{animation:attack 0.4s ease-in-out;}

    /* Sound controls */
    .sound-controls{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:100;
      display:flex;
      gap:10px;
    }
    .sound-btn{
      background:rgba(0,0,0,.7);
      border:2px solid #ffcb05;
      border-radius:50%;
      width:50px;
      height:50px;
      color:#ffcb05;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.3rem;
      transition:all .3s;
    }
    .sound-btn:hover{
      background:rgba(255,203,5,.2);
      transform:scale(1.1);
    }
  </style>
</head>
<body>
  <header>
    <div><h1>Pokémon Arena</h1></div>
    <nav>
      <a href="home.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="history.html">History</a>
      <a href="settings.html">Settings</a>
      <span class="coins" id="coinDisplay">0 Coins</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </nav>
  </header>

  <div class="container">
    <div class="title">Round-Robin Battle Arena</div>
    <div class="subtitle">Choose your Pokémon, select opponents, and compete in a full tournament!</div>

    <!-- Tournament Setup Buttons -->
    <div id="tournamentSetup">
      <button class="move-btn" id="choosePokemonBtn">1. Choose Your Pokémon</button>
      <button class="move-btn" id="chooseOpponentsBtn" disabled>2. Choose # Opponents</button>
      <button class="move-btn" id="startTournamentBtn" disabled>3. Start Tournament</button>
    </div>

    <div class="battlefield">
      <div class="pokemon" id="playerPokemon">
        <div class="name" id="playerName">Pikachu</div>
        <img id="playerSprite" src="" alt="You">
        <div class="hp-bar"><div class="hp-fill" id="playerHP"></div><div class="hp-text" id="playerHPText">100/100</div></div>
      </div>
      <div class="pokemon" id="opponentPokemon">
        <div class="name" id="opponentName">???</div>
        <img id="opponentSprite" src="" alt="Opponent">
        <div class="hp-bar"><div class="hp-fill" id="opponentHP"></div><div class="hp-text" id="opponentHPText">100/100</div></div>
      </div>
    </div>

    <div class="moves">
      <button class="move-btn" data-move="thunderbolt">Thunderbolt</button>
      <button class="move-btn" data-move="quickattack">Quick Attack</button>
      <button class="move-btn" data-move="irontail">Iron Tail</button>
      <button class="move-btn" data-move="run">Run Away</button>
    </div>

    <div class="log" id="battleLog">
      <p class="system">Set up your tournament to begin...</p>
    </div>

    <!-- Scoreboard -->
    <div id="scoreboard">
      <div class="title" style="text-align:center;">Tournament Standings</div>
      <table>
        <thead>
          <tr><th>Rank</th><th>Trainer</th><th>W</th><th>L</th><th>Pts</th></tr>
        </thead>
        <tbody id="scoreboardBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Pokemon Selection Modal -->
  <div class="pokemon-select-modal" id="pokemonSelectModal">
    <div class="select-panel">
      <div class="select-title">Choose Your Pokemon</div>
      <div class="pokemon-select-grid" id="pokemonSelectGrid"></div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="move-btn" id="confirmSelectBtn" style="max-width:200px;">Confirm Selection</button>
        <button class="move-btn" id="cancelSelectBtn" style="max-width:200px;background:#666;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Opponent Count Modal -->
  <div class="pokemon-select-modal" id="opponentCountModal">
    <div class="select-panel">
      <div class="select-title">How many opponents? (3-12)</div>
      <input type="range" id="opponentSlider" min="3" max="12" value="5">
      <div id="sliderValue">5</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:1rem;">
        <button class="move-btn" id="confirmCountBtn">OK</button>
        <button class="move-btn" style="background:#666;" id="cancelCountBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Sound Controls with Font Awesome Icons -->
  <div class="sound-controls">
    <button class="sound-btn" id="musicToggle" title="Toggle Music">
      <i class="fas fa-music"></i>
    </button>
    <button class="sound-btn" id="soundToggle" title="Toggle Sounds">
      <i class="fas fa-volume-high"></i>
    </button>
  </div>

  <script>
    /* ==============================================================
       ROUND-ROBIN TOURNAMENT ENGINE + UI FIXES
       ============================================================== */
    const session = JSON.parse(localStorage.getItem('trainerSession'));
    if (!session) location.href = 'index.html';

    // Web3 placeholders (keep if needed, but not used in tournament)
    const NFT_ADDRESS = '0xYourPokemonNFTAddressHere';
    const BADGE_ADDRESS = '0xYourBadgeAddressHere';

    const USER_ID = session.type === 'metamask' ? session.address.toLowerCase() : session.address.toLowerCase();
    const ns = k => `${USER_ID}:${k}`;
    const COIN_KEY = ns('coins');
    const OWNED_KEY = ns('owned');
    const EQUIPPED_KEY = ns('equipped');

    /* ---------- BASIC HELPERS ---------- */
    function getCoins(){ return parseInt(localStorage.getItem(COIN_KEY) || '0'); }
    function setCoins(v){ localStorage.setItem(COIN_KEY, String(v)); document.getElementById('coinDisplay').textContent = v + ' Coins'; }
    if (localStorage.getItem(COIN_KEY)===null) setCoins(500); else setCoins(getCoins());

    const walletDisplay = document.getElementById('walletDisplay');
    if (session.type === 'metamask') walletDisplay.textContent = session.address.slice(0,6)+"..."+session.address.slice(-4);
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('trainerSession'); location.href = 'index.html'; };

    /* ---------- POKÉMON OWNERSHIP ---------- */
    let ownedPokemon = JSON.parse(localStorage.getItem(OWNED_KEY) || '[]');
    const shopOwned = JSON.parse(localStorage.getItem('owned') || '[]'); // legacy
    if (shopOwned.length > 0) {
      shopOwned.forEach(p => { if (!ownedPokemon.find(op => op.id === p.id)) ownedPokemon.push(p); });
    }
    if (ownedPokemon.length===0 || !ownedPokemon.find(p=>p.id===25)){
      ownedPokemon.push({id:25, name:'Pikachu'});
      localStorage.setItem(OWNED_KEY, JSON.stringify(ownedPokemon));
    }
    let equippedId = parseInt(localStorage.getItem(EQUIPPED_KEY) || '25');

    /* ---------- UI ELEMENTS ---------- */
    const playerSprite = document.getElementById('playerSprite');
    const playerName   = document.getElementById('playerName');
    const playerHP     = document.getElementById('playerHP');
    const playerHPText = document.getElementById('playerHPText');

    const opponentSprite = document.getElementById('opponentSprite');
    const opponentName   = document.getElementById('opponentName');
    const opponentHP     = document.getElementById('opponentHP');
    const opponentHPText = document.getElementById('opponentHPText');

    const battleLog = document.getElementById('battleLog');
    const moveButtons = document.querySelectorAll('.move-btn[data-move]');

    const choosePokemonBtn   = document.getElementById('choosePokemonBtn');
    const chooseOpponentsBtn = document.getElementById('chooseOpponentsBtn');
    const startTournamentBtn = document.getElementById('startTournamentBtn');

    const opponentCountModal = document.getElementById('opponentCountModal');
    const opponentSlider     = document.getElementById('opponentSlider');
    const sliderValue        = document.getElementById('sliderValue');
    const confirmCountBtn    = document.getElementById('confirmCountBtn');
    const cancelCountBtn     = document.getElementById('cancelCountBtn');

    const scoreboard     = document.getElementById('scoreboard');
    const scoreboardBody = document.getElementById('scoreboardBody');

    /* ---------- SOUND SYSTEM (unchanged from original) ---------- */
    let musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
    let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
    let currentMusic = null;

    function tone(freq, duration = 0.1, volume = 0.12, type = 'sine') {
      if (!soundsEnabled) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(volume, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    }

    function playAttackSound(moveKey) {
      if (!soundsEnabled) return;
      switch (moveKey) {
        case 'thunderbolt':
          tone(800, 0.08, 0.25, 'sawtooth');
          setTimeout(() => tone(600, 0.08, 0.25, 'sawtooth'), 40);
          setTimeout(() => tone(400, 0.08, 0.25, 'sawtooth'), 80);
          break;
        case 'quickattack':
          tone(1200, 0.06, 0.18, 'square');
          setTimeout(() => tone(900, 0.06, 0.18, 'square'), 30);
          break;
        case 'irontail':
          tone(180, 0.12, 0.28, 'square');
          setTimeout(() => tone(220, 0.10, 0.25, 'square'), 60);
          setTimeout(() => tone(150, 0.08, 0.22, 'square'), 120);
          break;
        case 'run':
          tone(500, 0.07, 0.15, 'triangle');
          setTimeout(() => tone(700, 0.07, 0.15, 'triangle'), 50);
          setTimeout(() => tone(900, 0.07, 0.15, 'triangle'), 100);
          break;
      }
    }

    function playSound(type){
      if (!soundsEnabled) return;
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      const frequencies = {
        'hit': [200, 150],
        'appear': [300, 400, 500],
        'victory': [523.25, 659.25, 783.99],
        'defeat': [200, 180, 160],
        'select': [440],
        'confirm': [523.25, 659.25]
      };
      const freq = frequencies[type] || [440];
      if (freq.length === 1) {
        oscillator.frequency.setValueAtTime(freq[0], audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      } else {
        freq.forEach((f, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(f, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            osc.start();
            osc.stop(audioContext.currentTime + 0.15);
          }, i * 100);
        });
      }
    }

    function playMusic(type){
      if (!musicEnabled) return;
      stopMusic();
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = type === 'battle' ? [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25] : [];
      let noteIndex = 0;
      function playNote(){
        if (!musicEnabled || !tournamentActive) return;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.setValueAtTime(notes[noteIndex % notes.length], audioContext.currentTime);
        gain.gain.setValueAtTime(0.05, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
        noteIndex++;
        setTimeout(playNote, 200);
      }
      playNote();
      currentMusic = { audioContext, interval: setInterval(() => {}, 100) };
    }

    function stopMusic(){
      if (currentMusic) {
        if (currentMusic.audioContext) currentMusic.audioContext.close();
        currentMusic = null;
      }
    }

    const musicBtn = document.getElementById('musicToggle');
    const soundBtn = document.getElementById('soundToggle');
    function updateIcons() {
      musicBtn.innerHTML = musicEnabled ? '<i class="fas fa-music"></i>' : '<i class="fas fa-volume-mute"></i>';
      soundBtn.innerHTML = soundsEnabled ? '<i class="fas fa-volume-high"></i>' : '<i class="fas fa-volume-mute"></i>';
    }
    musicBtn.onclick = () => { musicEnabled = !musicEnabled; localStorage.setItem('musicEnabled', musicEnabled); updateIcons(); if (!musicEnabled) stopMusic(); else if (tournamentActive) playMusic('battle'); };
    soundBtn.onclick = () => { soundsEnabled = !soundsEnabled; localStorage.setItem('soundsEnabled', soundsEnabled); updateIcons(); };
    updateIcons();

    /* ---------- BATTLE STATE ---------- */
    let player = {id:0, name:'', hp:100, maxHp:100};
    let opponent = null;
    let battleActive = false;
    let playerTurn = true;
    let tournamentActive = false;

    const moves = {
      thunderbolt: { name: 'Thunderbolt', power: 30, color: '#ffeb3b' },
      quickattack: { name: 'Quick Attack', power: 20, color: '#81c784' },
      irontail: { name: 'Iron Tail', power: 40, color: '#9e9e9e' },
      run: { name: 'Run Away', power: 0, color: '#ff9800', run: true }
    };

    /* ---------- HP & LOG ---------- */
    function updateHP(bar, txt, hp, max){
      const pct = (hp/max)*100;
      bar.style.width = pct+'%';
      txt.textContent = `${hp}/${max}`;
      bar.style.background = pct>50?'#4caf50':pct>25?'#ff9800':'#f44336';
    }
    function log(msg,cls=''){ const p=document.createElement('p'); p.innerHTML=msg; if(cls)p.className=cls; battleLog.appendChild(p); battleLog.scrollTop=battleLog.scrollHeight; }

    /* ---------- POKÉMON SELECTION ---------- */
    let selectedPokemonId = equippedId;
    function showPokemonSelection(){
      const grid = document.getElementById('pokemonSelectGrid');
      grid.innerHTML='';
      ownedPokemon.forEach(p=>{
        const card=document.createElement('div');
        card.className=`pokemon-select-card ${p.id===selectedPokemonId?'selected':''}`;
        card.innerHTML=`<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png" alt="${p.name}">
                        <div class="name">${p.name}</div>`;
        card.onclick=()=>{ document.querySelectorAll('.pokemon-select-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); selectedPokemonId=p.id; playSound('select'); };
        grid.appendChild(card);
      });
      document.getElementById('pokemonSelectModal').classList.add('active');
    }
    choosePokemonBtn.onclick = showPokemonSelection;
    document.getElementById('confirmSelectBtn').onclick = ()=>{ 
      equippedId=selectedPokemonId; localStorage.setItem(EQUIPPED_KEY,String(equippedId)); 
      loadPlayer(); document.getElementById('pokemonSelectModal').classList.remove('active'); 
      playSound('confirm'); chooseOpponentsBtn.disabled = false;
    };
    document.getElementById('cancelSelectBtn').onclick = ()=>{ selectedPokemonId=equippedId; document.getElementById('pokemonSelectModal').classList.remove('active'); };

    /* ---------- TOURNAMENT STATE ---------- */
    let opponents = [];
    let currentMatch = 0;
    let playerStats = {wins:0, losses:0};

    /* ---------- OPPONENT COUNT ---------- */
    chooseOpponentsBtn.onclick = () => opponentCountModal.classList.add('active');
    opponentSlider.oninput = () => sliderValue.textContent = opponentSlider.value;
    confirmCountBtn.onclick = () => {
      const n = parseInt(opponentSlider.value);
      opponentCountModal.classList.remove('active');
      generateOpponents(n);
      startTournamentBtn.disabled = false;
      log(`<span class="system">Generated ${n} opponents. Ready to start!</span>`);
    };
    cancelCountBtn.onclick = () => opponentCountModal.classList.remove('active');

    async function generateOpponents(count){
      const used = new Set([equippedId]);
      opponents = [];
      while(opponents.length < count){
        const id = Math.floor(Math.random()*150)+1;
        if(used.has(id)) continue;
        used.add(id);
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        const data = await res.json();
        opponents.push({id, name: data.name.charAt(0).toUpperCase()+data.name.slice(1), hp:100, maxHp:100, wins:0, losses:0});
      }
    }

    /* ---------- START TOURNAMENT ---------- */
    startTournamentBtn.onclick = async () => {
      if(opponents.length===0) return;
      tournamentActive = true;
      battleActive = false;
      currentMatch = 0;
      playerStats = {wins:0, losses:0};
      scoreboard.style.display = 'none';
      document.getElementById('tournamentSetup').style.display = 'none';
      moveButtons.forEach(b=>b.disabled=true);
      battleLog.innerHTML = '';
      log(`<span class="system">=== ROUND-ROBIN TOURNAMENT BEGIN ===</span>`);
      playMusic('battle');
      await startNextMatch();
    };

    async function startNextMatch(){
      if(currentMatch >= opponents.length){ endTournament(); return; }
      opponent = opponents[currentMatch];
      battleActive = true;
      playerTurn = true;
      moveButtons.forEach(b=>b.disabled=false);
      loadPlayer();
      loadOpponent(opponent);
      log(`<span class="system">Match ${currentMatch+1}/${opponents.length}: <strong>${player.name}</strong> vs <strong>${opponent.name}</strong></span>`);
      playSound('appear');
    }

    function loadPlayer(){
      const p = ownedPokemon.find(x=>x.id===equippedId) || ownedPokemon[0];
      player.id = p.id; player.name = p.name; player.hp = player.maxHp = 100;
      playerSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png`;
      playerName.textContent = p.name;
      updateHP(playerHP, playerHPText, player.hp, player.maxHp);
    }

    function loadOpponent(o){
      opponentSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${o.id}.png`;
      opponentName.textContent = o.name;
      opponent.hp = opponent.maxHp = 100;
      updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
      opponentSprite.style.opacity = '0'; opponentSprite.style.transform = 'scale(0)';
      setTimeout(() => { opponentSprite.style.transition = 'all 0.5s ease'; opponentSprite.style.opacity = '1'; opponentSprite.style.transform = 'scale(1)'; }, 100);
    }

    /* ---------- BATTLE MOVES ---------- */
    moveButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!battleActive || !playerTurn) return;
        const key = btn.dataset.move;
        const move = moves[key];
        if (move.run) {
          log(`<strong>${player.name}</strong> ran away.`, 'system');
          playAttackSound('run');
          await endMatch(false, true);
          return;
        }
        document.getElementById('playerPokemon').classList.add('attack');
        playAttackSound(key);
        setTimeout(() => document.getElementById('playerPokemon').classList.remove('attack'), 400);

        const dmg = Math.floor(Math.random()*8) + move.power;
        opponent.hp = Math.max(0, opponent.hp - dmg);
        log(`<strong>${player.name}</strong> used <span style="color:${move.color}">${move.name}</span>!`);
        await new Promise(r => setTimeout(r, 300));
        const oppEl = document.getElementById('opponentPokemon');
        oppEl.classList.add('hit', 'shake'); playSound('hit');
        setTimeout(() => oppEl.classList.remove('hit', 'shake'), 500);
        log(`${opponent.name} took <strong>${dmg}</strong> damage.`);
        updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
        if (opponent.hp === 0) { playSound('victory'); await new Promise(r => setTimeout(r, 400)); await endMatch(true); return; }

        playerTurn = false;
        moveButtons.forEach(b => b.disabled = true);
        await new Promise(r => setTimeout(r, 900));

        document.getElementById('opponentPokemon').classList.add('attack');
        setTimeout(() => document.getElementById('opponentPokemon').classList.remove('attack'), 400);

        const oppDmg = Math.floor(Math.random()*25) + 15;
        player.hp = Math.max(0, player.hp - oppDmg);
        log(`${opponent.name} attacked! You took <strong>${oppDmg}</strong> damage.`);
        await new Promise(r => setTimeout(r, 300));
        const playerEl = document.getElementById('playerPokemon');
        playerEl.classList.add('hit', 'shake'); playSound('hit');
        setTimeout(() => playerEl.classList.remove('hit', 'shake'), 500);
        updateHP(playerHP, playerHPText, player.hp, player.maxHp);
        if (player.hp === 0) { playSound('defeat'); await new Promise(r => setTimeout(r, 400)); await endMatch(false); return; }

        playerTurn = true;
        moveButtons.forEach(b => b.disabled = false);
      });
    });

    /* ---------- END MATCH ---------- */
    async function endMatch(playerWon, ran = false){
      battleActive = false;
      moveButtons.forEach(b => b.disabled = true);
      if (playerWon && !ran){
        playerStats.wins++;
        opponents[currentMatch].losses++;
        const reward = 100;
        setCoins(getCoins() + reward);
        log(`<strong style="color:#4caf50;">Victory!</strong> ${trophySvg()} +${reward} coins`);
      } else if (ran){
        playerStats.losses++;
        opponents[currentMatch].wins++;
        log(`<strong style="color:#ff9800;">You escaped.</strong>`);
      } else {
        playerStats.losses++;
        opponents[currentMatch].wins++;
        log(`<strong style="color:#f44336;">Defeat…</strong>`);
      }
      await new Promise(r => setTimeout(r, 1500));
      currentMatch++;
      if (currentMatch < opponents.length) await startNextMatch();
      else endTournament();
    }

    /* ---------- END TOURNAMENT ---------- */
    function endTournament(){
      tournamentActive = false;
      stopMusic();
      log(`<span class="system">=== TOURNAMENT COMPLETE ===</span>`);
      const standings = [
        {name: player.name, wins: playerStats.wins, losses: playerStats.losses, pts: playerStats.wins * 3},
        ...opponents.map(o => ({name: o.name, wins: o.wins, losses: o.losses, pts: o.wins * 3}))
      ];
      standings.sort((a,b) => b.pts - a.pts || b.wins - a.wins);
      scoreboardBody.innerHTML = '';
      standings.forEach((s,i) => {
        const tr = document.createElement('tr');
        tr.style.background = i===0 ? 'rgba(255,203,5,.3)' : i%2 ? 'rgba(255,255,255,.05)' : 'transparent';
        tr.innerHTML = `<td>${i+1}</td><td>${s.name}${i===0?' (You)':''}</td><td>${s.wins}</td><td>${s.losses}</td><td>${s.pts}</td>`;
        scoreboardBody.appendChild(tr);
      });
      scoreboard.style.display = 'block';
      if (standings[0].name === player.name){
        const champReward = 500;
        setCoins(getCoins() + champReward);
        log(`<strong style="color:#ffeb3b;">Champion! +${champReward} coins ${trophySvg()}</strong>`);
      }
      document.getElementById('tournamentSetup').style.display = 'flex';
      chooseOpponentsBtn.disabled = false;
      startTournamentBtn.disabled = true;
    }

    function trophySvg(){
      return '<svg class="trophy" width="18" height="18" viewBox="0 0 24 24" fill="#ffeb3b" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h12v3h3v4a5 5 0 0 1-5 5h-1.1A5.002 5.002 0 0 1 12 17a5.002 5.002 0 0 1-2.9-3H8a5 5 0 0 1-5-5V5h3V2Zm12 5V4H6v3H4v2a3 3 0 0 0 3 3h1.18A5.988 5.988 0 0 1 12 10c1.55 0 2.97.59 4.02 1.56L17 12a3 3 0 0 0 3-3V7h-2Zm-6 7a3 3 0 0 0 2.83-2H9.17A3 3 0 0 0 12 14Zm-4 4h8v2H8v-2Z"/></svg>';
    }

    /* ---------- INITIAL STATE ---------- */
    loadPlayer(); // show default Pokémon
    chooseOpponentsBtn.disabled = true;
    startTournamentBtn.disabled = true;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Arena</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link rel="icon" href="images/favicon.png" sizes="32x32">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      min-height:100vh;
      color:white;
      background:#000000;
      font-family:'Inter',sans-serif;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POK√âMON</text></svg>') repeat;
      opacity:0.3;z-index:0;pointer-events:none;
    }
    body > header, body > .container{position:relative;z-index:1;}

    /* Sidebar */
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;margin:0;text-shadow:2px 2px 0 #000}
    .menu{padding:12px}
    .menu a{display:block;color:#ffcb05;text-decoration:none;font-weight:700;padding:10px 12px;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin-bottom:10px;transition:.2s;display:flex;align-items:center;gap:10px}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(4px)}
    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{color:#efe339;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .logout-btn{background:#f44336;color:#fff;border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{max-width:1200px;margin:0 auto;padding:2rem 1rem;margin-left:240px}
    .title{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.3rem;margin:2rem 0 0.5rem;text-shadow:1px 1px 0 #000;}
    .subtitle{color:#aaa;font-size:0.95rem;margin-bottom:1rem;}

    .wizard {
      max-width: 900px;
      margin: 2rem auto;
      overflow: hidden;
      border-radius: 20px;
      background: rgba(10, 15, 29, 0.95);
      border: 3px solid #ffcb05;
      box-shadow: 0 0 30px rgba(255,203, 5, 0.2);
      position: relative;
    }

    .wizard-slide {
      padding: 30px;
      display: none;
      animation: fadeIn 0.6s ease;
    }

    .wizard-slide.active { display: block; }

    .slide-title {
      font-family: 'Press Start 2P', cursive;
      color: #ffcb05;
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px 0 #000;
    }

    /* MUSIC SELECTOR */
    .music-selector {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .music-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 15px;
      border: 2px solid rgba(255,203,5,0.3);
      border-radius: 12px;
      transition: all 0.3s;
      background: rgba(255,255,255,0.05);
    }

    .music-option:hover, .music-option.selected {
      border-color: #ffcb05;
      background: rgba(255,203,5,0.15);
      box-shadow: 0 0 20px rgba(255,203,5,0.3);
    }

    .music-option i {
      font-size: 3rem;
      color: #ffcb05;
    }

    .music-option span {
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
    }

/* POK√âMON CAROUSEL ‚Äì 3-card view with focus on centre */
.pokemon-carousel-container {
  position: relative;
 
  margin: 20px 0;
  border-radius: 16px;
  background: rgba(0,0,0,0.3);
  border: 2px solid rgba(255,203,5,0.3);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  overflow: hidden;              
}
.pokemon-carousel {
 
  display: flex;
  width: 1500px;  
                 margin-left:100px;
  transition: transform 0.55s cubic-bezier(0.25,0.8,0.25,1);
  gap: 20px;                        
}
.carousel-card {
  min-width: 33.333%;            
  flex: 0 0 33.333%;
 
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg,#1e1e1e,#0f0f0f);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  transition: transform 0.5s cubic-bezier(0.25,0.8,0.25,1),
              opacity 0.5s ease,
              filter 0.5s ease,
              box-shadow 0.5s ease;
  transform: scale(0.86);
  opacity: 0.48;
  filter: blur(1.2px);
  user-select: none;
}

/* ---- ACTIVE (centre) ---- */
.carousel-card.active {
  transform: scale(1);
  opacity: 1;
  filter: blur(0);
  box-shadow: 0 22px 44px rgba(255,203,5,0.35),
              0 0 35px rgba(255,203,5,0.25);
  border: 2px solid rgba(255,203,5,0.85);
  z-index: 10;
}

/* ---- ADJACENT (previous / next) ---- */
.carousel-card.adjacent {
  transform: scale(0.92);
  opacity: 0.72;
  filter: blur(0.6px);
}

    .card-header {
      height: 180px;
      background: linear-gradient(to bottom, #4a90e2, #2171b5);
      position: relative;
      overflow: hidden;
    }

    .card-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
      animation: shimmer 8s infinite linear;
    }

    @keyframes shimmer {
      0% { transform: translateX(-50%) translateY(-50%) rotate(0deg); }
      100% { transform: translateX(-50%) translateY(-50%) rotate(360deg); }
    }

    .card-header.squirtle { background: linear-gradient(to bottom, #4a90e2, #2171b5); }
    .card-header.charmander { background: linear-gradient(to bottom, #ff7043, #e64a19); }
    .card-header.bulbasaur { background: linear-gradient(to bottom, #66bb6a, #388e3c); }

    .card-pokemon-img {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 180px;
      object-fit: contain;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7));
      z-index: 2;
    }

    .card-body {
      padding: 30px 20px 20px;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .card-name {
      font-family: 'Press Start 2P', cursive;
      font-size: 1.6rem;
      color: #ffcb05;
      text-shadow: 2px 2px 0 #000;
      margin-bottom: 8px;
    }

    .card-id {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 12px;
    }

    .card-type {
      display: inline-block;
      padding: 6px 16px;
      background: rgba(255,255,255,0.2);
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 16px;
      border: 2px solid rgba(255,203,5,0.4);
    }

    .card-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat {
      text-align: center;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .stat-bar {
      height: 10px;
      background: rgba(0,0,0,0.5);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .stat-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      border-radius: 5px;
      transition: width 0.4s ease;
    }

    .card-flavor {
      font-style: italic;
      color: #ddd;
      font-size: 0.9rem;
      line-height: 1.4;
      opacity: 0.9;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    .card-pokeball {
      width: 50px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, #fff 10%, #f44336 11%, #f44336 45%, #fff 46%, #fff 54%, #222 55%);
      border-radius: 50%;
      margin: 0 auto 10px;
      border: 3px solid #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      position: relative;
    }

    .card-pokeball::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      border: 3px solid #222;
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,203,5,0.2);
      border: 2px solid #ffcb05;
      color: #fff;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .carousel-nav:hover {
      background: #ffcb05;
      color: #000;
      transform: translateY(-50%) scale(1.1);
    }

    .carousel-nav.left { left: 10px; }
    .carousel-nav.right { right: 10px; }

    /* OPPONENT SLIDER */
    .slider-container {
      margin: 30px 0;
      text-align: center;
    }

    #opponentSlider {
      width: 80%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.2);
      outline: none;
      -webkit-appearance: none;
    }

    #opponentSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #ffcb05;
      cursor: pointer;
      border: 3px solid #000;
      box-shadow: 0 0 10px rgba(255,203,5,0.6);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-weight: 600;
      color: #ffcb05;
    }

    #sliderValue {
      font-size: 1.8rem;
      font-family: 'Press Start 2P';
    }

    .opponent-preview {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
      min-height: 80px;
    }

    .preview-card {
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,203,5,0.3);
      border-radius: 12px;
      overflow: hidden;
      animation: popIn 0.3s ease forwards;
      opacity: 0;
      transform: scale(0);
    }

    .preview-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .tournament-summary {
      text-align: center;
      font-size: 1.1rem;
      margin: 20px 0;
      color: #ddd;
    }

    .tournament-summary strong { color: #ffcb05; }

    .start-countdown {
      font-family: 'Press Start 2P';
      font-size: 4rem;
      text-align: center;
      margin: 30px 0;
      color: #ffcb05;
      text-shadow: 0 0 20px #ffcb05;
      animation: pulse 1s infinite;
    }

    .pulse {
      animation: pulseBtn 2s infinite;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes pulseBtn { 0%,100% { box-shadow: 0 0 20px rgba(255,203,5,0.4); } 50% { box-shadow: 0 0 40px rgba(255,203,5,0.8); } }

    .wizard-actions {
      text-align: center;
      margin-top: 30px;
    }

    .wizard-actions .move-btn {
      min-width: 220px;
      font-size: 1.1rem;
      padding: 16px 24px;
    }

    /* BATTLE ARENA */
    .arena-layout{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    .side-col{position:sticky;top:72px;height:fit-content}
    .battlefield{display:flex;justify-content:space-between;align-items:flex-end;width:100%;max-width:1300px;min-height:400px;margin:8px auto;position:relative;border-radius:20px;padding:16px;background:radial-gradient(circle at 50% 120%, rgba(30,30,30,.92) 0%, rgba(0,0,0,.75) 48%, rgba(0,0,0,.5) 70%, rgba(0,0,0,0) 73%), repeating-linear-gradient(90deg, rgba(255,255,255,.05) 0 2px, transparent 2px 6px); box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 -12px 30px rgba(0,0,0,.6);}
    .battlefield::after{content:'';position:absolute;left:50%;top:58%;width:520px;height:220px;transform:translate(-50%,-20%);border-radius:50%;background:radial-gradient(ellipse at center, rgba(0,0,0,.9) 0%, rgba(0,0,0,.45) 60%, rgba(0,0,0,0) 72%);filter:blur(2px);z-index:0}
    .pokemon{position:relative;text-align:center;min-width:260px;z-index:1}
    .pokemon .platform{position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);width:260px;height:36px;border-radius:50%;background:radial-gradient(ellipse at center, rgba(0,0,0,.8) 0%, rgba(0,0,0,.2) 70%, rgba(0,0,0,0) 75%);filter:blur(1px);z-index:-1}
    .pokemon img{width:260px;height:260px;object-fit:contain;filter: drop-shadow(0 10px 20px rgba(0,0,0,.7));}
    .hp-bar{background:#333;border:2px solid #ffcb05;border-radius:10px;height:22px;width:240px;margin:10px auto;position:relative;overflow:hidden;}
    .hp-fill{height:100%;background:#4caf50;border-radius:8px;transition:width .5s ease,background .3s;}
    .hp-text{position:absolute;top:0;left:0;right:0;text-align:center;font-weight:600;font-size:13px;color:white;text-shadow:1px 1px 2px #000;}
    .name{font-weight:700;color:#ffcb05;font-size:1.2rem;text-shadow:1px 1px 3px #000;margin-bottom:4px;font-family:'Inter',system-ui}

    .command-bar{margin:8px auto 0;max-width:1000px;background:rgba(0,0,0,.55);border:2px solid rgba(255,203,5,.35);border-radius:14px;padding:10px 10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.5)}
    .command-title{color:#ffcb05;font-weight:800;letter-spacing:1px;margin:2px 6px 10px}
    .moves{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:10px;margin:0 auto;max-width:960px;padding:0 2px}
    .move-btn{position:relative;isolation:isolate;padding:16px 18px;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));border:2.5px solid #ffcb05;border-radius:14px;color:white;font-weight:800;cursor:pointer;transition:.18s;font-family:'Inter',system-ui;text-transform:uppercase;letter-spacing:1px;box-shadow:0 6px 16px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.08)}
    .move-btn:hover{background:linear-gradient(180deg, rgba(255,203,5,.25), rgba(255,203,5,.12));transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.55), 0 0 18px rgba(255,203,5,.25)} 
    .move-btn:active{transform:translateY(0);filter:saturate(1.2)}
    .move-btn:disabled{background:rgba(80,80,80,.35);cursor:not-allowed;opacity:.65;border-color:rgba(255,255,255,.15);box-shadow:none}
    .move-btn .glow{position:absolute;inset:-2px;border-radius:14px;background:radial-gradient(120px 40px at var(--mx,50%) -10%, rgba(255,203,5,.35), transparent 70%);opacity:.8;pointer-events:none;transition:opacity .2s}
    .move-btn .ripple{position:absolute;inset:0;border-radius:inherit;overflow:hidden;pointer-events:none}
    .move-btn .ripple::after{content:'';position:absolute;width:10px;height:10px;left:var(--rx,50%);top:var(--ry,50%);background:rgba(255,255,255,.35);border-radius:50%;transform:translate(-50%,-50%) scale(0);animation:ripple .6s ease-out}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(18);opacity:0}}

    .log{background:rgba(0,0,0,.6);padding:12px;border-radius:12px;max-height:220px;overflow-y:auto;font-size:14px;margin:0 0 12px 0;border:1px solid rgba(255,203,5,.3);font-family:'Inter',system-ui}
    .log p{margin:6px 0;opacity:.9;}
    .system{color:#ffcb05;font-weight:600}
    .trophy{vertical-align:middle;margin-left:6px}

    #scoreboard table{width:100%;border-collapse:collapse;}
    #scoreboard th, #scoreboard td{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);}
    #scoreboard thead{background:rgba(255,203,5,.2);}
    #scoreboard tbody tr:nth-child(even){background:rgba(255,255,255,.05);}

    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-10px);}75%{transform:translateX(10px);}}
    @keyframes flash{0%,100%{opacity:1;filter:brightness(1);}50%{opacity:0.7;filter:brightness(1.5);}}
    @keyframes hit{0%{transform:scale(1);}50%{transform:scale(0.9);}100%{transform:scale(1);}}
    @keyframes attack{0%{transform:translateX(0);}50%{transform:translateX(20px);}100%{transform:translateX(0);}}
    .pokemon.shake{animation:shake 0.5s ease-in-out;}
    .pokemon.flash{animation:flash 0.3s ease-in-out 3;}
    .pokemon.hit{animation:hit 0.3s ease-in-out;}
    .pokemon.attack{animation:attack 0.4s ease-in-out;}

    .sound-controls{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:100;
      display:flex;
      gap:10px;
    }
    .sound-btn{
      background:rgba(0,0,0,.7);
      border:2px solid #ffcb05;
      border-radius:50%;
      width:50px;
      height:50px;
      color:#ffcb05;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.3rem;
      transition:all .3s;
    }
    .sound-btn:hover{
      background:rgba(255,203,5,.2);
      transform:scale(1.1);
    }

    /* ATTACK ANIMATION SYSTEM */
    .attack-effect {
      position: absolute;
      pointer-events: none;
      z-index: 100;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      opacity: 0;
      transform: scale(0.3);
    }

    .attack-trail {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 15px #ffeb3b, 0 0 30px #ff9800;
      opacity: 0;
      pointer-events: none;
      z-index: 99;
    }

    .impact-flash {
      position: absolute;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, #ffffff 10%, #ffeb3b 40%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 101;
      opacity: 0;
      transform: scale(0);
      animation: impactFlash 0.4s ease-out forwards;
    }

    .lightning-bolt {
      position: absolute;
      width: 6px;
      height: 80px;
      background: #ffeb3b;
      clip-path: polygon(40% 0%, 60% 0%, 50% 30%, 70% 30%, 55% 60%, 75% 60%, 50% 100%, 45% 60%, 25% 60%, 45% 30%, 30% 30%, 50% 0%);
      transform-origin: center;
      animation: lightningStrike 0.6s ease-out;
      opacity: 0;
      z-index: 102;
    }

    @keyframes lightningStrike {
      0% { opacity: 0; transform: scaleY(0); }
      20% { opacity: 1; transform: scaleY(1.2); }
      40% { opacity: 0.8; transform: scaleY(0.9); }
      100% { opacity: 0; transform: scaleY(1); }
    }

    @keyframes impactFlash {
      0% { opacity: 0; transform: scale(0.2); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(1.8); }
    }

    .screen-shake {
      animation: screenShake 0.5s ease-in-out;
    }

    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }

    #slide-start .wizard-actions { display:flex; justify-content:center; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><h1>PikaPlay Arena</h1></div>
    <div class="menu">
       <a href="home.html">üè† Home</a>
        <a href="shop.html">üõí Marketplace</a>
      <a href="arena.html">‚öî Game Play</a>
      <a href="settings.html">‚öô Settings</a>
    </div>
    <div class="status">
      <span class="coins" id="coinDisplay">0 Coins</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <div class="title">Round-Robin Battle Arena</div>
    <div class="subtitle">Prepare your champion. Conquer the tournament.</div>

    <!-- WIZARD -->
    <div id="setupWizard" class="wizard"  style="border:none">
      <!-- Step 0 - Music Selection -->
      <div class="wizard-slide active" id="slide-music">
        <div class="slide-title">Step 1: Choose Battle Music</div>
        <div class="music-selector">
          <div class="music-option selected" data-music="classic">
            <i class="fas fa-music"></i>
            <span>Classic<br>Synth</span>
          </div>
          <div class="music-option" data-music="real">
            <i class="fas fa-headphones"></i>
            <span>Real Pok√©mon<br>Battle Theme</span>
          </div>
        </div>
        <div class="wizard-actions">
          <button class="move-btn" id="confirmMusicBtn">Next</button>
        </div>
      </div>

      <!-- Step 1 -->
      <div class="wizard-slide" id="slide-pokemon" style="border:none">
        <div class="slide-title">Step 2: Choose Your Pok√©mon</div>
        <div class="pokemon-carousel-container">
          <button class="carousel-nav left" id="prevPokemon"><i class="fas fa-chevron-left"></i></button>
          <div class="pokemon-carousel" id="pokemonCarousel"></div>
          <button class="carousel-nav right" id="nextPokemon"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="wizard-actions">
          <button class="move-btn" id="confirmPokemonBtn" disabled>Confirm</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="wizard-slide" id="slide-opponents">
        <div class="slide-title">Step 3: Select Opponent Count</div>
        <div class="opponent-preview" id="opponentPreview"></div>
        <div class="slider-container">
          <input type="range" id="opponentSlider" min="3" max="12" value="5">
          <div class="slider-labels">
            <span>3</span>
            <span id="sliderValue">5</span>
            <span>12</span>
          </div>
        </div>
        <div class="wizard-actions">
          <button class="move-btn" id="confirmOpponentsBtn">Next</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="wizard-slide" id="slide-start">
        <div class="slide-title">Final Step: Launch Tournament!</div>
        <div class="tournament-summary">
          <div><strong>Champion:</strong> <span id="finalPokemonName">???</span></div>
          <div><strong>Opponents:</strong> <span id="finalOpponentCount">0</span></div>
        </div>
        <div class="start-countdown" id="startCountdown">3</div>
        <div class="wizard-actions">
          <button class="move-btn pulse" id="startTournamentBtn">START BATTLE</button>
        </div>
      </div>
    </div>

    <!-- BATTLE ARENA -->
    <div class="arena-layout" id="battleArena" style="display:none;">
      <div class="main-col">
          <!-- Background Selector Inside Command Bar -->
  <div class="bg-selector" style="margin: 12px auto 8px; max-width: 320px;">
    <select id="bgSelect" style="width: 100%; padding: 8px 12px; font-family: 'Press Start 2P'; font-size: .85rem; background: rgba(0,0,0,.6); color: #ffcb05; border: 2px solid #ffcb05; border-radius: 10px; cursor: pointer; outline: none;">
   <option value="images/pok.png">Pokemon Arena</option>
     <option value="images/rock-platform-podium-product-presentation-background_148840-40388.avif">Rock Platform</option>
      <option value="images/OIP (5).webp">Lush Forest</option>
      <option value="images/lav.jpg">Volcanic Lava</option>
       
    </select>
  </div>
        <div class="battlefield" id="battlefield" style=" background: url('images/rock-platform-podium-product-presentation-background_148840-40388.avif') center/cover no-repeat;">
          <div class="pokemon" id="playerPokemon">
            <div class="name" id="playerName">Pikachu</div>
            <img id="playerSprite" src="" alt="You">
            <div class="hp-bar"><div class="hp-fill" id="playerHP"></div><div class="hp-text" id="playerHPText">100/100</div></div>
            <div class="platform"></div>
          </div>
          <div class="pokemon" id="opponentPokemon">
            <div class="name" id="opponentName">???</div>
            <img id="opponentSprite" src="" alt="Opponent">
            <div class="hp-bar"><div class="hp-fill" id="opponentHP"></div><div class="hp-text" id="opponentHPText">100/100</div></div>
            <div class="platform"></div>
          </div>
        </div>

       <div class="command-bar">
  <div class="command-title">Choose your move</div>

 <div class="moves" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; padding:20px;">
<button class="move-btn" data-move="fire"
    style="
      position:relative; overflow:hidden; cursor:pointer;
      min-width:140px; padding:14px 20px;
      background:linear-gradient(135deg,#ff4d4d,#b30000);
      color:#fff; font-weight:800; font-size:1rem;
      border:none; border-radius:12px;
      box-shadow:0 4px 12px rgba(255,77,77,.6),
                 inset 0 -2px 6px rgba(0,0,0,.3);
      transition:transform .15s, box-shadow .15s;
    "
    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(255,77,77,.8), inset 0 -2px 6px rgba(0,0,0,.3)'"
    onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(255,77,77,.6), inset 0 -2px 6px rgba(0,0,0,.3)'"
  >
    <span style="position:absolute; inset:0; opacity:0; background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.4) 0%,transparent 50%); transition:opacity .3s;" class="glow"></span>
    <span style="position:absolute; inset:50%; width:0; height:0; background:rgba(255,255,255,.5); border-radius:50%; transform:translate(-50%,-50%); transition:.6s;" class="ripple"></span>

    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:6px;">
      <path d="M8.5 14.5C6.5 11.5 6 8 6 6c0 0 1.5 1.5 3 3 1.5-1.5 3-3 3-3 0 2-1 4.5-2.5 6.5C11 14.5 12 16 12 16s1-1.5 2.5-3.5c1.5 2 2.5 4.5 2.5 4.5 0-2-1-4.5-3-6.5-2 2-3 4.5-3 4.5z"/>
      <path d="M12 22c-2.5-1.5-4-4-4-7 0-3 1.5-5.5 3.5-7"/>
    </svg>
    Fire
  </button>

  <!-- ==== PUNCH ==== -->
  <button class="move-btn" data-move="punch"
    style="
      position:relative; overflow:hidden; cursor:pointer;
      min-width:140px; padding:14px 20px;
      background:linear-gradient(135deg,#ffaa00,#cc7700);
      color:#fff; font-weight:800; font-size:1rem;
      border:none; border-radius:12px;
      box-shadow:0 4px 12px rgba(255,170,0,.6),
                 inset 0 -2px 6px rgba(0,0,0,.3);
      transition:transform .15s, box-shadow .15s;
    "
    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(255,170,0,.8), inset 0 -2px 6px rgba(0,0,0,.3)'"
    onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(255,170,0,.6), inset 0 -2px 6px rgba(0,0,0,.3)'"
  >
    <span style="position:absolute; inset:0; opacity:0; background:radial-gradient(circle at 70% 70%,rgba(255,255,255,.4) 0%,transparent 50%); transition:opacity .3s;" class="glow"></span>
    <span style="position:absolute; inset:50%; width:0; height:0; background:rgba(255,255,255,.5); border-radius:50%; transform:translate(-50%,-50%); transition:.6s;" class="ripple"></span>

    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:6px;">
      <!-- Fist -->
      <path d="M18 11h1a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1"/>
      <path d="M14 9h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1"/>
      <path d="M10 7h1a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-1"/>
      <path d="M6 5h1a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H6"/>
      <!-- Motion lines (impact) -->
      <path d="M3 12h2"/>
      <path d="M2 15h2"/>
      <path d="M4 9h2"/>
    </svg>
    Punch
  </button>

  <!-- ==== THUNDER ==== -->
  <button class="move-btn" data-move="thunder"
    style="
      position:relative; overflow:hidden; cursor:pointer;
      min-width:140px; padding:14px 20px;
      background:linear-gradient(135deg,#ffff4d,#cccc00);
      color:#333; font-weight:800; font-size:1rem;
      border:none; border-radius:12px;
      box-shadow:0 4px 12px rgba(255,255,77,.7),
                 inset 0 -2px 6px rgba(0,0,0,.2);
      transition:transform .15s, box-shadow .15s;
    "
    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(255,255,77,.9), inset 0 -2px 6px rgba(0,0,0,.2)'"
    onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(255,255,77,.7), inset 0 -2px 6px rgba(0,0,0,.2)'"
  >
    <span style="
      position:absolute; inset:0; opacity:0;
      background:radial-gradient(circle at 50% 20%,rgba(255,255,255,.5) 0%,transparent 50%);
      transition:opacity .3s;
    " class="glow"></span>
    <span style="
      position:absolute; inset:50%; width:0; height:0;
      background:rgba(255,255,255,.6); border-radius:50%;
      transform:translate(-50%,-50%); transition:.6s;
    " class="ripple"></span>

    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle; margin-right:6px;">
      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
    </svg>
    Thunder
  </button>

  <!-- ==== RUN AWAY ==== -->
  <button class="move-btn" data-move="run"
    style="
      position:relative; overflow:hidden; cursor:pointer;
      min-width:140px; padding:14px 20px;
      background:linear-gradient(135deg,#999,#555);
      color:#fff; font-weight:800; font-size:1rem;
      border:none; border-radius:12px;
      box-shadow:0 4px 12px rgba(150,150,150,.6),
                 inset 0 -2px 6px rgba(0,0,0,.3);
      transition:transform .15s, box-shadow .15s;
    "
    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(150,150,150,.8), inset 0 -2px 6px rgba(0,0,0,.3)'"
    onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(150,150,150,.6), inset 0 -2px 6px rgba(0,0,0,.3)'"
  >
    <span style="
      position:absolute; inset:0; opacity:0;
      background:radial-gradient(circle at 20% 80%,rgba(255,255,255,.3) 0%,transparent 50%);
      transition:opacity .3s;
    " class="glow"></span>
    <span style="
      position:absolute; inset:50%; width:0; height:0;
      background:rgba(255,255,255,.4); border-radius:50%;
      transform:translate(-50%,-50%); transition:.6s;
    " class="ripple"></span>

    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle; margin-right:6px;">
      <path d="M13 17h8M13 12h8M13 7h8M3 17l4-4-4-4"/>
    </svg>
    Run Away
  </button>
</div>
</div>
      </div>

      <aside class="side-col">
        <div class="log" id="battleLog">
          <p class="system">Prepare your team...</p>
        </div>
        <div id="scoreboard" style="display:none;">
          <div class="title" style="text-align:center;">Tournament Standings</div>
          <table>
            <thead><tr><th>Rank</th><th>Trainer</th><th>W</th><th>L</th><th>Pts</th></tr></thead>
            <tbody id="scoreboardBody"></tbody>
          </table>
        </div>
      </aside>
    </div>
  </div>

  <div class="sound-controls">
    <button class="sound-btn" id="musicToggle" title="Toggle Music"><i class="fas fa-music"></i></button>
    <button class="sound-btn" id="soundToggle" title="Toggle Sounds"><i class="fas fa-volume-high"></i></button>
  </div>

  <script>
    const session = JSON.parse(localStorage.getItem('trainerSession'));
    if (!session) location.href = 'index.html';

    const USER_ID = session.type === 'metamask' ? session.address.toLowerCase() : session.address.toLowerCase();
    const ns = k => `${USER_ID}:${k}`;
    const COIN_KEY = ns('coins');
    const OWNED_KEY = ns('owned');
    const EQUIPPED_KEY = ns('equipped');

    function getCoins(){ return parseInt(localStorage.getItem(COIN_KEY) || '0'); }
    function setCoins(v){ localStorage.setItem(COIN_KEY, String(v)); localStorage.setItem('coins', String(v)); document.getElementById('coinDisplay').textContent = v + ' Coins'; }
    if (localStorage.getItem(COIN_KEY)===null) setCoins(500); else setCoins(getCoins());

    const walletDisplay = document.getElementById('walletDisplay');
    if (session.type === 'metamask') walletDisplay.textContent = session.address.slice(0,6)+"..."+session.address.slice(-4);
    document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('trainerSession'); location.href = 'index.html'; };

    // Owned Pok√©mon
    let ownedPokemon = JSON.parse(localStorage.getItem(OWNED_KEY) || '[]');
    const shopOwned = JSON.parse(localStorage.getItem('owned') || '[]');
    if (shopOwned.length > 0) { shopOwned.forEach(p => { if (!ownedPokemon.find(op => op.id === p.id)) ownedPokemon.push(p); }); }
    if (ownedPokemon.length===0 || !ownedPokemon.find(p=>p.id===25)){
      ownedPokemon.push({id:25, name:'Pikachu'});
      localStorage.setItem(OWNED_KEY, JSON.stringify(ownedPokemon));
    }
    let equippedId = parseInt(localStorage.getItem(EQUIPPED_KEY) || '25');

    // UI Elements
    const wizard = document.getElementById('setupWizard');
    const battleArena = document.getElementById('battleArena');
    const battlefield = document.getElementById('battlefield');
    const carousel = document.getElementById('pokemonCarousel');
    const prevBtn = document.getElementById('prevPokemon');
    const nextBtn = document.getElementById('nextPokemon');
    const confirmPokemonBtn = document.getElementById('confirmPokemonBtn');
    const opponentSlider = document.getElementById('opponentSlider');
    const sliderValue = document.getElementById('sliderValue');
    const opponentPreview = document.getElementById('opponentPreview');
    const confirmOpponentsBtn = document.getElementById('confirmOpponentsBtn');
    const startTournamentBtn = document.getElementById('startTournamentBtn');
    const finalPokemonName = document.getElementById('finalPokemonName');
    const finalOpponentCount = document.getElementById('finalOpponentCount');
    const startCountdown = document.getElementById('startCountdown');

    // Music selection
    const musicOptions = document.querySelectorAll('.music-option');
    const confirmMusicBtn = document.getElementById('confirmMusicBtn');
    let selectedMusicType = 'classic'; 

    let carouselIndex = 0;
    let selectedPokemon = null;
    let opponentCount = 5;
    let opponents = [];               
    let pokemonDetails = [];

    // Sound System
    let musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
    let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
    let currentMusic = null;
    let pokemonCryAudio = null;

    // Pok√©mon Cry Function
    async function playPokemonCry(pokemonId) {
      if (!soundsEnabled) return;
      
      try {
  
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
        const data = await response.json();
        const cryUrl = data.cries?.latest || `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${pokemonId}.gif`; // fallback
        
        if (data.cries && data.cries.latest) {
          const audio = new Audio(data.cries.latest);
          audio.volume = 0.3;
          audio.play().catch(e => console.log('Cry play failed:', e));
          return;
        }
        
    
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
      
        const baseFreq = 800 + (pokemonId * 10) % 400;
        osc.frequency.setValueAtTime(baseFreq, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, ctx.currentTime + 0.1);
        osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.7, ctx.currentTime + 0.3);
        
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.4);
      } catch (e) {
        tone(850, 0.1, 0.25, 'sawtooth');
        setTimeout(() => tone(950, 0.12, 0.28, 'sawtooth'), 100);
        setTimeout(() => tone(750, 0.15, 0.3, 'sawtooth'), 220);
      }
    }

    function tone(freq, duration = 0.1, volume = 0.12, type = 'sine') {
      if (!soundsEnabled) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(volume, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    }

    function playAttackSound(moveKey) {
      if (!soundsEnabled) return;
      switch (moveKey) {
        case 'fire': tone(800, 0.08, 0.25, 'sawtooth'); setTimeout(() => tone(600, 0.08, 0.25, 'sawtooth'), 40); setTimeout(() => tone(400, 0.08, 0.25, 'sawtooth'), 80); break;
        case 'punch': tone(180, 0.06, 0.3, 'square'); setTimeout(() => tone(150, 0.06, 0.28, 'square'), 30); break;
        case 'thunder': tone(1200, 0.1, 0.35, 'sawtooth'); setTimeout(() => tone(800, 0.08, 0.3, 'sawtooth'), 50); setTimeout(() => tone(400, 0.12, 0.25, 'sawtooth'), 100); break;
        case 'run': tone(500, 0.07, 0.15, 'triangle'); setTimeout(() => tone(700, 0.07, 0.15, 'triangle'), 50); setTimeout(() => tone(900, 0.07, 0.15, 'triangle'), 100); break;
      }
    }

    function playSound(type){
      if (!soundsEnabled) return;
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      const frequencies = {
        'hit': [200, 150],
        'appear': [300, 400, 500],
        'victory': [523.25, 659.25, 783.99],
        'defeat': [200, 180, 160],
        'select': [440],
        'confirm': [523.25, 659.25]
      };
      const freq = frequencies[type] || [440];
      if (freq.length === 1) {
        oscillator.frequency.setValueAtTime(freq[0], audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      } else {
        freq.forEach((f, i) => {
          setTimeout(() => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(f, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            osc.start();
            osc.stop(audioContext.currentTime + 0.15);
          }, i * 100);
        });
      }
    }

    function playMusic(type){
      if (!musicEnabled) return;
      stopMusic();
      
      if (selectedMusicType === 'real' && type === 'battle') {
     
        const realBattleMusic = new Audio('https://raw.githubusercontent.com/PokeAPI/cries/main/mp3/1.mp3'); 
        realBattleMusic.volume = 0.15;
        realBattleMusic.loop = true;
        realBattleMusic.play().catch(e => {
          console.log('Real music failed, falling back to classic');
          playClassicMusic(type);
        });
        currentMusic = realBattleMusic;
        return;
      }
      
      playClassicMusic(type);
    }

    function playClassicMusic(type){
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = type === 'battle' ? [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25] : [];
      let noteIndex = 0;
      function playNote(){
        if (!musicEnabled || !tournamentActive) return;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.setValueAtTime(notes[noteIndex % notes.length], audioContext.currentTime);
        gain.gain.setValueAtTime(0.05, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
        noteIndex++;
        setTimeout(playNote, 200);
      }
      playNote();
      currentMusic = { audioContext, interval: setInterval(() => {}, 100) };
    }

    function stopMusic(){
      if (currentMusic) {
        if (typeof currentMusic.stop === 'function') {
          currentMusic.stop();
        } else if (currentMusic.audioContext) {
          currentMusic.audioContext.close();
        } else if (currentMusic.pause) {
          currentMusic.pause();
        }
        currentMusic = null;
      }
    }

    const musicBtn = document.getElementById('musicToggle');
    const soundBtn = document.getElementById('soundToggle');
    function updateIcons() {
      musicBtn.innerHTML = musicEnabled ? '<i class="fas fa-music"></i>' : '<i class="fas fa-volume-mute"></i>';
      soundBtn.innerHTML = soundsEnabled ? '<i class="fas fa-volume-high"></i>' : '<i class="fas fa-volume-mute"></i>';
    }
    musicBtn.onclick = () => { musicEnabled = !musicEnabled; localStorage.setItem('musicEnabled', musicEnabled); updateIcons(); if (!musicEnabled) stopMusic(); else if (tournamentActive) playMusic('battle'); };
    soundBtn.onclick = () => { soundsEnabled = !soundsEnabled; localStorage.setItem('soundsEnabled', soundsEnabled); updateIcons(); };
    updateIcons();

    musicOptions.forEach(option => {
      option.onclick = () => {
        musicOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedMusicType = option.dataset.music;
      };
    });

    confirmMusicBtn.onclick = () => {
      showSlide('slide-pokemon');
      playSound('confirm');
    };

  function createAttackEffect(fromEl, toEl, type = 'fire') {
    const fromRect = fromEl.getBoundingClientRect();
    const toRect   = toEl.getBoundingClientRect();
    const bfRect   = battlefield.getBoundingClientRect();

    const startX = fromRect.left + fromRect.width / 2 - bfRect.left;
    const startY = fromRect.top  + fromRect.height / 2 - bfRect.top;
    const endX   = toRect.left   + toRect.width / 2   - bfRect.left;
    const endY   = toRect.top    + toRect.height / 2  - bfRect.top;

    if (type === 'punch') {
      const fist = document.createElement('div');
      fist.style.position = 'absolute';
      fist.style.left = (startX - 30) + 'px';
      fist.style.top  = (startY - 30) + 'px';
      fist.style.width = fist.style.height = '60px';
      fist.style.background = 'radial-gradient(circle at 30% 30%, #ffeb3b 20%, #ff9800 55%, #c62828 100%)';
      fist.style.borderRadius = '30% 50% 50% 30%';
      fist.style.transform = 'rotate(-30deg) scale(0)';
      fist.style.opacity = '0';
      fist.style.filter = 'drop-shadow(0 0 8px #ffeb3b)';
      fist.style.zIndex = '100';
      battlefield.appendChild(fist);

      for (let i = 1; i <= 3; i++) {
        const trail = fist.cloneNode();
        trail.style.opacity = 0.4 - i * 0.1;
        trail.style.transition = 'none';
        battlefield.appendChild(trail);
        setTimeout(() => {
          const dx = (endX - startX) * (i / 4);
          const dy = (endY - startY) * (i / 4);
          trail.style.transition = 'all 0.25s ease-out';
          trail.style.transform = `translate(${dx}px, ${dy}px) rotate(${30 + i * 20}deg) scale(0.6)`;
          trail.style.opacity = '0';
        }, i * 40);
      }

      setTimeout(() => {
        fist.style.transition = 'all 0.35s cubic-bezier(0.2,0.8,0.2,1)';
        fist.style.opacity = '1';
        fist.style.transform = `translate(${(endX - startX) * 0.9}px, ${(endY - startY) * 0.9}px) rotate(45deg) scale(1.3)`;
      }, 10);

  
      setTimeout(() => {
        const impact = document.createElement('div');
        impact.className = 'impact-flash';
        impact.style.left = (endX - 60) + 'px';
        impact.style.top  = (endY - 60) + 'px';
        battlefield.appendChild(impact);
        battlefield.classList.add('screen-shake');
        setTimeout(() => {
          fist.remove();
          impact.remove();
          battlefield.classList.remove('screen-shake');
        }, 500);
      }, 350);
      return;
    }


    if (type === 'thunder') {
      const flash = document.createElement('div');
      flash.style.position = 'absolute';
      flash.style.inset = '0';
      flash.style.background = 'rgba(255,255,255,0.15)';
      flash.style.opacity = '0';
      flash.style.pointerEvents = 'none';
      flash.style.zIndex = '102';
      battlefield.appendChild(flash);
      setTimeout(() => {
        flash.style.transition = 'opacity 0.08s';
        flash.style.opacity = '1';
        setTimeout(() => flash.style.opacity = '0', 80);
      }, 50);

      const boltCount = 3 + Math.floor(Math.random() * 3);
      for (let i = 0; i < boltCount; i++) {
        const bolt = document.createElement('div');
        bolt.className = 'lightning-bolt';
        const offsetX = (Math.random() - 0.5) * 80;
        const offsetY = (Math.random() - 0.5) * 40;
        bolt.style.left = (endX + offsetX - 6) + 'px';
        bolt.style.top  = (bfRect.top - bfRect.height * 0.35 - bfRect.top) + 'px';
        bolt.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
        battlefield.appendChild(bolt);

        const points = [];
        const segments = 6 + Math.floor(Math.random() * 4);
        for (let s = 0; s <= segments; s++) {
          const prog = s / segments;
          const x = offsetX * prog + (Math.random() - 0.5) * 30;
          const y = bfRect.height * 0.35 * prog + (Math.random() - 0.5) * 20;
          points.push(`${x}px ${y}px`);
        }
        bolt.style.clipPath = `polygon(0 0, ${points.join(', ')}, 0 100%)`;

        setTimeout(() => {
          bolt.style.opacity = '1';
          bolt.style.transform = `translateY(${(endY - startY) * 0.9}px) rotate(${Math.random() * 60 - 30}deg)`;
        }, i * 80);
      }

     
      setTimeout(() => {
        const impact = document.createElement('div');
        impact.className = 'impact-flash';
        impact.style.left = (endX - 80) + 'px';
        impact.style.top  = (endY - 80) + 'px';
        impact.style.width = impact.style.height = '160px';
        impact.style.filter = 'brightness(1.8)';
        battlefield.appendChild(impact);
        battlefield.classList.add('screen-shake');
        setTimeout(() => {
          document.querySelectorAll('.lightning-bolt').forEach(b => b.remove());
          impact.remove();
          battlefield.classList.remove('screen-shake');
        }, 600);
      }, boltCount * 80 + 200);
      return;
    }

    const dx = endX - startX;
    const dy = endY - startY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

    const fireball = document.createElement('div');
    fireball.className = 'attack-effect';
    fireball.style.left = startX + 'px';
    fireball.style.top  = startY + 'px';
    fireball.style.background = `radial-gradient(circle, #ff5722 10%, #ff9800 40%, #f44336 70%, transparent 100%)`;
    battlefield.appendChild(fireball);

    for (let i = 0; i < 6; i++) {
      const trail = document.createElement('div');
      trail.className = 'attack-trail';
      const delay = i * 50;
      setTimeout(() => {
        trail.style.left = (startX + dx * (i / 6)) + 'px';
        trail.style.top  = (startY + dy * (i / 6)) + 'px';
        trail.style.opacity = '1';
        trail.style.transform = 'scale(1)';
        battlefield.appendChild(trail);
        setTimeout(() => trail.remove(), 400);
      }, delay);
    }

    fireball.style.transition = `all 500ms cubic-bezier(0.2, 0.8, 0.2, 1)`;
    setTimeout(() => {
      fireball.style.opacity = '1';
      fireball.style.transform = `translate(${dx}px, ${dy}px) scale(1.5) rotate(${angle}deg)`;
    }, 10);

    setTimeout(() => {
      const impact = document.createElement('div');
      impact.className = 'impact-flash';
      impact.style.left = (endX - 60) + 'px';
      impact.style.top  = (endY - 60) + 'px';
      battlefield.appendChild(impact);
      setTimeout(() => impact.remove(), 400);
      fireball.remove();
    }, 500);

    if (dist > 200) {
      battlefield.classList.add('screen-shake');
      setTimeout(() => battlefield.classList.remove('screen-shake'), 500);
    }
  }

    // Load carousel
 async function loadPokemonCarousel() {
  carousel.innerHTML = '';
  pokemonDetails = [];

  // ---- build cards -------------------------------------------------
  for (const p of ownedPokemon) {
    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${p.id}`);
    const data = await res.json();
    const speciesRes = await fetch(data.species.url);
    const species = await speciesRes.json();
    const flavor = species.flavor_text_entries.find(e => e.language.name === 'en')?.flavor_text.replace(/\f/g, ' ') || 'A mysterious Pok√©mon.';
    const types = data.types.map(t => t.type.name);
    const stats = {
      hp: data.stats[0].base_stat,
      atk: data.stats[1].base_stat,
      def: data.stats[2].base_stat,
      spa: data.stats[3].base_stat,
      spd: data.stats[4].base_stat,
      spe: data.stats[5].base_stat
    };
    const paddedId = String(p.id).padStart(3, '0');
    pokemonDetails.push({ ...p, types, stats, flavor, paddedId, cries: data.cries });

    const card = document.createElement('div');
    card.className = 'carousel-card';
    const primaryType = types[0];
    const headerClass = primaryType === 'water' ? 'squirtle' :
                       primaryType === 'fire' ? 'charmander' :
                       primaryType === 'grass' ? 'bulbasaur' : '';
    card.innerHTML = `
      <div class="card-header ${headerClass}">
        <img class="card-pokemon-img" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png" alt="${p.name}">
      </div>
      <div class="card-body">
        <div class="card-name">${p.name.toUpperCase()}</div>
        <div class="card-id">#${paddedId}</div>
        <div class="card-type">${types.map(t => t.toUpperCase()).join(' / ')}</div>
        <div class="card-stats">
          <div class="stat"><div class="stat-label">HP</div><div class="stat-bar"><div class="stat-fill" style="width:${(stats.hp/255)*100}%"></div></div></div>
          <div class="stat"><div class="stat-label">ATK</div><div class="stat-bar"><div class="stat-fill" style="width:${(stats.atk/255)*100}%"></div></div></div>
          <div class="stat"><div class="stat-label">DEF</div><div class="stat-bar"><div class="stat-fill" style="width:${(stats.def/255)*100}%"></div></div></div>
        </div>
        <div class="card-flavor">${flavor}</div>
        <div class="card-pokeball"></div>
      </div>
    `;
    carousel.appendChild(card);
  }

    // ---- navigation --------------------------------------------------
  const cards = document.querySelectorAll('.carousel-card');

  function updateCarousel() {
    const total = ownedPokemon.length;
    const center = carouselIndex;

    // translate so that the centre card sits in the middle
    const offset = -(center * 33.333);   // 33.333% per card
    carousel.style.transform = `translateX(${offset}%)`;

    cards.forEach((c, i) => {
      c.classList.remove('active', 'adjacent');
      const diff = i - center;
      // centre
      if (diff === 0) {
        c.classList.add('active');
        confirmPokemonBtn.disabled = false;
        selectedPokemon = pokemonDetails[i];
      }
      // previous / next
      else if (Math.abs(diff) === 1 ||
               (center === 0 && i === total - 1) ||
               (center === total - 1 && i === 0)) {
        c.classList.add('adjacent');
      }
    });
  }

  prevBtn.onclick = () => {
    carouselIndex = (carouselIndex - 1 + ownedPokemon.length) % ownedPokemon.length;
    updateCarousel();
    playSound('select');
  };
  nextBtn.onclick = () => {
    carouselIndex = (carouselIndex + 1) % ownedPokemon.length;
    updateCarousel();
    playSound('select');
  };

  // initialise
  carouselIndex = ownedPokemon.findIndex(p => p.id === equippedId);
  if (carouselIndex === -1) carouselIndex = 0;
  updateCarousel();
  playSound('appear');
}

    function updateCarousel() {
      carousel.style.transform = `translateX(${-carouselIndex * 100}%)`;
      const p = pokemonDetails[carouselIndex];
      if (!p) return;

      document.querySelectorAll('.carousel-card').forEach((c, i) => {
        c.style.transform = i === carouselIndex ? 'scale(1.02)' : 'scale(0.98)';
        c.style.zIndex = i === carouselIndex ? '5' : '1';
        c.style.boxShadow = i === carouselIndex ? '0 0 30px rgba(255,203,5,0.6)' : '0 8px 20px rgba(0,0,0,0.6)';
      });

      confirmPokemonBtn.disabled = false;
      selectedPokemon = p;
    }

    prevBtn.onclick = () => { carouselIndex = (carouselIndex - 1 + ownedPokemon.length) % ownedPokemon.length; updateCarousel(); playSound('select'); };
    nextBtn.onclick = () => { carouselIndex = (carouselIndex + 1) % ownedPokemon.length; updateCarousel(); playSound('select'); };
    confirmPokemonBtn.onclick = async () => {
      await playPokemonCry(selectedPokemon.id);
      
      equippedId = selectedPokemon.id;
      localStorage.setItem(EQUIPPED_KEY, equippedId);
      finalPokemonName.textContent = selectedPokemon.name;
      showSlide('slide-opponents');
      playSound('confirm');
    };

    function showSlide(id) {
      document.querySelectorAll('.wizard-slide').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    opponentSlider.oninput = () => {
      const n = parseInt(opponentSlider.value);
      sliderValue.textContent = n;
      opponentCount = n;
      finalOpponentCount.textContent = n;
      generateOpponentPreview(n);
    };

    async function generateOpponentPreview(count) {
      opponentPreview.innerHTML = '';
      opponents = [];                 
      const used = new Set([equippedId]);

      for (let i = 0; i < count; i++) {
        let id;
        do { id = Math.floor(Math.random()*150)+1; } while (used.has(id));
        used.add(id);

        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        const data = await res.json();

        const opp = {
          id,
          name: data.name.charAt(0).toUpperCase() + data.name.slice(1),
          hp: 100,
          maxHp: 100,
          wins: 0,
          losses: 0
        };
        opponents.push(opp);

        const card = document.createElement('div');
        card.className = 'preview-card';
        card.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif" alt="${opp.name}">`;
        card.style.animationDelay = `${i * 0.08}s`;
        opponentPreview.appendChild(card);
      }
    }

    confirmOpponentsBtn.onclick = () => {
      showSlide('slide-start');
      playSound('confirm');
    };

    startTournamentBtn.onclick = async () => {
      startTournamentBtn.disabled = true;
      let count = 3;
      const interval = setInterval(() => {
        startCountdown.textContent = count;
        playSound('select');
        count--;
        if (count < 0) {
          clearInterval(interval);
          startCountdown.textContent = 'GO!';
          setTimeout(() => {
            wizard.style.display = 'none';
            battleArena.style.display = 'grid';
            startTournament();
          }, 800);
        }
      }, 800);
    };

    let player = {id:0, name:'', hp:100, maxHp:100};
    let opponent = null;
    let battleActive = false;
    let playerTurn = true;
    let tournamentActive = false;
    let currentMatch = 0;
    let playerStats = {wins:0, losses:0};

    const moves = {
      fire: { name: 'Fire', power: 30, color: '#ff5722', type: 'fire', size: 60 },
      punch: { name: 'Punch', power: 25, color: '#ffeb3b', type: 'punch', size: 50 },
      thunder: { name: 'Thunder', power: 35, color: '#ffeb3b', type: 'thunder', size: 70 },
      run: { name: 'Run Away', power: 0, color: '#ff9800', run: true }
    };

    const moveList = Object.keys(moves);

    const playerSprite = document.getElementById('playerSprite');
    const playerName = document.getElementById('playerName');
    const playerHP = document.getElementById('playerHP');
    const playerHPText = document.getElementById('playerHPText');
    const opponentSprite = document.getElementById('opponentSprite');
    const opponentName = document.getElementById('opponentName');
    const opponentHP = document.getElementById('opponentHP');
    const opponentHPText = document.getElementById('opponentHPText');
    const battleLog = document.getElementById('battleLog');
    const moveButtons = document.querySelectorAll('.move-btn[data-move]');
    const scoreboard = document.getElementById('scoreboard');
    const scoreboardBody = document.getElementById('scoreboardBody');

    function updateHP(bar, txt, hp, max){
      const pct = (hp/max)*100;
      bar.style.width = pct+'%';
      txt.textContent = `${hp}/${max}`;
      bar.style.background = pct>50?'#4caf50':pct>25?'#ff9800':'#f44336';
    }
    function log(msg,cls=''){ const p=document.createElement('p'); p.innerHTML=msg; if(cls)p.className=cls; battleLog.appendChild(p); battleLog.scrollTop=battleLog.scrollHeight; }

    async function startTournament(){
      tournamentActive = true;
      battleActive = false;
      currentMatch = 0;
      playerStats = {wins:0, losses:0};
      scoreboard.style.display = 'none';
      moveButtons.forEach(b=>b.disabled=true);
      battleLog.innerHTML = '';
      log(`<span class="system">=== ROUND-ROBIN TOURNAMENT BEGIN ===</span>`);
      playMusic('battle'); 
      await startNextMatch();
    }

    async function startNextMatch(){
      if(currentMatch >= opponents.length){ endTournament(); return; }
      opponent = opponents[currentMatch];

      player.hp = player.maxHp = 100;
      opponent.hp = opponent.maxHp = 100;

      battleActive = true;
      playerTurn = true;
      moveButtons.forEach(b=>b.disabled=false);
      loadPlayer();
      loadOpponent(opponent);
      log(`<span class="system">Match ${currentMatch+1}/${opponents.length}: <strong>${player.name}</strong> vs <strong>${opponent.name}</strong></span>`);
      playSound('appear');
    }

    async function simulateAIMatch(roundIndex){
      if (opponents.length < 2) return;
      const len = opponents.length;
      const aIdx = (roundIndex+1) % len;
      const bIdx = (roundIndex+2) % len;
      const a = opponents[aIdx];
      const b = opponents[bIdx];
      if (!a || !b || a === b) return;

      moveButtons.forEach(bn => bn.disabled = true);
      log(`<span class="system">AI Match:</span> <strong>${a.name}</strong> vs <strong>${b.name}</strong>`);

      playerName.textContent = a.name; opponentName.textContent = b.name;
      playerSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${a.id}.gif`;
      opponentSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${b.id}.gif`;

      let aHp = 100, bHp = 100;
      updateHP(playerHP, playerHPText, aHp, 100);
      updateHP(opponentHP, opponentHPText, bHp, 100);

      await new Promise(r=>setTimeout(r, 400));
      let turnA = true;
      while(aHp > 0 && bHp > 0){
        const moveKey = moveList[Math.floor(Math.random() * moveList.length)];
        const move = moves[moveKey];
        if (move.run) continue;

        if (turnA){
          document.getElementById('playerPokemon').classList.add('attack');
          playAttackSound(moveKey);
          createAttackEffect(document.getElementById('playerPokemon'), document.getElementById('opponentPokemon'), move.type);
          await new Promise(r=>setTimeout(r, 500));
          document.getElementById('playerPokemon').classList.remove('attack');
          const dmg = Math.floor(Math.random()*10) + move.power - 5;
          bHp = Math.max(0, bHp - dmg);
          const oppEl = document.getElementById('opponentPokemon');
          oppEl.classList.add('hit','shake'); playSound('hit');
          setTimeout(()=>oppEl.classList.remove('hit','shake'), 400);
          updateHP(opponentHP, opponentHPText, bHp, 100);
          log(`<strong>${a.name}</strong> used <span style="color:${move.color}">${move.name}</span>! Dealt <strong>${dmg}</strong>.`);
        } else {
          document.getElementById('opponentPokemon').classList.add('attack');
          playAttackSound(moveKey);
          createAttackEffect(document.getElementById('opponentPokemon'), document.getElementById('playerPokemon'), move.type);
          await new Promise(r=>setTimeout(r, 500));
          document.getElementById('opponentPokemon').classList.remove('attack');
          const dmg2 = Math.floor(Math.random()*10) + move.power - 5;
          aHp = Math.max(0, aHp - dmg2);
          const pEl = document.getElementById('playerPokemon');
          pEl.classList.add('hit','shake'); playSound('hit');
          setTimeout(()=>pEl.classList.remove('hit','shake'), 400);
          updateHP(playerHP, playerHPText, aHp, 100);
          log(`${b.name} used <span style="color:${move.color}">${move.name}</span>! Dealt <strong>${dmg2}</strong>.`);
        }
        turnA = !turnA;
        await new Promise(r=>setTimeout(r, 600));
      }

      if (bHp === 0 && aHp > 0) {
        a.wins++; b.losses++;
        playSound('victory');
        log(`<span class="system"><strong style="color:#4caf50;">${a.name} wins!</strong></span>`);
      } else {
        b.wins++; a.losses++;
        playSound('victory');
        log(`<span class="system"><strong style="color:#4caf50;">${b.name} wins!</strong></span>`);
      }

      await new Promise(r=>setTimeout(r, 600));
    }

    function loadPlayer(){
      const p = ownedPokemon.find(x=>x.id===equippedId) || ownedPokemon[0];
      player.id = p.id; player.name = p.name;
      playerSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.id}.gif`;
      playerSprite.style.transform = 'scaleX(-1)';
      playerName.textContent = p.name;
      updateHP(playerHP, playerHPText, player.hp, player.maxHp);
    }

    function loadOpponent(o){
      opponentSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${o.id}.gif`;
      opponentName.textContent = o.name;
      updateHP(opponentHP, opponentHPText, o.hp, o.maxHp);
      opponentSprite.style.opacity = '0'; opponentSprite.style.transform = 'scale(0)';
      setTimeout(() => { opponentSprite.style.transition = 'all 0.5s ease'; opponentSprite.style.opacity = '1'; opponentSprite.style.transform = 'scale(1)'; }, 100);
    }

    moveButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!battleActive || !playerTurn) return;
        const key = btn.dataset.move;
        const move = moves[key];
        if (move.run) {
          log(`<strong>${player.name}</strong> ran away.`, 'system');
          playAttackSound('run');
          await endMatch(false, true);
          return;
        }

        document.getElementById('playerPokemon').classList.add('attack');
        playAttackSound(key);
        createAttackEffect(document.getElementById('playerPokemon'), document.getElementById('opponentPokemon'), move.type);
        setTimeout(() => document.getElementById('playerPokemon').classList.remove('attack'), 500);

        const dmg = Math.floor(Math.random()*10) + move.power - 5;
        opponent.hp = Math.max(0, opponent.hp - dmg);
        log(`<strong>${player.name}</strong> used <span style="color:${move.color}">${move.name}</span>!`);
        await new Promise(r => setTimeout(r, 300));
        const oppEl = document.getElementById('opponentPokemon');
        oppEl.classList.add('hit', 'shake'); playSound('hit');
        setTimeout(() => oppEl.classList.remove('hit', 'shake'), 500);
        log(`${opponent.name} took <strong>${dmg}</strong> damage.`);
        updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
        if (opponent.hp === 0) { playSound('victory'); await new Promise(r => setTimeout(r, 400)); await endMatch(true); return; }

        playerTurn = false;
        moveButtons.forEach(b => b.disabled = true);
        await new Promise(r => setTimeout(r, 900));

      
        const oppMoveKey = moveList[Math.floor(Math.random() * moveList.length)];
        const oppMove = moves[oppMoveKey];
        if (!oppMove.run) {
          document.getElementById('opponentPokemon').classList.add('attack');
          playAttackSound(oppMoveKey);
          createAttackEffect(document.getElementById('opponentPokemon'), document.getElementById('playerPokemon'), oppMove.type);
          setTimeout(() => document.getElementById('opponentPokemon').classList.remove('attack'), 500);

          const oppDmg = Math.floor(Math.random()*10) + oppMove.power - 5;
          player.hp = Math.max(0, player.hp - oppDmg);
          log(`${opponent.name} used <span style="color:${oppMove.color}">${oppMove.name}</span>!`);
          await new Promise(r => setTimeout(r, 300));
          const playerEl = document.getElementById('playerPokemon');
          playerEl.classList.add('hit', 'shake'); playSound('hit');
          setTimeout(() => playerEl.classList.remove('hit', 'shake'), 500);
          log(`You took <strong>${oppDmg}</strong> damage.`);
          updateHP(playerHP, playerHPText, player.hp, player.maxHp);
          if (player.hp === 0) { playSound('defeat'); await new Promise(r => setTimeout(r, 400)); await endMatch(false); return; }
        } else {
          log(`${opponent.name} tried to run but failed!`);
        }

        playerTurn = true;
        moveButtons.forEach(b => b.disabled = false);
      });

      btn.addEventListener('mousemove', (e) => {
        const rect = btn.getBoundingClientRect();
        btn.style.setProperty('--mx', `${e.clientX - rect.left}px`);
        btn.style.setProperty('--rx', `${e.clientX - rect.left}px`);
        btn.style.setProperty('--ry', `${e.clientY - rect.top}px`);
      });
    });

    async function endMatch(playerWon, ran = false){
      battleActive = false;
      moveButtons.forEach(b => b.disabled = true);
      if (playerWon && !ran){
        playerStats.wins++;
        opponents[currentMatch].losses++;
        const reward = 100;
        setCoins(getCoins() + reward);
        log(`<strong style="color:#4caf50;">Victory!</strong> +${reward} coins`);
      } else if (ran){
        playerStats.losses++;
        opponents[currentMatch].wins++;
        log(`<strong style="color:#ff9800;">You escaped.</strong>`);
      } else {
        playerStats.losses++;
        opponents[currentMatch].wins++;
        log(`<strong style="color:#f44336;">Defeat‚Ä¶</strong>`);
      }
      await new Promise(r => setTimeout(r, 800));
      if (currentMatch < opponents.length - 1){
        await simulateAIMatch(currentMatch);
      }
      currentMatch++;
      if (currentMatch < opponents.length) await startNextMatch();
      else endTournament();
    }

    function endTournament(){
      tournamentActive = false;
      stopMusic();
      log(`<span class="system">=== TOURNAMENT COMPLETE ===</span>`);
      const standings = [
        {name: player.name, wins: playerStats.wins, losses: playerStats.losses, pts: playerStats.wins * 3},
        ...opponents.map(o => ({name: o.name, wins: o.wins, losses: o.losses, pts: o.wins * 3}))
      ];
      standings.sort((a,b) => b.pts - a.pts || b.wins - a.wins);
      scoreboardBody.innerHTML = '';
      standings.forEach((s,i) => {
        const tr = document.createElement('tr');
        tr.style.background = i===0 ? 'rgba(255,203,5,.3)' : i%2 ? 'rgba(255,255,255,.05)' : 'transparent';
        tr.innerHTML = `<td>${i+1}</td><td>${s.name}${i===0?' (You)':''}</td><td>${s.wins}</td><td>${s.losses}</td><td>${s.pts}</td>`;
        scoreboardBody.appendChild(tr);
      });
      scoreboard.style.display = 'block';
      if (standings[0].name === player.name){
        const champReward = 500;
        setCoins(getCoins() + champReward);
        log(`<strong style="color:#ffeb3b;">Champion! +${champReward} coins</strong>`);
      }
      setTimeout(() => {
        wizard.style.display = 'block';
        battleArena.style.display = 'none';
        document.querySelectorAll('.wizard-slide').forEach(s => s.classList.remove('active'));
        document.getElementById('slide-music').classList.add('active');
        loadPokemonCarousel();
      }, 5000);
    }

    loadPokemonCarousel();

    // Background selector logic (place after other DOM queries)
const bgSelect = document.getElementById('bgSelect');

function setBattlefieldBg(url) {
  battlefield.style.background = `url('${url}') center/cover no-repeat, radial-gradient(circle at 50% 120%, rgba(30,30,30,.92) 0%, rgba(0,0,0,.75) 48%, rgba(0,0,0,.5) 70%, rgba(0,0,0,0) 73%), repeating-linear-gradient(90deg, rgba(255,255,255,.05) 0 2px, transparent 2px 6px)`;
}

// Load saved background or default
const savedBg = localStorage.getItem('selectedBg') || 'images/rock-platform-podium-product-presentation-background_148840-40388.avif';
bgSelect.value = savedBg;
setBattlefieldBg(savedBg);

// Change background on select
bgSelect.addEventListener('change', () => {
  const chosen = bgSelect.value;
  setBattlefieldBg(chosen);
  localStorage.setItem('selectedBg', chosen);
});
  </script>
</body>
</html>
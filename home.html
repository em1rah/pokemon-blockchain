<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Trainer – Arena</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{min-height:100vh;background:linear-gradient(to bottom,#1a2a6c,#b21f1f,#1a2a6c),url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="%23ffcb05" stroke-width="8" opacity="0.1"/></svg>') repeat;background-blend-mode:overlay;color:white;display:flex;flex-direction:column;}
    header{background:rgba(0,0,0,.4);backdrop-filter:blur(8px);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;}
    header h1{font-size:1.8rem;color:#ffcb05;}
    nav a{margin-left:1.5rem;color:#ffcb05;text-decoration:none;font-weight:600;transition:.2s;}
    nav a:hover{color:#fff;}
    .welcome{background:rgba(100,65,165,.9);padding:3rem 2rem;text-align:center;margin:2rem 1rem;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.4);}
    .welcome h2{font-size:2.5rem;margin-bottom:.5rem;}
    .welcome p{font-size:1.2rem;color:#ddd;margin:1rem 0;}
    .btn-enter{padding:16px 40px;background:#ffcb05;color:#1a2a6c;border:none;border-radius:16px;font-size:1.3rem;font-weight:700;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,.4);transition:.3s;}
    .btn-enter:hover{background:#ffb300;transform:scale(1.05);}

    /* Tabs */
    .tab-content{display:none;padding:2rem;border-radius:20px;margin:1rem;background:rgba(0,0,0,.6);box-shadow:0 15px 35px rgba(0,0,0,.6);}
    .tab-content.active{display:block;}

    /* Arena */
    .arena{background:linear-gradient(to bottom,rgba(0,0,0,.7),rgba(0,0,0,.9));}
    .battlefield{display:flex;justify-content:space-around;align-items:flex-end;width:100%;max-width:900px;margin:30px 0;position:relative;}
    .pokemon{position:relative;text-align:center;min-width:180px;}
    .pokemon img{width:160px;height:160px;image-rendering:pixelated;transition:transform .2s;}
    .pokemon.hit img{animation:shake .4s;}
    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-8px);}50%{transform:translateX(8px);}75%{transform:translateX(-8px);}}
    .hp-bar{background:#333;border:2px solid #ffcb05;border-radius:10px;height:20px;width:160px;margin:10px auto;position:relative;overflow:hidden;}
    .hp-fill{height:100%;background:#4caf50;border-radius:8px;transition:width .5s ease,background .3s;}
    .hp-text{position:absolute;top:0;left:0;right:0;text-align:center;font-weight:600;font-size:13px;color:white;text-shadow:1px 1px 2px #000;}
    .name{font-weight:700;color:#ffcb05;font-size:1.3rem;text-shadow:1px 1px 3px #000;margin-bottom:4px;}

    .moves{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px;width:100%;max-width:500px;}
    .move-btn{padding:14px;background:rgba(255,255,255,.1);border:2px solid #ffcb05;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:.3s;}
    .move-btn:hover{background:rgba(255,203,5,.2);}
    .move-btn:disabled{background:#444;cursor:not-allowed;opacity:.6;}

    .log{background:rgba(0,0,0,.6);padding:16px;border-radius:12px;max-height:140px;overflow-y:auto;font-size:15px;margin-top:20px;width:100%;max-width:900px;border:1px solid rgba(255,203,5,.3);}
    .log p{margin:6px 0;opacity:.9;}
    .log .player{color:#4caf50;}
    .log .opponent{color:#ff5252;}
    .log .system{color:#ffcb05;font-weight:600;}

    /* Shop */
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-top:20px;}
    .shop-card{background:rgba(255,255,255,.1);border:2px solid #ffcb05;border-radius:12px;padding:14px;text-align:center;transition:.3s;}
    .shop-card:hover{transform:scale(1.05);background:rgba(255,203,5,.2);}
    .shop-card img{width:100px;height:100px;image-rendering:pixelated;margin:8px 0;}
    .shop-card .price{color:#ffeb3b;font-weight:700;font-size:1.1rem;}
    .shop-card button{margin-top:8px;padding:8px 16px;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
    .shop-card button:disabled{background:#666;cursor:not-allowed;}
    .shop-card button:hover:not(:disabled){background:#388e3c;}

    /* My Pokémon */
    .my-pokemon-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;margin-top:16px;}
    .my-card{background:rgba(0,0,0,.4);border:2px solid #ffcb05;border-radius:12px;padding:12px;text-align:center;position:relative;}
    .my-card.equipped::after{content:"★";position:absolute;top:8px;right:8px;color:#ffeb3b;font-size:1.4rem;}
    .my-card img{width:90px;height:90px;image-rendering:pixelated;}
    .equip-btn{margin-top:6px;padding:6px 12px;background:#ff9800;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;}
    .equip-btn:hover{background:#f57c00;}

    .tournament-list{margin:1.5rem;padding:1.5rem;background:rgba(100,65,165,.8);border-radius:16px;}
    .tournament-item{background:rgba(0,0,0,.4);margin:10px 0;padding:14px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:15px;}
    .trophy{font-size:1.5rem;}

    .logout{margin:2rem auto;display:block;padding:.9rem 2.5rem;background:#f44336;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;}
    .logout:hover{background:#d32f2f;}

    .coins{display:inline-block;background:#ffeb3b;color:#1a2a6c;padding:6px 12px;border-radius:12px;font-weight:700;margin-left:10px;font-size:0.9rem;}

    @media(max-width:700px){
      .battlefield{flex-direction:column;align-items:center;gap:30px;}
      .pokemon img{width:120px;height:120px;}
      .hp-bar{width:120px;}
      .moves{grid-template-columns:1fr;}
      .shop-grid{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Pokémon Trainer</h1>
    </div>
    <nav>
      <a href="#" id="navArena">Arena</a>
      <a href="#" id="navShop">Shop</a>
      <a href="#" id="navMyPokemon">My Pokémon</a>
      <a href="#" id="navTournaments">History</a>
      <span class="coins" id="coinDisplay">∞ Coins</span>
    </nav>
  </header>

  <!-- WELCOME -->
  <section class="welcome" id="welcomeSection">
    <h2 id="welcomeMsg">Welcome, Trainer!</h2>
    <p>Ready to prove your strength? Enter the arena and battle wild Pokémon!</p>
    <button class="btn-enter" id="enterArenaBtn">Enter Arena</button>
  </section>

  <!-- TABS -->
  <div class="tab-content active" id="arenaTab">
    <div class="arena">
      <h2 style="color:#ffcb05;font-size:2rem;margin-bottom:8px;">Battle Arena</h2>
      <p style="color:#ccc;margin-bottom:20px;">Defeat your opponent to win a tournament!</p>

      <div class="battlefield">
        <div class="pokemon" id="playerPokemon">
          <div class="name" id="playerName">Pikachu</div>
          <img id="playerSprite" src="" alt="You">
          <div class="hp-bar"><div class="hp-fill" id="playerHP"></div><div class="hp-text" id="playerHPText">100/100</div></div>
        </div>
        <div class="pokemon" id="opponentPokemon">
          <div class="name" id="opponentName">???</div>
          <img id="opponentSprite" src="" alt="Opponent">
          <div class="hp-bar"><div class="hp-fill" id="opponentHP"></div><div class="hp-text" id="opponentHPText">100/100</div></div>
        </div>
      </div>

      <div class="moves">
        <button class="move-btn" data-move="thunderbolt">Thunderbolt</button>
        <button class="move-btn" data-move="quickattack">Quick Attack</button>
        <button class="move-btn" data-move="irontail">Iron Tail</button>
        <button class="move-btn" data-move="run">Run Away</button>
      </div>

      <div class="log" id="battleLog">
        <p class="system">Click "Enter Arena" to begin...</p>
      </div>

      <button class="btn-attack" id="newBattleBtn" style="margin-top:20px;display:none;padding:12px 30px;background:#4caf50;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;">
        Start New Battle
      </button>
    </div>
  </div>

  <!-- SHOP TAB -->
  <div class="tab-content" id="shopTab">
    <h2 style="color:#ffcb05;text-align:center;margin-bottom:16px;">Pokémon Shop</h2>
    <p style="text-align:center;color:#ddd;margin-bottom:20px;">Buy new Pokémon with your infinite coins!</p>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

  <!-- MY POKEMON TAB -->
  <div class="tab-content" id="myPokemonTab">
    <h2 style="color:#ffcb05;text-align:center;margin-bottom:16px;">My Pokémon</h2>
    <p style="text-align:center;color:#ddd;margin-bottom:20px;">Equip a Pokémon to battle with it!</p>
    <div class="my-pokemon-list" id="myPokemonList">
      <p style="grid-column:1/-1;text-align:center;color:#aaa;">No Pokémon yet. Visit the shop!</p>
    </div>
  </div>

  <!-- TOURNAMENT HISTORY -->
  <div class="tournament-list" id="tournamentList">
    <h3 style="color:#ffcb05;text-align:center;margin-bottom:16px;">Tournament History</h3>
    <div id="tournamentEntries">
      <p style="text-align:center;color:#aaa;">No battles yet. Enter the arena!</p>
    </div>
  </div>

  <button class="logout" id="logoutBtn">Logout</button>

  <script>
    // === Session ===
    const session = JSON.parse(localStorage.getItem('trainerSession'));
    if (!session) location.href = 'index.html';
    document.getElementById('welcomeMsg').textContent = session.type === 'metamask' 
      ? `Welcome, Trainer ${session.address.slice(0,6)}...${session.address.slice(-4)}!`
      : `Welcome back, ${session.address.split('@')[0]}!`;

    // === DOM ===
    const welcomeSection = document.getElementById('welcomeSection');
    const enterArenaBtn = document.getElementById('enterArenaBtn');
    const tabs = {
      arena: document.getElementById('arenaTab'),
      shop: document.getElementById('shopTab'),
      myPokemon: document.getElementById('myPokemonTab')
    };
    const playerSprite = document.getElementById('playerSprite');
    const playerName = document.getElementById('playerName');
    const playerHP = document.getElementById('playerHP');
    const playerHPText = document.getElementById('playerHPText');
    const opponentSprite = document.getElementById('opponentSprite');
    const opponentName = document.getElementById('opponentName');
    const opponentHP = document.getElementById('opponentHP');
    const opponentHPText = document.getElementById('opponentHPText');
    const battleLog = document.getElementById('battleLog');
    const newBattleBtn = document.getElementById('newBattleBtn');
    const moveButtons = document.querySelectorAll('.move-btn');
    const shopGrid = document.getElementById('shopGrid');
    const myPokemonList = document.getElementById('myPokemonList');
    const tournamentEntries = document.getElementById('tournamentEntries');

    // === Player & Coins ===
    let player = { id: 25, name: "Pikachu", hp: 100, maxHp: 100 };
    const COINS_INFINITE = true;
    document.getElementById('coinDisplay').textContent = COINS_INFINITE ? '∞ Coins' : '0 Coins';

    // === Pokémon Shop Data ===
    const shopPokemon = [
      { id: 1, name: "Bulbasaur", price: 500 },
      { id: 4, name: "Charmarmander", price: 600 },
      { id: 7, name: "Squirtle", price: 600 },
      { id: 10, name: "Caterpie", price: 200 },
      { id: 13, name: "Weedle", price: 200 },
      { id: 16, name: "Pidgey", price: 300 },
      { id: 19, name: "Rattata", price: 250 },
      { id: 23, name: "Ekans", price: 400 },
      { id: 27, name: "Sandshrew", price: 450 },
      { id: 37, name: "Vulpix", price: 700 },
      { id: 39, name: "Jigglypuff", price: 550 },
      { id: 52, name: "Meowth", price: 800 },
      { id: 63, name: "Abra", price: 900 },
      { id: 74, name: "Geodude", price: 400 },
      { id: 92, name: "Gastly", price: 750 },
      { id: 104, name: "Cubone", price: 650 },
      { id: 133, name: "Eevee", price: 1200 },
      { id: 143, name: "Snorlax", price: 2000 },
      { id: 147, name: "Dratini", price: 1500 },
      { id: 150, name: "Mewtwo", price: 5000 }
    ];

    // === Owned Pokémon & Equipped ===
    let ownedPokemon = JSON.parse(localStorage.getItem('ownedPokemon') || '[]');
    if (!ownedPokemon.find(p => p.id === 25)) {
      ownedPokemon.push({ id: 25, name: "Pikachu" });
      localStorage.setItem('ownedPokemon', JSON.stringify(ownedPokemon));
    }
    let equippedId = parseInt(localStorage.getItem('equippedPokemon') || '25');

    // === Load Equipped Pokémon ===
    function loadEquipped() {
      const p = ownedPokemon.find(p => p.id === equippedId) || ownedPokemon[0];
      player.id = p.id;
      player.name = p.name;
      playerSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png`;
      playerName.textContent = p.name;
      updateHP(playerHP, playerHPText, player.hp, player.maxHp);
    }

    // === Shop ===
    function loadShop() {
      shopGrid.innerHTML = '';
      shopPokemon.forEach(poke => {
        const owned = ownedPokemon.some(o => o.id === poke.id);
        const card = document.createElement('div');
        card.className = 'shop-card';
        card.innerHTML = `
          <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${poke.id}.png" alt="${poke.name}">
          <div class="name">${poke.name}</div>
          <div class="price">${poke.price} Coins</div>
          <button ${owned ? 'disabled' : ''}>${owned ? 'Owned' : 'Buy'}</button>
        `;
        if (!owned) {
          card.querySelector('button').onclick = () => buyPokemon(poke);
        }
        shopGrid.appendChild(card);
      });
    }

    function buyPokemon(poke) {
      if (COINS_INFINITE || true) {
        if (!ownedPokemon.some(o => o.id === poke.id)) {
          ownedPokemon.push({ id: poke.id, name: poke.name });
          localStorage.setItem('ownedPokemon', JSON.stringify(ownedPokemon));
          loadShop();
          loadMyPokemon();
          alert(`You bought ${poke.name}!`);
        }
      }
    }

    // === My Pokémon ===
    function loadMyPokemon() {
      myPokemonList.innerHTML = '';
      if (ownedPokemon.length === 0) {
        myPokemonList.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa;">No Pokémon yet. Visit the shop!</p>';
        return;
      }
      ownedPokemon.forEach(poke => {
        const card = document.createElement('div');
        card.className = `my-card ${poke.id === equippedId ? 'equipped' : ''}`;
        card.innerHTML = `
          <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${poke.id}.png" alt="${poke.name}">
          <div>${poke.name}</div>
          <button class="equip-btn" ${poke.id === equippedId ? 'disabled' : ''}>
            ${poke.id === equippedId ? 'Equipped' : 'Equip'}
          </button>
        `;
        if (poke.id !== equippedId) {
          card.querySelector('.equip-btn').onclick = () => equipPokemon(poke.id);
        }
        myPokemonList.appendChild(card);
      });
    }

    function equipPokemon(id) {
      equippedId = id;
      localStorage.setItem('equippedPokemon', id);
      loadEquipped();
      loadMyPokemon();
      if (battleActive) startNewBattle(); // Refresh if in battle
    }

    // === Battle Logic ===
    let opponent = null;
    let battleActive = false;
    let playerTurn = true;

    const moves = {
      thunderbolt: { name: "Thunderbolt", power: 30, color: "#ffeb3b" },
      quickattack: { name: "Quick Attack", power: 20, color: "#81c784" },
      irontail: { name: "Iron Tail", power: 40, color: "#9e9e9e" },
      run: { name: "Run Away", power: 0, color: "#ff9800", run: true }
    };

    enterArenaBtn.addEventListener('click', () => {
      welcomeSection.style.display = 'none';
      showTab('arena');
      startNewBattle();
    });

    async function startNewBattle() {
      battleActive = true;
      playerTurn = true;
      player.hp = player.maxHp;
      battleLog.innerHTML = '';
      newBattleBtn.style.display = 'none';
      moveButtons.forEach(b => b.disabled = false);
      loadEquipped();

      const oppId = Math.floor(Math.random() * 150) + 1;
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${oppId}`);
      const data = await res.json();
      opponent = {
        id: oppId,
        name: data.name.charAt(0).toUpperCase() + data.name.slice(1),
        hp: 100,
        maxHp: 100
      };
      opponentSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${oppId}.png`;
      opponentName.textContent = opponent.name;
      updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);

      log(`A wild <strong>${opponent.name}</strong> appeared!`, 'system');
      log(`What will <strong>${player.name}</strong> do?`, 'system');
    }

    moveButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (!battleActive || !playerTurn) return;
        const moveKey = btn.dataset.move;
        const move = moves[moveKey];

        if (move.run) {
          log(`<strong>${player.name}</strong> ran away!`, 'system');
          endBattle(false, true);
          return;
        }

        const damage = Math.floor(Math.random() * 8) + move.power;
        opponent.hp = Math.max(0, opponent.hp - damage);

        log(`<strong>${player.name}</strong> used <span style="color:${move.color}">${move.name}</span>!`, 'player');
        log(`${opponent.name} took <strong>${damage}</strong> damage.`, 'player');
        updateHP(opponentHP, opponentHPText, opponent.hp, opponent.maxHp);
        document.getElementById('opponentPokemon').classList.add('hit');
        setTimeout(() => document.getElementById('opponentPokemon').classList.remove('hit'), 400);

        if (opponent.hp === 0) {
          setTimeout(() => endBattle(true), 600);
          return;
        }

        playerTurn = false;
        moveButtons.forEach(b => b.disabled = true);

        setTimeout(() => {
          const oppMove = ['Tackle', 'Scratch', 'Ember', 'Vine Whip'][Math.floor(Math.random() * 4)];
          const oppDmg = Math.floor(Math.random() * 25) + 15;
          player.hp = Math.max(0, player.hp - oppDmg);

          log(`${opponent.name} used <strong>${oppMove}</strong>!`, 'opponent');
          log(`You took <strong>${oppDmg}</strong> damage.`, 'opponent');
          updateHP(playerHP, playerHPText, player.hp, player.maxHp);
          document.getElementById('playerPokemon').classList.add('hit');
          setTimeout(() => document.getElementById('playerPokemon').classList.remove('hit'), 400);

          if (player.hp === 0) {
            setTimeout(() => endBattle(false), 600);
          } else {
            playerTurn = true;
            moveButtons.forEach(b => b.disabled = false);
          }
        }, 1200);
      });
    });

    function endBattle(won, ran = false) {
      battleActive = false;
      moveButtons.forEach(b => b.disabled = true);

      const tournaments = JSON.parse(localStorage.getItem('tournaments') || '[]');
      tournaments.push({
        player: player.name,
        opponent: opponent.name,
        won: won && !ran,
        date: new Date().toLocaleString()
      });
      localStorage.setItem('tournaments', JSON.stringify(tournaments));
      loadTournaments();

      if (won && !ran) {
        log(`<strong style="color:#4caf50;">Victory! You won the tournament! Trophy</strong>`, 'system');
      } else if (ran) {
        log(`<strong style="color:#ff9800;">You escaped safely.</strong>`, 'system');
      } else {
        log(`<strong style="color:#f44336;">Defeat... Better luck next time.</strong>`, 'system');
      }

      newBattleBtn.style.display = 'block';
    }

    newBattleBtn.addEventListener('click', startNewBattle);

    // === Helpers ===
    function updateHP(bar, textEl, hp, max) {
      const percent = (hp / max) * 100;
      bar.style.width = percent + '%';
      textEl.textContent = `${hp}/${max}`;
      bar.style.background = percent > 50 ? '#4caf50' : percent > 25 ? '#ff9800' : '#f44336';
    }

    function log(msg, type = '') {
      const p = document.createElement('p');
      p.innerHTML = msg;
      if (type) p.className = type;
      battleLog.appendChild(p);
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    function showTab(tabName) {
      Object.values(tabs).forEach(t => t.classList.remove('active'));
      tabs[tabName].classList.add('active');
      if (tabName === 'shop') loadShop();
      if (tabName === 'myPokemon') loadMyPokemon();
    }

    // === Navigation ===
    document.getElementById('navArena').onclick = e => { e.preventDefault(); enterArenaBtn.click(); };
    document.getElementById('navShop').onclick = e => { e.preventDefault(); showTab('shop'); };
    document.getElementById('navMyPokemon').onclick = e => { e.preventDefault(); showTab('myPokemon'); };
    document.getElementById('navTournaments').onclick = e => { e.preventDefault(); loadTournaments(); };
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('trainerSession');
      location.href = 'index.html';
    };

    // === Load Tournaments ===
    function loadTournaments() {
      const history = JSON.parse(localStorage.getItem('tournaments') || '[]');
      tournamentEntries.innerHTML = '';
      if (history.length === 0) {
        tournamentEntries.innerHTML = '<p style="text-align:center;color:#aaa;">No tournaments yet. Enter the arena!</p>';
        return;
      }
      history.slice(-10).reverse().forEach((t, i) => {
        const div = document.createElement('div');
        div.className = 'tournament-item';
        div.innerHTML = `
          <span><strong>#${history.length - i}</strong> ${t.player} vs ${t.opponent}</span>
          <span style="color:${t.won ? '#4caf50' : '#f44336'};">
            ${t.won ? 'Victory Trophy' : 'Defeat'}
          </span>
        `;
        tournamentEntries.appendChild(div);
      });
    }

    // === Init ===
    loadEquipped();
    loadTournaments();
    loadShop();
    loadMyPokemon();
  </script>
</body>
</html>
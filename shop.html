<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Shop & My Pokémon</title>

  <!-- Ethers.js v5.7 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      min-height:100vh;
      color:white;
      background:#000000;
      font-family:'Inter',sans-serif;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POKÉMON</text></svg>') repeat;
      opacity:0.3;
      z-index:0;
      pointer-events:none;
    }
    body > header, body > .container{
      position:relative;
      z-index:1;
    }
    header{background:rgba(0,0,0,.6);backdrop-filter:blur(10px);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,.1);}
    header h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;text-shadow: 2px 2px 0 #000;}
    nav a{margin-left:1rem;color:#ffcb05;text-decoration:none;font-weight:600;transition:0.2s}
    nav a:hover{color:#fff;transform:translateY(-1px)}
    .coins{background:#ffeb3b;color:#1a2a6c;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
    .free-balance{background:#4caf50;color:#fff;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);}
    .wallet{margin-left:12px;font-size:.9rem;color:#ddd;font-family:monospace;}
    .connect-btn,.logout-btn{margin-left:12px;border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .connect-btn{background:#4caf50;color:#fff;}
    .connect-btn:hover{background:#45a049;transform:translateY(-1px);}
    .logout-btn{background:#f44336;color:#fff;display:none;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{max-width:1200px;margin:0 auto;padding:2rem 1rem;}
    .title{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.3rem;margin:2rem 0 0.5rem;text-shadow:1px 1px 0 #000;}
    .subtitle{color:#aaa;font-size:0.95rem;margin-bottom:1rem;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.2rem;margin-top:1rem;}
    .card{
      background:#1b1f3b;border:3px solid #e2c044;border-radius:16px;padding:1rem;text-align:center;
      transition:all 0.3s ease;box-shadow:0 4px 8px rgba(0,0,0,0.3);
      position:relative;overflow:hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:0;width:100%;height:4px;
      background:linear-gradient(90deg,#ffcb05,#4caf50,#2196f3,#e91e63);opacity:0.8;
    }
    .card:hover{transform:translateY(-6px);box-shadow:0 8px 16px rgba(0,0,0,0.4);border-color:#fff;}
    .card img{width:140px;height:140px;image-rendering:pixelated;margin:0.5rem 0;}
    .card h3{color:#fff;font-size:1rem;margin:0.5rem 0;font-weight:600;}
    .card .price{color:#ffeb3b;font-weight:700;margin:0.5rem 0;font-size:0.95rem;}
    .card button{
      width:100%;padding:10px;border:none;border-radius:10px;font-weight:700;
      cursor:pointer;transition:0.2s;margin-top:0.5rem;font-size:0.9rem;
    }
    .card button.coin-btn{background:#ff9800;color:#fff;}
    .card button.token-btn{background:#9c27b0;color:#fff;}
    .card button:disabled{background:#555;color:#aaa;cursor:not-allowed;opacity:0.6;}
    .card button:hover:not(:disabled){transform:scale(1.03);}
    .card .owned-tag{position:absolute;top:8px;right:8px;background:#4caf50;color:#fff;padding:4px 8px;border-radius:8px;font-size:0.7rem;font-weight:700;}

    .starter-card{border-color:#4caf50 !important;}
    .starter-card button{background:#8bc34a;color:#fff;}
    .starter-card button:disabled{background:#66bb6a;color:#ccc;}
  </style>
</head>
<body>
  <header>
    <div><h1>Pokémon Shop</h1></div>
    <nav>
      <a href="home.html">Home</a>
      <a href="arena.html">Arena</a>
      <a href="history.html">History</a>
      <a href="settings.html">Settings</a>
      <span class="coins" id="coinDisplay">500 Coins</span>
      <span class="free-balance" id="freeDisplay">0 FREE</span>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </nav>
  </header>

  <div class="container">
    <!-- Starters -->
    <div class="title">Starters</div>
    <div class="subtitle">Claim up to three free starters</div>
    <div class="grid" id="starterGrid"></div>

    <!-- Common Shop (Coins) -->
    <div class="title">Common Shop</div>
    <div class="subtitle">Spend coins to expand your team</div>
    <div class="grid" id="shopGrid"></div>

    <!-- Rare Shop (FREE Token) -->
    <div class="title">Rare Shop</div>
    <div class="subtitle">Buy rare Pokémon using FREE tokens</div>
    <div class="grid" id="rareGrid"></div>

    <!-- My Pokémon -->
    <div class="title">My Pokémon</div>
    <div class="grid" id="myGrid"></div>
  </div>

  <script>
    // Check ethers
    if (typeof ethers === 'undefined') {
      alert('Ethers.js failed to load! Check internet connection.');
      document.getElementById('connectBtn').textContent = 'Retry';
    }

    // Contracts
    const NFT_ADDRESS = '0x59b8a623eD7Bd62B94EeFA16881fc9f2b6Cd1A80';
    const TOKEN_ADDRESS = '0x462d1F9D67d91cba91108DE5C806C468D87a42cD';

    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function allowance(address,address) view returns (uint256)',
      'function approve(address,uint256) external'
    ];

    const NFT_ABI = [
      'function mintWithToken(address to,uint256 pokeId,string name,uint256 amount) external returns (uint256)'
    ];

    let signer, token, nft, userAddress;
    let coins = parseInt(localStorage.getItem('coins') || '500');
    let owned = JSON.parse(localStorage.getItem('owned') || '[]');
    let claimedStarters = JSON.parse(localStorage.getItem('claimedStarters') || '[]');

    // Update UI
    function updateCoinDisplay() {
      document.getElementById('coinDisplay').textContent = `${coins} Coins`;
      localStorage.setItem('coins', coins);
    }

    // Connect Wallet
    document.getElementById('connectBtn').onclick = async () => {
      if (typeof ethers === 'undefined') return alert('Ethers not loaded!');

      try {
        await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa36a7' }] });
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        const provider = new ethers.providers.Web3Provider(ethereum);
        signer = provider.getSigner();
        token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
        nft = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);

        document.getElementById('walletDisplay').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';

        await updateBalance();
        loadAll();
        alert('Wallet Connected!');
      } catch (e) {
        alert('Connection failed: ' + e.message);
      }
    };

    document.getElementById('logoutBtn').onclick = () => location.reload();

    async function updateBalance() {
      try {
        const bal = await token.balanceOf(userAddress);
        const formatted = ethers.utils.formatUnits(bal, 18).split('.')[0];
        document.getElementById('freeDisplay').textContent = `${formatted} FREE`;
      } catch (e) {
        console.error(e);
      }
    }

    function img(id) {
      return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
    }

    // Pokémon Data
    const starters = [
      {id: 1, name: 'Bulbasaur'},
      {id: 4, name: 'Charmander'},
      {id: 7, name: 'Squirtle'}
    ];

    const common = [
      {id: 25, name: 'Pikachu', price: 150}, {id: 133, name: 'Eevee', price: 200},
      {id: 52, name: 'Meowth', price: 120}, {id: 19, name: 'Rattata', price: 50},
      {id: 16, name: 'Pidgey', price: 60}, {id: 10, name: 'Caterpie', price: 40},
      {id: 69, name: 'Bellsprout', price: 80}, {id: 43, name: 'Oddish', price: 90},
      {id: 23, name: 'Ekans', price: 110}, {id: 27, name: 'Sandshrew', price: 100},
      {id: 37, name: 'Vulpix', price: 180}, {id: 63, name: 'Abra', price: 220},
      {id: 92, name: 'Gastly', price: 190}, {id: 129, name: 'Magikarp', price: 30},
      {id: 74, name: 'Geodude', price: 85}, {id: 95, name: 'Onix', price: 300},
      {id: 66, name: 'Machop', price: 140}, {id: 50, name: 'Diglett', price: 70},
      {id: 54, name: 'Psyduck', price: 130}, {id: 79, name: 'Slowpoke', price: 160},
      {id: 104, name: 'Cubone', price: 210}, {id: 111, name: 'Rhyhorn', price: 280},
      {id: 116, name: 'Horsea', price: 170}, {id: 118, name: 'Goldeen', price: 90},
      {id: 120, name: 'Staryu', price: 200}, {id: 147, name: 'Dratini', price: 500},
      {id: 172, name: 'Pichu', price: 250}, {id: 175, name: 'Togepi', price: 300},
      {id: 152, name: 'Chikorita', price: 180}, {id: 155, name: 'Cyndaquil', price: 180}
    ];

    const rare = [
      {id: 144, name: 'Articuno', price: 2500}, {id: 145, name: 'Zapdos', price: 2500},
      {id: 146, name: 'Moltres', price: 2500}, {id: 150, name: 'Mewtwo', price: 5000},
      {id: 151, name: 'Mew', price: 8000}, {id: 243, name: 'Raikou', price: 3500},
      {id: 244, name: 'Entei', price: 3500}, {id: 245, name: 'Suicune', price: 3500},
      {id: 249, name: 'Lugia', price: 6000}, {id: 250, name: 'Ho-Oh', price: 6000},
      {id: 380, name: 'Latias', price: 4500}, {id: 381, name: 'Latios', price: 4500},
      {id: 384, name: 'Rayquaza', price: 7000}, {id: 483, name: 'Dialga', price: 6500},
      {id: 484, name: 'Palkia', price: 6500}, {id: 487, name: 'Giratina', price: 6800},
      {id: 643, name: 'Reshiram', price: 6200}, {id: 644, name: 'Zekrom', price: 6200},
      {id: 646, name: 'Kyurem', price: 6000}, {id: 716, name: 'Xerneas', price: 5800},
      {id: 717, name: 'Yveltal', price: 5800}, {id: 789, name: 'Cosmog', price: 3000},
      {id: 791, name: 'Solgaleo', price: 7000}, {id: 792, name: 'Lunala', price: 7000},
      {id: 800, name: 'Necrozma', price: 7500}, {id: 888, name: 'Zacian', price: 6800},
      {id: 889, name: 'Zamazenta', price: 6800}, {id: 893, name: 'Zarude', price: 5500},
      {id: 898, name: 'Calyrex', price: 6000}, {id: 382, name: 'Kyogre', price: 5800}
    ];

    // Render Card
    function createCard(poke, type = 'common') {
      const has = owned.some(o => o.id === poke.id);
      const card = document.createElement('div');
      card.className = `card ${type === 'starter' ? 'starter-card' : ''}`;

      const priceText = type === 'token' ? `${poke.price} FREE` : `${poke.price} Coins`;
      const btnText = has ? 'Owned' : (type === 'starter' ? 'Claim' : type === 'token' ? 'Buy' : 'Buy');
      const btnClass = type === 'token' ? 'token-btn' : type === 'starter' ? '' : 'coin-btn';

      card.innerHTML = `
        <h3>${poke.name}</h3>
        <img src="${img(poke.id)}" alt="${poke.name}" loading="lazy">
        <div class="price">${priceText}</div>
        <button class="${btnClass}" ${has ? 'disabled' : ''} 
                onclick="${type === 'starter' ? `claimStarter(${poke.id}, '${poke.name}')` : 
                          type === 'token' ? `buyRare(${poke.id}, '${poke.name}', ${poke.price})` : 
                          `buyCommon(${poke.id}, '${poke.name}', ${poke.price})`}">
          ${btnText}
        </button>
        ${has ? '<div class="owned-tag">Owned</div>' : ''}
      `;
      return card;
    }

    // Load Sections
    function loadStarters() {
      const grid = document.getElementById('starterGrid');
      grid.innerHTML = '';
      starters.forEach(p => {
        if (claimedStarters.includes(p.id) || claimedStarters.length >= 3) {
          const card = createCard(p, 'starter');
          card.querySelector('button').disabled = true;
          card.querySelector('button').textContent = 'Claimed';
          grid.appendChild(card);
        } else {
          grid.appendChild(createCard(p, 'starter'));
        }
      });
    }

    function loadCommon() {
      const grid = document.getElementById('shopGrid');
      grid.innerHTML = '';
      common.forEach(p => grid.appendChild(createCard(p, 'common')));
    }

    function loadRare() {
      const grid = document.getElementById('rareGrid');
      grid.innerHTML = '';
      rare.forEach(p => grid.appendChild(createCard(p, 'token')));
    }

    function loadOwned() {
      const grid = document.getElementById('myGrid');
      grid.innerHTML = '';
      if (owned.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa;">No Pokémon yet. Start collecting!</p>';
        return;
      }
      owned.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${p.name}</h3>
          <img src="${img(p.id)}" alt="${p.name}">
          <div class="price">#${p.id}</div>
        `;
        grid.appendChild(card);
      });
    }

    function loadAll() {
      loadStarters();
      loadCommon();
      loadRare();
      loadOwned();
    }

    // Actions
    window.claimStarter = (id, name) => {
      if (claimedStarters.length >= 3) return alert('You can only claim 3 starters!');
      if (claimedStarters.includes(id)) return;

      claimedStarters.push(id);
      owned.push({id, name});
      localStorage.setItem('claimedStarters', JSON.stringify(claimedStarters));
      localStorage.setItem('owned', JSON.stringify(owned));
      loadAll();
      alert(`Claimed ${name}!`);
    };

    window.buyCommon = (id, name, price) => {
      if (coins < price) return alert('Not enough Coins!');
      if (owned.some(o => o.id === id)) return;

      coins -= price;
      owned.push({id, name});
      updateCoinDisplay();
      localStorage.setItem('owned', JSON.stringify(owned));
      loadAll();
      alert(`Bought ${name} for ${price} Coins!`);
    };

    window.buyRare = async (id, name, price) => {
      if (!userAddress) return alert('Connect wallet first!');
      if (owned.some(o => o.id === id)) return;

      try {
        const amount = ethers.utils.parseUnits(price.toString(), 18);
        const bal = await token.balanceOf(userAddress);
        if (bal.lt(amount)) return alert('Not enough FREE tokens!');

        const allow = await token.allowance(userAddress, NFT_ADDRESS);
        if (allow.lt(amount)) {
          const approveTx = await token.approve(NFT_ADDRESS, ethers.constants.MaxUint256);
          await approveTx.wait();
          alert('Approved token spending!');
        }

        const mintTx = await nft.mintWithToken(userAddress, id, name, amount);
        await mintTx.wait();

        owned.push({id, name});
        localStorage.setItem('owned', JSON.stringify(owned));
        await updateBalance();
        loadAll();
        alert(`Minted ${name} with ${price} FREE!`);
      } catch (e) {
        alert('Transaction failed: ' + (e.message || e));
      }
    };

    // Init
    updateCoinDisplay();
    loadAll();

    // Auto-reload on storage change (for multi-tab)
    window.addEventListener('storage', (e) => {
      if (e.key === 'owned' || e.key === 'coins' || e.key === 'claimedStarters') {
        owned = JSON.parse(localStorage.getItem('owned') || '[]');
        coins = parseInt(localStorage.getItem('coins') || '500');
        claimedStarters = JSON.parse(localStorage.getItem('claimedStarters') || '[]');
        updateCoinDisplay();
        loadAll();
      }
    });

    // Uniform dark background applied via CSS above
  </script>
</body>
</html>
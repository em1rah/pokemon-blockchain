<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Shop & My Pok√©mon</title>

  <!-- Ethers.js v5.7 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <!-- Font Awesome 6.5.1 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      min-height:100vh;
      color:white;
      background:#000000;
      font-family:'Inter',sans-serif;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Arial" font-size="120" fill="rgba(255,203,5,0.05)" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 100 100)">POK√âMON</text></svg>') repeat;
      opacity:0.3;z-index:0;pointer-events:none;
    }
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:linear-gradient(180deg,#0b1021,#0a0f1d);border-right:1px solid rgba(255,255,255,.08);z-index:20}
    .sidebar .brand{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sidebar .brand h1{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.1rem;margin:0}
    .menu{padding:12px}
    .menu a{display:block;color:#ffcb05;text-decoration:none;font-weight:700;padding:10px 12px;border:2px solid rgba(255,203,5,.25);border-radius:10px;margin-bottom:10px;transition:.2s}
    .menu a:hover{background:rgba(255,203,5,.15);border-color:#fff;transform:translateX(4px)}
    .status{position:absolute;left:12px;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
    .coins{color:#efe339;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .free-balance{color:#9362ed;padding:8px 14px;border-radius:12px;font-weight:700;font-size:0.9rem;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.3);text-align:center}
    .wallet{font-size:.9rem;color:#ddd;font-family:monospace;text-align:center}
    .connect-btn,.logout-btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.9rem;}
    .connect-btn{background:#4caf50;color:#fff;}
    .connect-btn:hover{background:#45a049;transform:translateY(-1px);}
    .logout-btn{background:#f44336;color:#fff;display:none;}
    .logout-btn:hover{background:#d32f2f;transform:translateY(-1px);}

    .container{max-width:1200px;margin:0 auto;padding:2rem 1rem;margin-left:240px}
    .title{font-family:'Press Start 2P',cursive;color:#ffcb05;font-size:1.3rem;margin:2rem 0 0.5rem;text-shadow:1px 1px 0 #000;}
    .subtitle{color:#aaa;font-size:0.95rem;margin-bottom:1rem;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;margin-top:1rem;}

    .card {
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(255, 203, 5, 0.3);
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(20, 20, 40, 0.8) 0%, rgba(10, 10, 30, 0.9) 100%);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      transition: all 0.3s ease;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(45deg,
        transparent 30%,
        rgba(255,203,5,0.1) 40%,
        rgba(74,144,226,0.15) 50%,
        rgba(255,203,5,0.1) 60%,
        transparent 70%);
      background-size: 200% 200%;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
      z-index: 1;
    }
    .card:hover::before { opacity: 1; animation: shimmer 2.5s infinite linear; }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

    .card-header{
      background:linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 100%);
      padding:40px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:3px solid rgba(255,203,5,0.4);
      position:relative;
      z-index:2;
      backdrop-filter:blur(4px);
      min-height:60px;
    }
    .card-name{
      color:#ffcb05;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      text-shadow:0 0 10px rgba(255,203,5,0.8), 0 2px 4px rgba(0,0,0,0.8);
      font-family:'Press Start 2P',cursive;
      font-size:0.65rem;
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      margin-right:8px;
    }
    .card-hp{
      display:flex;
      align-items:center;
      gap:4px;
      color:#fff;
      font-weight:700;
      font-size:0.8rem;
      flex-shrink:0;
    }
    .hp-value{
      background:linear-gradient(135deg, #e91e63 0%, #c2185b 50%, #ad1457 100%);
      padding:4px 10px;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.3);
      box-shadow:0 3px 6px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.2);
      font-size:0.85rem;
      white-space:nowrap;
    }

    .rarity-badge{
      position:absolute;
      top:8px; left:8px;
      background:linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color:#1a1a2e;
      padding:5px 8px;
      border-radius:16px;
      font-size:0.6rem;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.5px;
      z-index:10;
      border:2px solid rgba(255,255,255,0.5);
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
      display:flex;
      align-items:center;
      gap:3px;
      max-width:calc(100% - 100px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rarity-star i {font-size:0.75rem;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));}

    .card-type{
      position:absolute;
      top:8px; right:8px;
      background:linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
      padding:6px 10px;
      border-radius:20px;
      border:2px solid #ffcb05;
      font-size:0.65rem;
      font-weight:700;
      color:#ffcb05;
      text-transform:uppercase;
      letter-spacing:1px;
      z-index:10;
      backdrop-filter:blur(6px);
      box-shadow:0 4px 8px rgba(0,0,0,0.5);
      max-width:80px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .card-image-area{
      flex:1;
      min-height:160px;
      max-height:200px;
      background:linear-gradient(to bottom, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.3) 100%), radial-gradient(circle at 50% 30%, rgba(255,203,5,0.15) 0%, transparent 60%);
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      z-index:2;
      border-top:3px solid rgba(255,203,5,0.3);
      border-bottom:3px solid rgba(255,203,5,0.3);
      margin:4px 8px;
      border-radius:12px;
    }
    .card-image-area::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      border:2px solid rgba(255,203,5,0.2);
      border-radius:12px;
      pointer-events:none;
    }
    .card-image-area::after{
      content:'';
      position:absolute;
      top:8px;left:8px;right:8px;bottom:8px;
      background:radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.3) 100%);
      border-radius:8px;
      pointer-events:none;
    }
    .card img{
      width:100%;
      height:100%;
      max-width:160px;
      max-height:160px;
      object-fit:contain;
      image-rendering:auto;
      filter:drop-shadow(0 6px 12px rgba(0,0,0,0.6));
      position:relative;
      z-index:1;
      transition:transform 0.4s;
    }
    .card:hover img{transform:scale(1.15) translateY(-5px);}

    .card-info{
      background:linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 100%);
      padding:12px 14px 50px;
      border-top:3px solid rgba(255,203,5,0.4);
      position:relative;
      z-index:2;
      backdrop-filter:blur(4px);
      flex-shrink:0;
    }

    .attack-section{
      margin:8px 0;
      padding:8px;
      background:rgba(0,0,0,0.4);
      border-radius:6px;
      border-left:3px solid #ffcb05;
    }
    .attack-name{
      color:#ffcb05;
      font-weight:700;
      font-size:0.75rem;
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .attack-cost{
      display:flex;
      gap:3px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }
    .energy-symbol{
      width:18px;
      height:18px;
      border-radius:50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:0.65rem;
      font-weight:700;
      border:1.5px solid rgba(255,255,255,0.3);
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
      flex-shrink:0;
      background:rgba(255,255,255,0.1);
    }
    .attack-damage{
      color:#fff;
      font-weight:700;
      font-size:0.85rem;
      margin-left:auto;
      white-space:nowrap;
    }
    .card-id{
      color:rgba(255,255,255,0.6);
      font-size:0.65rem;
      font-weight:600;
      margin-bottom:6px;
      font-family:monospace;
      text-transform:uppercase;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .card-price{
      color:#ffcb05;
      font-weight:700;
      font-size:0.95rem;
      margin-bottom:8px;
      text-shadow:0 2px 4px rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      gap:6px;
      overflow:hidden;
    }
    .card-price span:last-child{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .price-icon{font-size:1.2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));flex-shrink:0;line-height:1;}

    .set-symbol{
      position:absolute;
      bottom:10px;
      right:10px;
      width:28px;
      height:28px;
      background:rgba(0,0,0,0.7);
      border:2px solid #ffcb05;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      color:#ffcb05;
      font-weight:700;
      z-index:3;
      flex-shrink:0;
    }

    .card button{
      width:100%;
      padding:14px;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s;
      font-size:0.95rem;
      text-transform:uppercase;
      letter-spacing:1.5px;
      margin-top:10px;
      box-shadow:0 6px 12px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.2);
      position:relative;
      z-index:2;
      overflow:hidden;
    }
    .card button::before{
      content:'';
      position:absolute;
      top:50%;left:50%;width:0;height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%,-50%);
      transition:width 0.5s, height 0.5s;
    }
    .card button:hover::before{width:300px;height:300px;}
    .card button.coin-btn{background:linear-gradient(135deg, #ff9800 0%, #f57c00 50%, #e65100 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button.token-btn{background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 50%, #6a1b9a 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button.sell-btn{background:linear-gradient(135deg, #f44336 0%, #d32f2f 50%, #b71c1c 100%);color:#fff;border:2px solid rgba(255,255,255,0.3);}
    .card button:disabled{background:rgba(85,85,85,0.4);color:#aaa;cursor:not-allowed;opacity:0.6;border-color:rgba(255,255,255,0.1);}
    .card button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,0.6), inset 0 1px 3px rgba(255,255,255,0.3);}
    .card button:active:not(:disabled){transform:translateY(-1px);}

    .starter-card{border-color:#4caf50 !important;background:linear-gradient(135deg, #1a3e1a 0%, #1e4a1e 50%, #162816 100%);}
    .starter-card::before{background:linear-gradient(45deg, transparent 30%, rgba(76,175,80,0.2) 40%, rgba(139,195,74,0.25) 50%, rgba(76,175,80,0.2) 60%, transparent 70%);}
    .starter-card button{background:linear-gradient(135deg, #8bc34a 0%, #689f38 50%, #558b2f 100%);}
    .starter-card button:disabled{background:rgba(102,187,106,0.4);color:#ccc;}

    .rare-card{border-color:#9c27b0 !important;background:linear-gradient(135deg, #2d1b3d 0%, #1a0f26 50%, #0d0513 100%);}
    .rare-card::before{background:linear-gradient(45deg, transparent 30%, rgba(156,39,176,0.2) 40%, rgba(123,31,162,0.3) 50%, rgba(156,39,176,0.2) 60%, transparent 70%);}
    .rare-card .rarity-badge{background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:#fff;}

    .weakness-resistance{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      margin-bottom:6px;
      font-size:0.65rem;
      color:rgba(255,255,255,0.7);
    }
    .weakness-resistance span{
      display:flex;
      align-items:center;
      gap:3px;
      flex:1;
      min-width:calc(50% - 4px);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .card-error {
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      border-radius: 8px;
      color: #ff8a80;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .card-error i {font-size: 0.9rem;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

    @media(max-width:1200px){.grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}}
    @media(max-width:768px){.grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;}.card{aspect-ratio:2.5/3.5;}.card img{max-width:140px;max-height:140px;}.card-header{padding:38px 10px 8px;}.card-name{font-size:0.6rem;}.hp-value{font-size:0.75rem;padding:3px 8px;}.card-type{font-size:0.6rem;padding:5px 8px;max-width:70px;}.rarity-badge{font-size:0.55rem;padding:4px 6px;}.attack-section{padding:6px;}.attack-name{font-size:0.7rem;}.card-info{padding:10px 12px 45px;}.set-symbol{width:24px;height:24px;font-size:0.9rem;bottom:8px;right:8px;}}
    @media(max-width:480px){.grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.8rem;}.card-header{min-height:55px;padding:35px 8px 6px;}.card-image-area{min-height:140px;max-height:160px;padding:10px;}.card img{max-width:120px;max-height:120px;}.weakness-resistance{font-size:0.6rem;gap:6px;}.weakness-resistance span{min-width:100%;}.card button{font-size:0.85rem;padding:12px;}}

    .pokemon-img {
      transition: opacity 0.3s ease !important;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><h1>Pikaplay Shop</h1></div>
    <div class="menu">
        <a href="home.html">üè† Home</a>
      <a href="arena.html">‚öî Arena</a>
      <a href="shop.html">üõí Shop</a>
      <a href="settings.html">‚öô Settings</a>
    </div>
    <div class="status">
      <span class="coins" id="coinDisplay">500 Coins</span>
      <span class="free-balance" id="freeDisplay">0 TOKEN</span>
      <button class="connect-btn" id="faucetBtn" style="background:#2196f3;display:none;">Claim 1000 TOKEN</button>
      <span class="wallet" id="walletDisplay"></span>
      <button class="connect-btn" id="connectBtn">Connect Wallet</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <div class="title">Starters</div>
    <div class="subtitle">Claim up to three free starters</div>
    <div class="grid" id="starterGrid"></div>

    <div class="title">Common Shop</div>
    <div class="subtitle">Spend coins to expand your team</div>
    <div class="grid" id="shopGrid"></div>

    <div class="title">Rare Shop</div>
    <div class="subtitle">Buy rare Pok√©mon using tokens</div>
    <div class="grid" id="rareGrid"></div>

    <div class="title">My Pok√©mon <button id="refreshOwned" style="font-size:0.7rem;margin-left:1rem;padding:4px 8px;border-radius:8px;background:#ffcb05;color:#000;border:none;cursor:pointer;">Refresh</button></div>
    <div class="grid" id="myGrid"></div>
  </div>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const TOKEN_ADDRESS = '0x614f35C48c780e637496B3F707c9373723689868';
  const NFT_ADDRESS   = '0x766dc5E64851d68b3Ff82dB43Cf21AdcC8F991cC';
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const ERC20_ABI = [
    'function balanceOf(address) view returns (uint256)',
    'function allowance(address,address) view returns (uint256)',
    'function approve(address,uint256) external',
    'function faucetMint(address) external'
  ];

  const NFT_ABI = [
    // mint
    'function mintWithToken(address to,uint256 pokeId,string name,uint256 amount) external returns (uint256)',
    // marketplace
    'function listForSale(uint256 tokenId,uint256 price) external',
    'function cancelListing(uint256 tokenId) external',
    'function buyListed(uint256 tokenId) external',
    // optional burn-refund
    'function sellAndRefund(uint256 tokenId) external',
    // view
    'function balanceOf(address) view returns (uint256)',
    'function tokenOfOwnerByIndex(address owner,uint256 index) view returns (uint256)',
    'function listings(uint256) view returns (tuple(uint256 price, address seller))',
    'function purchasePrice(uint256) view returns (uint256)'
  ];

  let provider, signer, token, nft, userAddress;
  let coins = parseInt(localStorage.getItem('coins') || '500');
  let ownedLocal = JSON.parse(localStorage.getItem('owned') || '[]');
  let claimedStarters = JSON.parse(localStorage.getItem('claimedStarters') || '[]');

  const coinDisplay = document.getElementById('coinDisplay');
  const freeDisplay = document.getElementById('freeDisplay');
  const walletDisplay = document.getElementById('walletDisplay');

  /* ---------- UI HELPERS ---------- */
  function showError(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.cssText = `position:fixed;top:20px;right:20px;z-index:9999;background:#c62828;color:#fff;padding:12px 20px;border-radius:8px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.5);animation:fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
  const style = document.createElement('style');
  style.textContent = `@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-10px)}}`;
  document.head.appendChild(style);

  function updateCoinDisplay() {
    coinDisplay.textContent = `${coins} Coins`;
    localStorage.setItem('coins', coins);
  }

  async function updateTokenBalance() {
    if (!token || !userAddress) return;
    try {
      const bal = await token.balanceOf(userAddress);
      const fmt = ethers.utils.formatUnits(bal, 18).split('.')[0];
      freeDisplay.textContent = `${fmt} TOKEN`;
    } catch (e) { console.error(e); }
  }

  /* ---------- WALLET ---------- */
  document.getElementById('connectBtn').onclick = async () => {
    if (!window.ethereum) return showError('Install MetaMask!');
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa36a7' }] });
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      userAddress = accounts[0];

      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
      nft = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);

      walletDisplay.textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
      document.getElementById('connectBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      document.getElementById('faucetBtn').style.display = 'inline-block';

      await updateTokenBalance();
      await syncOwnedFromChain();
      loadAll();
      alert('Connected to Sepolia');
    } catch (e) { showError('Connect failed: ' + (e?.message || e)); }
  };
  document.getElementById('logoutBtn').onclick = () => location.reload();
  document.getElementById('faucetBtn').onclick = async () => {
    if (!token || !userAddress) return showError('Connect wallet first');
    try {
      const tx = await token.faucetMint(userAddress);
      await tx.wait();
      await updateTokenBalance();
      alert('Claimed 1000 TOKEN');
    } catch (e) { showError('Claim failed: ' + (e?.error?.message || e?.message || e)); }
  };

  /* ---------- SYNC OWNED (on-chain) ---------- */
  async function syncOwnedFromChain() {
    if (!nft || !userAddress) return;
    const ownedOnChain = [];
    try {
      const bal = await nft.balanceOf(userAddress);
      for (let i = 0; i < bal; i++) {
        const id = await nft.tokenOfOwnerByIndex(userAddress, i);
        const pokeId = Number(id);
        const name = getNameFromId(pokeId);
        const listing = await nft.listings(pokeId);
        ownedOnChain.push({ id: pokeId, name, price: Number(ethers.utils.formatUnits(listing.price, 18)), seller: listing.seller });
      }
    } catch (e) { console.error(e); showError('Sync failed'); return; }

    const localOnly = ownedLocal.filter(p => {
      const d = getPurchaseDetails(p.id);
      return d && d.currency !== 'token';
    });
    ownedLocal = [...localOnly, ...ownedOnChain];
    localStorage.setItem('owned', JSON.stringify(ownedLocal));
    loadOwned();
  }
  document.getElementById('refreshOwned').onclick = syncOwnedFromChain;

  /* ---------- DATA ---------- */
  function getNameFromId(id) {
    const map = {
      1:'Bulbasaur',4:'Charmander',7:'Squirtle',
      10:'Caterpie',13:'Weedle',16:'Pidgey',19:'Rattata',21:'Spearow',
      23:'Ekans',27:'Sandshrew',29:'Nidoran‚ôÄ',32:'Nidoran‚ôÇ',35:'Clefairy',
      37:'Vulpix',39:'Jigglypuff',41:'Zubat',43:'Oddish',46:'Paras',
      48:'Venonat',50:'Diglett',52:'Meowth',54:'Psyduck',56:'Mankey',
      58:'Growlithe',60:'Poliwag',63:'Abra',66:'Machop',69:'Bellsprout',
      72:'Tentacool',74:'Geodude',77:'Ponyta',79:'Slowpoke',81:'Magnemite',
      144:'Articuno',145:'Zapdos',146:'Moltres',150:'Mewtwo',151:'Mew',
      243:'Raikou',244:'Entei',245:'Suicune',249:'Lugia',250:'Ho-Oh',
      377:'Regirock',378:'Regice',379:'Registeel',380:'Latias',381:'Latios',
      382:'Kyogre',383:'Groudon',384:'Rayquaza',385:'Jirachi',386:'Deoxys',
      480:'Uxie',481:'Mesprit',482:'Azelf',483:'Dialga',484:'Palkia',
      485:'Heatran',486:'Regigigas',487:'Giratina',488:'Cresselia',491:'Darkrai'
    };
    return map[id] || `Poke #${id}`;
  }

  function img(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }

  const starters = [
    {id:1,name:'Bulbasaur', type:'Grass'},
    {id:4,name:'Charmander', type:'Fire'},
    {id:7,name:'Squirtle', type:'Water'}
  ];

  const common = [
 {id:32,name:'Nidoran‚ôÇ',price:180,type:'Poison'},
    {id:37,name:'Vulpix',price:220,type:'Fire'},
    {id:39,name:'Jigglypuff',price:240,type:'Normal'},
    {id:41,name:'Zubat',price:150,type:'Poison'},
    {id:43,name:'Oddish',price:170,type:'Grass'},
    {id:48,name:'Venonat',price:180,type:'Bug'},
    {id:52,name:'Meowth',price:210,type:'Normal'},
    {id:58,name:'Growlithe',price:230,type:'Fire'},
    {id:60,name:'Poliwag',price:170,type:'Water'},
    {id:63,name:'Abra',price:290,type:'Psychic'},
    {id:69,name:'Bellsprout',price:170,type:'Grass'},
    {id:72,name:'Tentacool',price:190,type:'Water'},
    {id:74,name:'Geodude',price:180,type:'Rock'},
    {id:77,name:'Ponyta',price:240,type:'Fire'},
    {id:81,name:'Magnemite',price:220,type:'Electric'}
  ];

  const rare = [
    {id:144,name:'Articuno',price:3200,type:'Ice'},
    {id:145,name:'Zapdos',price:3200,type:'Electric'},
    {id:146,name:'Moltres',price:3200,type:'Fire'},
    {id:150,name:'Mewtwo',price:6800,type:'Psychic'},
    {id:151,name:'Mew',price:9200,type:'Psychic'},
    {id:243,name:'Raikou',price:4200,type:'Electric'},
    {id:244,name:'Entei',price:4200,type:'Fire'},
    {id:245,name:'Suicune',price:4200,type:'Water'},
    {id:249,name:'Lugia',price:7200,type:'Psychic'},
    {id:250,name:'Ho-Oh',price:7200,type:'Fire'},
    {id:377,name:'Regirock',price:4800,type:'Rock'},
    {id:378,name:'Regice',price:4800,type:'Ice'},
    {id:379,name:'Registeel',price:4800,type:'Steel'},
    {id:380,name:'Latias',price:5200,type:'Dragon'},
    {id:381,name:'Latios',price:5200,type:'Dragon'},
    {id:382,name:'Kyogre',price:6800,type:'Water'},
    {id:383,name:'Groudon',price:6800,type:'Ground'},
    {id:384,name:'Rayquaza',price:8200,type:'Dragon'},
    {id:385,name:'Jirachi',price:5800,type:'Steel'},
    {id:386,name:'Deoxys',price:7000,type:'Psychic'},
    {id:480,name:'Uxie',price:4600,type:'Psychic'},
    {id:481,name:'Mesprit',price:4600,type:'Psychic'},
    {id:482,name:'Azelf',price:4600,type:'Psychic'},
    {id:483,name:'Dialga',price:7200,type:'Steel'},
    {id:484,name:'Palkia',price:7200,type:'Water'},
    {id:485,name:'Heatran',price:5800,type:'Fire'},
    {id:486,name:'Regigigas',price:6800,type:'Normal'},
    {id:487,name:'Giratina',price:7500,type:'Ghost'},
    {id:488,name:'Cresselia',price:5200,type:'Psychic'},
    {id:491,name:'Darkrai',price:6800,type:'Dark'}
  ];

  function getPokemonType(id) {
    return common.find(p=>p.id===id)?.type ||
           rare.find(p=>p.id===id)?.type ||
           starters.find(p=>p.id===id)?.type || 'Normal';
  }

  function getPokemonHP(id) {
    return Math.min(200, 50 + Math.floor(id / 2.5) + (id > 150 ? 50 : 0) + (id > 700 ? 40 : 0));
  }

  function getRarity(type, price) {
    if (type === 'starter') return { level: 'STARTER', stars: '<i class="fa-solid fa-seedling"></i>' };
    if (type === 'token') {
      if (price >= 7000) return { level: 'MYTHICAL', stars: '<i class="fa-solid fa-star"></i>'.repeat(5) };
      if (price >= 5000) return { level: 'LEGENDARY', stars: '<i class="fa-solid fa-star"></i>'.repeat(4) };
      if (price >= 3000) return { level: 'ULTRA', stars: '<i class="fa-solid fa-star"></i>'.repeat(3) };
      return { level: 'RARE', stars: '<i class="fa-solid fa-star"></i>'.repeat(2) };
    }
    if (price >= 250) return { level: 'UNCOMMON', stars: '<i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>' };
    return { level: 'COMMON', stars: '<i class="fa-solid fa-star"></i>' };
  }

  function getAttack(type) {
    const attacks = {
      'Bug': { name: 'Bug Bite', cost: ['leaf'], damage: 60 },
      'Normal': { name: 'Tackle', cost: [], damage: 40 },
      'Poison': { name: 'Poison Sting', cost: ['ghost'], damage: 50 },
      'Ground': { name: 'Earthquake', cost: ['steel','steel'], damage: 100 },
      'Fairy': { name: 'Dazzling Gleam', cost: ['sparkles','sparkles'], damage: 80 },
      'Fire': { name: 'Ember', cost: ['fire'], damage: 70 },
      'Water': { name: 'Water Gun', cost: ['water'], damage: 60 },
      'Grass': { name: 'Vine Whip', cost: ['leaf'], damage: 65 },
      'Electric': { name: 'Thunder Shock', cost: ['lightning'], damage: 70 },
      'Psychic': { name: 'Confusion', cost: ['crystal'], damage: 75 },
      'Ice': { name: 'Ice Shard', cost: ['snowflake'], damage: 70 },
      'Fighting': { name: 'Karate Chop', cost: ['fist'], damage: 70 },
      'Rock': { name: 'Rock Throw', cost: ['steel'], damage: 65 },
      'Ghost': { name: 'Lick', cost: ['ghost'], damage: 60 },
      'Dragon': { name: 'Dragon Rage', cost: ['dragon'], damage: 90 },
      'Dark': { name: 'Bite', cost: ['dark'], damage: 70 },
      'Steel': { name: 'Metal Claw', cost: ['steel'], damage: 75 }
    };
    return attacks[type] || attacks['Normal'];
  }

  function getPurchaseDetails(id) {
    const s = starters.find(x=>x.id===id); if(s) return {price:0,currency:'free'};
    const c = common.find(x=>x.id===id); if(c) return {price:c.price,currency:'coins'};
    const r = rare.find(x=>x.id===id); if(r) return {price:r.price,currency:'token'};
    return null;
  }

  const energyIcons = {
    fire: '<i class="fa-solid fa-fire"></i>',
    water: '<i class="fa-solid fa-droplet"></i>',
    leaf: '<i class="fa-solid fa-leaf"></i>',
    lightning: '<i class="fa-solid fa-bolt"></i>',
    crystal: '<i class="fa-solid fa-gem"></i>',
    snowflake: '<i class="fa-solid fa-snowflake"></i>',
    ghost: '<i class="fa-solid fa-ghost"></i>',
    dragon: '<i class="fa-solid fa-dragon"></i>',
    sparkles: '<i class="fa-solid fa-sparkles"></i>',
    fist: '<i class="fa-solid fa-hand-fist"></i>',
    dark: '<i class="fa-solid fa-moon"></i>',
    steel: '<i class="fa-solid fa-shield"></i>'
  };

  /* ---------- CARD CREATION ---------- */
  function createCard(poke, type, listing = null) {
    const has = ownedLocal.some(o => o.id === poke.id);
    const card = document.createElement('div');
    const cardClass = type === 'starter' ? 'starter-card' : type === 'token' ? 'rare-card' : '';
    card.className = `card ${cardClass} ${has ? 'has-owned' : ''}`;

    const pokemonType = getPokemonType(poke.id);
    const hp = getPokemonHP(poke.id);
    const attack = getAttack(pokemonType);
    const rarity = getRarity(type, poke.price);
    const priceIcon = type === 'token' ? '<i class="fa-solid fa-gem"></i>' : '<i class="fa-solid fa-coins"></i>';
    const priceText = type === 'token' ? `${poke.price} TOKEN` : `${poke.price} Coins`;

    const staticImg = img(poke.id);
    const gifImg = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${poke.id}.gif`;

    // ---------- BUTTON ----------
    let btnHTML = '';
    if (type === 'starter') {
      const claimed = claimedStarters.includes(poke.id) || claimedStarters.length >= 3;
      btnHTML = `<button class="coin-btn" ${claimed?'disabled':''} onclick="${claimed?'':'claimStarter('+poke.id+',\''+poke.name+'\')'}">${claimed?'Claimed':'Claim'}</button>`;
    } else if (type === 'common') {
      btnHTML = `<button class="coin-btn" ${has?'disabled':''} onclick="${has?'':'buyCommon('+poke.id+',\''+poke.name+'\','+poke.price+')'}">${has?'Owned':'Buy'}</button>`;
    } else if (type === 'token') {
      if (listing && listing.price > 0) {
        const isOwner = listing.seller.toLowerCase() === userAddress?.toLowerCase();
        if (isOwner) {
          btnHTML = `<button class="sell-btn" onclick="cancelListing(${poke.id})">Cancel</button>`;
        } else {
          btnHTML = `<button class="token-btn" onclick="buyListed(${poke.id})">Buy ${listing.price} TOKEN</button>`;
        }
      } else {
        btnHTML = `<button class="token-btn" ${has?'disabled':''} onclick="${has?'':'buyRare('+poke.id+',\''+poke.name+'\','+poke.price+')'}">${has?'Owned':'Buy with TOKEN'}</button>`;
      }
    }

    card.innerHTML = `
      <div class="rarity-badge"><span class="rarity-star">${rarity.stars}</span><span>${rarity.level}</span></div>
      <div class="card-header"><div class="card-name">${poke.name}</div><div class="card-hp"><i class="fa-solid fa-star"></i><span class="hp-value">${hp}</span></div></div>
      <div class="card-type"><i class="fa-solid fa-${pokemonType.toLowerCase()=== 'normal' ? 'paw' : pokemonType.toLowerCase()=== 'psychic' ? 'brain' : pokemonType.toLowerCase()}"></i> ${pokemonType}</div>
      <div class="card-image-area">
        <img src="${staticImg}" data-gif="${gifImg}" alt="${poke.name}" loading="lazy" class="pokemon-img" onload="this.style.opacity=1" style="opacity:0;">
      </div>
      <div class="card-info">
        <div class="attack-section">
          <div class="attack-cost">${attack.cost.map(e=>`<span class="energy-symbol">${energyIcons[e]}</span>`).join('')}</div>
          <div class="attack-name">${attack.name}</div>
          <div style="display:flex;justify-content:space-between;"><span style="color:#aaa;font-size:.75rem;">Damage</span><span class="attack-damage">${attack.damage}</span></div>
        </div>
        <div class="card-id">#${String(poke.id).padStart(3,'0')} | ${poke.name}</div>
        <div class="weakness-resistance">
          <span><i class="fa-solid fa-bolt"></i> Weak: ???</span>
          <span><i class="fa-solid fa-shield"></i> Resist: ???</span>
        </div>
        <div class="card-price"><span class="price-icon">${priceIcon}</span><span>${priceText}</span></div>
        ${btnHTML}
        <div class="set-symbol"><i class="fa-solid fa-baseball"></i></div>
      </div>
    `;
    return card;
  }

  /* ---------- LOAD GRIDS ---------- */
  function loadStarters() {
    const grid = document.getElementById('starterGrid'); grid.innerHTML = '';
    starters.forEach(p => {
      if (claimedStarters.includes(p.id) || claimedStarters.length >= 3) {
        const card = createCard(p, 'starter');
        card.querySelector('button').disabled = true;
        card.querySelector('button').textContent = 'Claimed';
        grid.appendChild(card);
      } else {
        grid.appendChild(createCard(p, 'starter'));
      }
    });
  }

  function loadCommon() {
    const grid = document.getElementById('shopGrid'); grid.innerHTML = '';
    common.forEach(p => grid.appendChild(createCard(p, 'common')));
  }

  async function loadRare() {
    const grid = document.getElementById('rareGrid'); grid.innerHTML = '';
    for (const p of rare) {
      let listing = {price:0, seller:ethers.constants.AddressZero};
      try { listing = await nft.listings(p.id); } catch(e){}
      const price = Number(ethers.utils.formatUnits(listing.price, 18));
      grid.appendChild(createCard(p, 'token', price>0?{price,seller:listing.seller}:null));
    }
  }

 async function loadOwned() {
  const grid = document.getElementById('myGrid'); grid.innerHTML = '';
  if (!ownedLocal.length) {
    grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa;padding:2rem;">No Pok√©mon yet. Start collecting!</p>';
    return;
  }

  for (const p of ownedLocal) {
    const pokemonType = getPokemonType(p.id);
    const hp = getPokemonHP(p.id);
    const attack = getAttack(pokemonType);
    const card = document.createElement('div');
    card.className = 'card has-owned';

    const staticImg = img(p.id);
    const gifImg = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.id}.gif`;

    let extraBtn = '';

    const isStarter = starters.some(s => s.id === p.id);
    const isCommon  = common.some(c => c.id === p.id);

    if (isStarter || isCommon) {
    }
    else if (p.price !== undefined) {              
      if (p.price > 0) {
        extraBtn = `<button class="sell-btn" onclick="cancelListing(${p.id})">Cancel Sale</button>`;
      } else {
        extraBtn = `<button class="sell-btn" onclick="promptList(${p.id},'${p.name}')">List for Sale</button>`;
      }
    }
  
    else {
      extraBtn = `<button class="sell-btn" onclick="sellPokemon(${p.id},'${p.name}')">Sell (50% refund)</button>`;
    }

    card.innerHTML = `
      <div class="owned-tag"><i class="fa-solid fa-check"></i> Owned</div>
      <div class="rarity-badge"><i class="fa-solid fa-trophy"></i><span>COLLECTION</span></div>
      <div class="card-header"><div class="card-name">${p.name}</div><div class="card-hp"><i class="fa-solid fa-star"></i><span class="hp-value">${hp}</span></div></div>
      <div class="card-type"><i class="fa-solid fa-${pokemonType.toLowerCase()}"></i> ${pokemonType}</div>
      <div class="card-image-area">
        <img src="${staticImg}" data-gif="${gifImg}" alt="${p.name}" loading="lazy" class="pokemon-img" onload="this.style.opacity=1" style="opacity:0;">
      </div>
      <div class="card-info">
        <div class="attack-section">
          <div class="attack-cost">${attack.cost.map(e=>`<span class="energy-symbol">${energyIcons[e]||''}</span>`).join('')}</div>
          <div class="attack-name">${attack.name}</div>
          <div style="display:flex;justify-content:space-between;"><span style="color:#aaa;font-size:.75rem;">Damage</span><span class="attack-damage">${attack.damage}</span></div>
        </div>
        <div class="card-id">#${String(p.id).padStart(3,'0')} | ${p.name}</div>
        ${extraBtn}
        <div class="set-symbol"><i class="fa-solid fa-baseball"></i></div>
      </div>
    `;
    grid.appendChild(card);
  }
}

  function loadAll() { loadStarters(); loadCommon(); loadRare(); loadOwned(); }

  /* ---------- USER ACTIONS ---------- */
  window.claimStarter = (id, name) => {
    if (claimedStarters.length >= 3) return showError('Max 3 starters');
    if (claimedStarters.includes(id)) return showError('Already claimed');
    claimedStarters.push(id);
    ownedLocal.push({id, name});
    localStorage.setItem('claimedStarters', JSON.stringify(claimedStarters));
    localStorage.setItem('owned', JSON.stringify(ownedLocal));
    loadAll();
  };

  window.buyCommon = (id, name, price) => {
    if (coins < price) return showError('Not enough coins');
    if (ownedLocal.some(o=>o.id===id)) return showError('Already owned');
    coins -= price;
    ownedLocal.push({id, name});
    updateCoinDisplay();
    localStorage.setItem('owned', JSON.stringify(ownedLocal));
    loadAll();
  };

  window.buyRare = async (id, name, price) => {
    if (!userAddress) return showError('Connect wallet');
    if (ownedLocal.some(o=>o.id===id)) return showError('Already owned');
    try {
      const amount = ethers.utils.parseUnits(price.toString(), 18);
      const bal = await token.balanceOf(userAddress);
      if (bal.lt(amount)) return showError('Not enough TOKEN');

      const allow = await token.allowance(userAddress, NFT_ADDRESS);
      if (allow.lt(amount)) {
        const tx = await token.approve(NFT_ADDRESS, ethers.constants.MaxUint256);
        await tx.wait();
        alert('Approved token spending');
      }

      const tx = await nft.mintWithToken(userAddress, id, name, amount);
      await tx.wait();

      await syncOwnedFromChain();
      await updateTokenBalance();
      alert(`Minted ${name}!`);
    } catch (e) { showError('Mint failed: ' + (e?.error?.message || e?.message || e)); }
  };

  window.promptList = async (id, name) => {
    const price = prompt(`List ${name} for sale ‚Äì price in TOKEN (whole numbers):`);
    if (!price) return;
    const p = parseInt(price);
    if (isNaN(p) || p <= 0) return showError('Invalid price');
    try {
      const tx = await nft.listForSale(id, ethers.utils.parseUnits(p.toString(), 18));
      await tx.wait();
      await syncOwnedFromChain();
      alert(`${name} listed for ${p} TOKEN`);
    } catch (e) { showError('List failed: ' + (e?.error?.message || e?.message || e)); }
  };

  window.cancelListing = async (id) => {
    try {
      const tx = await nft.cancelListing(id);
      await tx.wait();
      await syncOwnedFromChain();
      alert('Listing cancelled');
    } catch (e) { showError('Cancel failed: ' + (e?.error?.message || e?.message || e)); }
  };

  window.buyListed = async (id) => {
    try {
      const listing = await nft.listings(id);
      const price = listing.price;
      if (price.eq(0)) return showError('Not for sale');

      const tx = await nft.buyListed(id);
      await tx.wait();

      await syncOwnedFromChain();
      await updateTokenBalance();
      alert(`Bought Pok√©mon #${id}!`);
    } catch (e) { showError('Buy failed: ' + (e?.error?.message || e?.message || e)); }
  };

  window.sellPokemon = async (id, name) => {
    if (!confirm(`Sell ${name} and get 50% refund?`)) return;
    try {
      const tx = await nft.sellAndRefund(id);
      await tx.wait();
      ownedLocal = ownedLocal.filter(o => o.id !== id);
      localStorage.setItem('owned', JSON.stringify(ownedLocal));
      await syncOwnedFromChain();
      await updateTokenBalance();
      alert(`Sold ${name} ‚Äì 50% refunded`);
    } catch (e) { showError('Sell failed: ' + (e?.error?.message || e?.message || e)); }
  };

  /* ---------- INIT ---------- */
  updateCoinDisplay();
  loadAll();

  // GIF hover
  document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('mouseenter', e => {
      const card = e.target.closest('.card');
      if (!card) return;
      const img = card.querySelector('.pokemon-img');
      if (!img) return;
      const gif = img.dataset.gif;
      if (!img.dataset.preloaded) {
        const pre = new Image(); pre.src = gif; img.dataset.preloaded = 'true';
      }
      if (img.src !== gif) {
        img.style.opacity = 0;
        setTimeout(() => { img.src = gif; img.style.opacity = 1; }, 150);
      }
    }, true);

    document.body.addEventListener('mouseleave', e => {
      const card = e.target.closest('.card');
      if (!card) return;
      const img = card.querySelector('.pokemon-img');
      if (!img || !img.dataset.originalSrc) return;
      const static = img.dataset.originalSrc || img.src;
      if (!img.dataset.originalSrc) img.dataset.originalSrc = static;
      if (img.src !== static) {
        img.style.opacity = 0;
        setTimeout(() => { img.src = static; img.style.opacity = 1; }, 150);
      }
    }, true);
  });
</script>
</body>
</html>